<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doral Video Conference</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=Lato:wght@400;700&display=swap');
        body {
            font-family: 'Lato', sans-serif;
            background-color: #282828;
            color: #ebdbb2;
        }
        .header {
            background-color: #1d2021;
            color: #ebdbb2;
        }
        .container-card {
            background-color: #32302f;
            border-radius: 0.5rem;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .btn-primary {
            @apply px-6 py-3 font-semibold rounded-sm transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
            background-color: #458588;
            color: #ebdbb2;
        }
        .btn-danger {
            @apply px-6 py-3 font-semibold rounded-sm transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
            background-color: #fb4934;
            color: #ebdbb2;
        }
        .btn-toggle {
            @apply px-4 py-2 font-semibold rounded-sm transition duration-300 focus:outline-none;
            background-color: #504945;
            color: #ebdbb2;
        }
        .btn-toggle-active {
            @apply px-4 py-2 font-semibold rounded-sm transition duration-300 focus:outline-none;
            background-color: #b8bb26;
            color: #1d2021;
        }
        .input-field {
            @apply w-full px-4 py-3 rounded-sm border border-gray-600 focus:outline-none focus:ring-2 transition duration-200;
            background-color: #32302f;
            color: #ebdbb2;
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #1d2021;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .video-element {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #localVideo {
            width: 150px;
            height: 112.5px;
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            border-radius: 0.25rem;
            z-index: 10;
            border: 2px solid #ebdbb2;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }
        #remoteVideo {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.3s ease-in-out;
            cursor: grab;
        }
        #remoteVideo.resizable {
            border: 2px dashed #b8bb26;
        }
        #remoteVideo:hover {
            cursor: grab;
        }
        .chat-container {
            background-color: #3c3836;
            border: 1px solid #504945;
            border-radius: 0.5rem;
            height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }
        .message {
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            border-radius: 0.75rem;
            max-width: 85%;
            word-wrap: break-word;
        }
        .my-message {
            background-color: #458588;
            color: #ebdbb2;
            align-self: flex-end;
        }
        .other-message {
            background-color: #665c54;
            color: #ebdbb2;
            align-self: flex-start;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">
    <header class="header w-full py-4 mb-8 flex flex-col sm:flex-row items-center justify-between px-6 shadow-md">
        <div class="flex items-center">
            <img src="https://content.enrollmystudent.org/contact_school_logo/school_logo_1655490559.jpg" alt="School Logo" class="h-12 mr-4">
            <h1 class="text-3xl sm:text-4xl font-semibold font-['Crimson_Pro']">
                Doral Video Conference
            </h1>
        </div>
        <div class="text-sm mt-2 sm:mt-0 font-light" id="auth-status">Authenticating...</div>
    </header>

    <main class="w-full max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Video and Controls -->
        <div class="md:col-span-2 container-card">
            <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Video Feed</h2>
            <div class="video-container mb-4">
                <video id="remoteVideo" class="video-element" autoplay playsinline></video>
                <video id="localVideo" class="video-element" autoplay playsinline muted></video>
            </div>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 items-center justify-center">
                <button id="toggleAudioBtn" class="btn-toggle"><i class="fas fa-microphone"></i> Mute Audio</button>
                <button id="toggleVideoBtn" class="btn-toggle"><i class="fas fa-video"></i> Mute Video</button>
                <button id="hangupBtn" class="btn-danger flex-1" disabled>Hang Up</button>
            </div>
            <div class="flex mt-4 space-x-4 justify-center">
                <button id="startRecordingBtn" class="btn-primary" disabled>Start Recording</button>
                <button id="stopRecordingBtn" class="btn-danger" disabled>Stop Recording</button>
            </div>
            <a id="downloadRecording" style="display: none;"></a>
        </div>

        <!-- Room Management & Chat -->
        <div class="md:col-span-1 space-y-8">
            <div class="container-card">
                <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Room Management</h2>
                <div class="flex flex-col space-y-4">
                    <div class="flex space-x-2">
                        <input type="text" id="roomIdInput" placeholder="Enter Room ID" class="input-field flex-1" />
                        <button id="joinRoomBtn" class="btn-primary">Join</button>
                    </div>
                    <button id="createRoomBtn" class="btn-primary">Create New Room</button>
                </div>
            </div>

            <div class="container-card">
                <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Active Rooms</h2>
                <div id="activeRoomsList" class="space-y-2">
                    <p class="text-gray-500 text-sm">Loading rooms...</p>
                </div>
            </div>

            <div class="container-card">
                <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Chat</h2>
                <div class="chat-container mb-4" id="chatContainer"></div>
                <div class="flex space-x-2">
                    <input type="text" id="chatInput" placeholder="Send a message..." class="input-field flex-1" />
                    <button id="sendChatBtn" class="btn-primary">Send</button>
                </div>
            </div>
        </div>
    </main>
    <div id="status-message" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg text-sm text-center text-gray-700 bg-gray-100 hidden"></div>
    <div id="creator-message" class="fixed top-24 left-1/2 -translate-x-1/2 p-2 rounded-lg text-sm text-center text-ebdbb2 bg-gray-700 hidden">
        You can now click and drag the remote video to move and resize it.
    </div>

    <!-- Font Awesome Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // User's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBluS1Dl9abDJjPPeOhvTCfP8J1kyIh6BQ",
            authDomain: "video-meeting-e73eb.firebaseapp.com",
            projectId: "video-meeting-e73eb",
            storageBucket: "video-meeting-e73eb.firebasestorage.app",
            messagingSenderId: "80496795033",
            appId: "1:80496795033:web:3ac35c631d76301f77c708",
            measurementId: "G-SFPQ0PJRPG"
        };
        
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI Elements
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const roomIdInput = document.getElementById('roomIdInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const toggleAudioBtn = document.getElementById('toggleAudioBtn');
        const toggleVideoBtn = document.getElementById('toggleVideoBtn');
        const startRecordingBtn = document.getElementById('startRecordingBtn');
        const stopRecordingBtn = document.getElementById('stopRecordingBtn');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const chatContainer = document.getElementById('chatContainer');
        const statusMessage = document.getElementById('status-message');
        const authStatus = document.getElementById('auth-status');
        const activeRoomsList = document.getElementById('activeRoomsList');
        const creatorMessage = document.getElementById('creator-message');

        // Firestore and Auth instances
        let app, db, auth;
        let userId;

        // WebRTC variables
        let peerConnection = null;
        let localStream = null;
        let roomRef = null;
        let roomSnapshotListener = null;
        let candidatesListener = null;
        let chatListener = null;
        let roomsListener = null;
        let controlListener = null;
        let isMuted = false;
        let isVideoOff = false;
        let isCreator = false;

        // Recording variables
        let mediaRecorder;
        let recordedChunks = [];

        // Drag and drop variables
        let isDragging = false;
        let isResizing = false;
        let startX, startY, startWidth, startHeight;
        const resizeHandleSize = 15;

        // WebRTC STUN servers
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
            ]
        };

        const showMessage = (msg, isError = false) => {
            statusMessage.textContent = msg;
            statusMessage.style.display = 'block';
            statusMessage.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg text-sm text-center transition-all duration-300 transform animate-fade-in ${isError ? 'text-red-700 bg-red-100' : 'text-gray-700 bg-gray-100'}`;
        };

        const hideMessage = () => {
            statusMessage.style.display = 'none';
        };

        // Initialize Firebase and Auth
        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = `User ID: ${userId}`;
                        createRoomBtn.disabled = false;
                        joinRoomBtn.disabled = false;
                        listenForRooms();
                    } else {
                        authStatus.textContent = 'Authenticating...';
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            showMessage("Authentication failed.", true);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage(`Firebase initialization failed: ${error.message}`, true);
            }
        };

        const getLocalStream = async () => {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                localVideo.muted = true;
                toggleAudioBtn.disabled = false;
                toggleVideoBtn.disabled = false;
                return localStream;
            } catch (error) {
                console.error("Error getting user media:", error);
                if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
                    showMessage("Access to camera/microphone was denied. Please check your browser's settings.", true);
                } else {
                    showMessage("Could not access camera and microphone. Please grant permissions.", true);
                }
                return null;
            } finally {
                if (!localStream) {
                    hideMessage();
                }
            }
        };

        const setupPeerConnection = () => {
            peerConnection = new RTCPeerConnection(configuration);

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidatesCollection = collection(roomRef, 'candidates');
                    addDoc(candidatesCollection, { candidate: JSON.stringify(event.candidate.toJSON()), sender: userId });
                }
            };

            peerConnection.ontrack = (event) => {
                if (event.streams && event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    startRecordingBtn.disabled = false;
                }
            };
        };

        const listenForRooms = () => {
            if (roomsListener) {
                roomsListener();
            }
            const roomsCollectionRef = collection(db, `artifacts/${appId}/public/data/video-rooms`);
            roomsListener = onSnapshot(roomsCollectionRef, (snapshot) => {
                activeRoomsList.innerHTML = '';
                if (snapshot.empty) {
                    activeRoomsList.innerHTML = '<p class="text-gray-500 text-sm">No active rooms.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const roomName = doc.id;
                        const roomDiv = document.createElement('div');
                        roomDiv.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-sm hover:bg-gray-200 transition duration-150';
                        roomDiv.innerHTML = `
                            <span class="text-sm font-semibold">${roomName}</span>
                            <button data-room-id="${roomName}" class="join-room-btn px-3 py-1 text-sm rounded-sm bg-blue-600 text-white hover:bg-blue-700">Join</button>
                        `;
                        activeRoomsList.appendChild(roomDiv);
                    });
                    document.querySelectorAll('.join-room-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            roomIdInput.value = e.target.dataset.roomId;
                            joinRoom();
                        });
                    });
                }
            });
        };

        const createRoom = async () => {
            if (!userId) {
                showMessage("Authentication in progress. Please wait.", true);
                return;
            }

            isCreator = true;
            creatorMessage.style.display = 'block';
            
            const roomName = `room-${Math.random().toString(36).substring(2, 9)}`;
            roomIdInput.value = roomName;
            roomRef = doc(db, `artifacts/${appId}/public/data/video-rooms`, roomName);

            showMessage("Creating room...");

            const stream = await getLocalStream();
            if (!stream) {
                return;
            }

            setupPeerConnection();
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            await setDoc(roomRef, { offer: { sdp: offer.sdp, type: offer.type }, createdBy: userId });
            
            const controlsRef = doc(roomRef, 'video-controls', 'styles');
            const defaultStyles = {
                width: 100,
                height: 100,
                top: 0,
                left: 0,
                units: '%'
            };
            await setDoc(controlsRef, defaultStyles);

            roomSnapshotListener = onSnapshot(roomRef, async (snapshot) => {
                const data = snapshot.data();
                if (data && data.answer && !peerConnection.currentRemoteDescription) {
                    const answer = new RTCSessionDescription(data.answer);
                    await peerConnection.setRemoteDescription(answer);
                }
            });

            candidatesListener = onSnapshot(collection(roomRef, 'candidates'), (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === "added") {
                        const candidate = new RTCIceCandidate(JSON.parse(change.doc.data().candidate));
                        await peerConnection.addIceCandidate(candidate);
                    }
                });
            });

            listenForChat(roomRef);

            setupDragAndDrop();

            showMessage(`Room created! Share this ID with your client: ${roomName}`);
            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            hangupBtn.disabled = false;
            sendChatBtn.disabled = false;
        };

        const joinRoom = async () => {
            if (!userId) {
                showMessage("Authentication in progress. Please wait.", true);
                return;
            }

            const roomId = roomIdInput.value;
            if (!roomId) {
                showMessage("Please enter a Room ID.", true);
                return;
            }

            roomRef = doc(db, `artifacts/${appId}/public/data/video-rooms`, roomId);
            const roomSnapshot = await getDoc(roomRef);

            if (!roomSnapshot.exists()) {
                showMessage("Room does not exist.", true);
                return;
            }

            showMessage(`Joining room: ${roomId}`);

            const stream = await getLocalStream();
            if (!stream) return;

            setupPeerConnection();
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

            const offer = roomSnapshot.data().offer;
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            await updateDoc(roomRef, { answer: { sdp: answer.sdp, type: answer.type } });

            candidatesListener = onSnapshot(collection(roomRef, 'candidates'), (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === "added") {
                        const candidate = new RTCIceCandidate(JSON.parse(change.doc.data().candidate));
                        await peerConnection.addIceCandidate(candidate);
                    }
                });
            });
            
            listenForChat(roomRef);

            const controlsRef = doc(roomRef, 'video-controls', 'styles');
            controlListener = onSnapshot(controlsRef, (snapshot) => {
                const styles = snapshot.data();
                if (styles) {
                    const videoContainer = remoteVideo.parentElement;
                    const containerWidth = videoContainer.offsetWidth;
                    const containerHeight = videoContainer.offsetHeight;

                    remoteVideo.style.width = `${styles.width}%`;
                    remoteVideo.style.height = `${styles.height}%`;
                    remoteVideo.style.top = `${(styles.top / 100) * containerHeight}px`;
                    remoteVideo.style.left = `${(styles.left / 100) * containerWidth}px`;
                }
            });

            showMessage(`Successfully joined room ${roomId}!`);
            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            hangupBtn.disabled = false;
            sendChatBtn.disabled = false;
        };

        const updateRemoteVideoStyle = async (newStyles) => {
            if (!isCreator || !roomRef) return;
            const controlsRef = doc(roomRef, 'video-controls', 'styles');
            await updateDoc(controlsRef, newStyles);
        };

        const setupDragAndDrop = () => {
            if (!isCreator) return;
            
            remoteVideo.classList.add('resizable');

            remoteVideo.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();

                const rect = remoteVideo.getBoundingClientRect();
                const containerRect = remoteVideo.parentElement.getBoundingClientRect();
                const mouseX = e.clientX;
                const mouseY = e.clientY;

                const onRight = mouseX > (rect.right - resizeHandleSize);
                const onBottom = mouseY > (rect.bottom - resizeHandleSize);

                if (onRight || onBottom) {
                    isResizing = true;
                    startX = mouseX;
                    startY = mouseY;
                    startWidth = rect.width;
                    startHeight = rect.height;
                } else {
                    isDragging = true;
                    startX = mouseX - rect.left;
                    startY = mouseY - rect.top;
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging && !isResizing) return;
                
                const videoContainer = remoteVideo.parentElement;
                const containerRect = videoContainer.getBoundingClientRect();
                
                if (isDragging) {
                    let newLeft = e.clientX - startX - containerRect.left;
                    let newTop = e.clientY - startY - containerRect.top;

                    newLeft = Math.max(0, Math.min(newLeft, containerRect.width - remoteVideo.offsetWidth));
                    newTop = Math.max(0, Math.min(newTop, containerRect.height - remoteVideo.offsetHeight));
                    
                    const newLeftPercent = (newLeft / containerRect.width) * 100;
                    const newTopPercent = (newTop / containerRect.height) * 100;

                    updateRemoteVideoStyle({ left: newLeftPercent, top: newTopPercent });

                } else if (isResizing) {
                    const newWidth = startWidth + (e.clientX - startX);
                    const newHeight = startHeight + (e.clientY - startY);

                    const newWidthPercent = (newWidth / containerRect.width) * 100;
                    const newHeightPercent = (newHeight / containerRect.height) * 100;
                    
                    updateRemoteVideoStyle({ width: newWidthPercent, height: newHeightPercent });
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                isResizing = false;
            });
        };

        const hangup = async () => {
            if (peerConnection) {
                peerConnection.close();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            peerConnection = null;
            localStream = null;
            isCreator = false;
            creatorMessage.style.display = 'none';

            if (roomSnapshotListener) roomSnapshotListener();
            if (candidatesListener) candidatesListener();
            if (chatListener) chatListener();
            if (controlListener) controlListener();
            roomSnapshotListener = null;
            candidatesListener = null;
            chatListener = null;
            controlListener = null;

            if (roomRef) {
                try {
                    const messagesCollectionRef = collection(roomRef, 'chat-messages');
                    const messagesSnapshot = await getDocs(messagesCollectionRef);
                    messagesSnapshot.forEach(async (msgDoc) => await deleteDoc(doc(messagesCollectionRef, msgDoc.id)));
                    await deleteDoc(roomRef);
                } catch (error) {
                    console.error("Error deleting room data:", error);
                }
            }

            roomIdInput.value = '';
            hideMessage();
            createRoomBtn.disabled = false;
            joinRoomBtn.disabled = false;
            hangupBtn.disabled = true;
            toggleAudioBtn.disabled = true;
            toggleVideoBtn.disabled = true;
            startRecordingBtn.disabled = true;
            stopRecordingBtn.disabled = true;
            sendChatBtn.disabled = true;
            chatContainer.innerHTML = '';
        };

        const toggleAudio = () => {
            if (localStream) {
                isMuted = !isMuted;
                localStream.getAudioTracks()[0].enabled = !isMuted;
                toggleAudioBtn.textContent = isMuted ? "Unmute Audio" : "Mute Audio";
                toggleAudioBtn.classList.toggle('btn-toggle-active', !isMuted);
            }
        };

        const toggleVideo = () => {
            if (localStream) {
                isVideoOff = !isVideoOff;
                localStream.getVideoTracks()[0].enabled = !isVideoOff;
                toggleVideoBtn.textContent = isVideoOff ? "Turn On Video" : "Turn Off Video";
                toggleVideoBtn.classList.toggle('btn-toggle-active', !isVideoOff);
            }
        };

        const startRecording = () => {
            if (!remoteVideo.srcObject) {
                showMessage("No remote stream to record.", true);
                return;
            }
            recordedChunks = [];
            const stream = remoteVideo.srcObject;
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
            
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    recordedChunks.push(e.data);
                }
            };
            
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.getElementById('downloadRecording');
                a.style.display = 'block';
                a.href = url;
                a.download = `conference-recording-${Date.now()}.webm`;
                a.click();
                URL.revokeObjectURL(url);
                showMessage("Recording downloaded successfully!");
            };
            
            mediaRecorder.start();
            showMessage("Recording started...");
            startRecordingBtn.disabled = true;
            stopRecordingBtn.disabled = false;
        };
        
        const stopRecording = () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                showMessage("Recording stopped. Your download should start shortly.");
            }
        };

        const sendMessage = async () => {
            const message = chatInput.value.trim();
            if (message === "" || !roomRef) return;

            const chatMessagesRef = collection(roomRef, 'chat-messages');
            await addDoc(chatMessagesRef, {
                senderId: userId,
                text: message,
                timestamp: serverTimestamp()
            });
            chatInput.value = '';
        };

        const listenForChat = (roomDocRef) => {
            if (chatListener) chatListener();
            const chatMessagesRef = collection(roomDocRef, 'chat-messages');
            chatListener = onSnapshot(chatMessagesRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const messageData = change.doc.data();
                        displayMessage(messageData);
                    }
                });
            }, (error) => {
                console.error("Error listening to chat messages:", error);
            });
        };

        const displayMessage = (messageData) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${messageData.senderId === userId ? 'my-message' : 'other-message'}`;
            messageDiv.textContent = messageData.text;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        // Event Listeners
        window.onload = () => {
            initFirebase();
        };

        createRoomBtn.addEventListener('click', createRoom);
        joinRoomBtn.addEventListener('click', joinRoom);
        hangupBtn.addEventListener('click', hangup);
        toggleAudioBtn.addEventListener('click', toggleAudio);
        toggleVideoBtn.addEventListener('click', toggleVideo);
        startRecordingBtn.addEventListener('click', startRecording);
        stopRecordingBtn.addEventListener('click', stopRecording);
        sendChatBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

    </script>
</body>
</html>
