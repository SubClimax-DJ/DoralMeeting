<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doral Video Conference</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=Lato:wght@400;700&display=swap');
        body {
            font-family: 'Lato', sans-serif;
            background-color: #282828;
            color: #ebdbb2;
        }
        .header {
            background-color: #1d2021;
            color: #ebdbb2;
        }
        .container-card {
            background-color: #32302f;
            border-radius: 0.5rem;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .btn-primary {
            @apply px-6 py-3 font-semibold rounded-sm transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
            background-color: #458588;
            color: #ebdbb2;
        }
        .btn-danger {
            @apply px-6 py-3 font-semibold rounded-sm transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
            background-color: #fb4934;
            color: #ebdbb2;
        }
        .btn-toggle {
            @apply px-4 py-2 font-semibold rounded-sm transition duration-300 focus:outline-none;
            background-color: #504945;
            color: #ebdbb2;
        }
        .btn-toggle-active {
            @apply px-4 py-2 font-semibold rounded-sm transition duration-300 focus:outline-none;
            background-color: #b8bb26;
            color: #1d2021;
        }
        .input-field {
            @apply w-full px-4 py-3 rounded-sm border border-gray-600 focus:outline-none focus:ring-2 transition duration-200;
            background-color: #32302f;
            color: #ebdbb2;
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #1d2021;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            width: 100%;
            min-height: 400px;
        }
        .video-grid-item {
            position: relative;
            background-color: #1d2021;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .video-grid-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-label {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        .chat-container {
            background-color: #3c3836;
            border: 1px solid #504945;
            border-radius: 0.5rem;
            height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }
        .message {
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            border-radius: 0.75rem;
            max-width: 85%;
            word-wrap: break-word;
        }
        .my-message {
            background-color: #458588;
            color: #ebdbb2;
            align-self: flex-end;
        }
        .other-message {
            background-color: #665c54;
            color: #ebdbb2;
            align-self: flex-start;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">
    <header class="header w-full py-4 mb-8 flex flex-col sm:flex-row items-center justify-between px-6 shadow-md">
        <div class="flex items-center">
            <img src="https://content.enrollmystudent.org/contact_school_logo/school_logo_1655490559.jpg" alt="School Logo" class="h-12 mr-4">
            <h1 class="text-3xl sm:text-4xl font-semibold font-['Crimson_Pro']">
                Doral Video Conference
            </h1>
        </div>
        <div class="text-sm mt-2 sm:mt-0 font-light" id="auth-status">Authenticating...</div>
    </header>

    <main class="w-full max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Initial Username Prompt -->
        <div id="usernamePrompt" class="md:col-span-3 flex flex-col items-center justify-center p-8 bg-[#32302f] rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold font-['Crimson_Pro'] mb-4">Enter Your Username</h2>
            <p class="text-sm text-gray-400 mb-6 text-center">Your username will be visible to other participants in the chat.</p>
            <input type="text" id="usernameInput" placeholder="e.g., JaneDoe" class="input-field max-w-sm mb-4" />
            <button id="submitUsernameBtn" class="btn-primary max-w-xs w-full">Start</button>
        </div>
        
        <!-- Device Selection (hidden initially) -->
        <div id="deviceSelection" class="md:col-span-3 hidden flex flex-col items-center justify-center p-8 bg-[#32302f] rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold font-['Crimson_Pro'] mb-4">Select Devices</h2>
            <div class="w-full max-w-sm space-y-4">
                <div>
                    <label for="cameraSelect" class="block text-sm font-semibold mb-2">Camera</label>
                    <select id="cameraSelect" class="input-field"></select>
                </div>
                <div>
                    <label for="micSelect" class="block text-sm font-semibold mb-2">Microphone</label>
                    <select id="micSelect" class="input-field"></select>
                </div>
            </div>
            <button id="startCallBtn" class="btn-primary max-w-xs w-full mt-6">Continue</button>
        </div>

        <!-- Main App Content (hidden initially) -->
        <div id="mainApp" class="md:col-span-3 hidden grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Room Management & Chat (now on the left) -->
            <div class="md:col-span-1 space-y-8">
                <div class="container-card">
                    <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Room Management</h2>
                    <div class="flex flex-col space-y-4">
                        <div class="flex space-x-2">
                            <input type="text" id="roomIdInput" placeholder="Enter Room ID" class="input-field flex-1" />
                            <button id="joinRoomBtn" class="btn-primary">Join</button>
                        </div>
                        <button id="createRoomBtn" class="btn-primary">Create New Room</button>
                    </div>
                </div>
    
                <div class="container-card">
                    <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Active Rooms</h2>
                    <div id="activeRoomsList" class="space-y-2">
                        <p class="text-gray-500 text-sm">Loading rooms...</p>
                    </div>
                </div>

                <div class="container-card" id="participantsList" style="display: none;">
                    <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Participants</h2>
                    <p class="text-gray-400 text-sm">No other participants.</p>
                </div>
    
                <div class="container-card">
                    <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Chat</h2>
                    <div class="chat-container mb-4" id="chatContainer"></div>
                    <div class="flex space-x-2">
                        <input type="text" id="chatInput" placeholder="Send a message..." class="input-field flex-1" />
                        <button id="sendChatBtn" class="btn-primary">Send</button>
                    </div>
                </div>
            </div>

            <!-- Video and Controls (now on the right) -->
            <div class="md:col-span-2 container-card">
                <h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Video Feeds</h2>
                <div id="videoFeeds" class="video-grid">
                    <!-- Dynamic video elements will be added here -->
                </div>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 items-center justify-center mt-4">
                    <button id="toggleAudioBtn" class="btn-toggle" disabled><i class="fas fa-microphone"></i> Mute Audio</button>
                    <button id="toggleVideoBtn" class="btn-toggle" disabled><i class="fas fa-video"></i> Mute Video</button>
                    <button id="screenShareBtn" class="btn-toggle" disabled><i class="fas fa-desktop"></i> Share Screen</button>
                    <button id="hangupBtn" class="btn-danger flex-1" disabled>Hang Up</button>
                </div>
            </div>
        </div>
    </main>
    <div id="status-message" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg text-sm text-center text-gray-700 bg-gray-100 hidden"></div>

    <!-- Font Awesome Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // User's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBluS1Dl9abDJjPPeOhvTCfP8J1kyIh6BQ",
            authDomain: "video-meeting-e73eb.firebaseapp.com",
            projectId: "video-meeting-e73eb",
            storageBucket: "video-meeting-e73eb.firebasestorage.app",
            messagingSenderId: "80496795033",
            appId: "1:80496795033:web:3ac35c631d76301f77c708",
            measurementId: "G-SFPQ0PJRPG"
        };
        
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI Elements
        const usernamePrompt = document.getElementById('usernamePrompt');
        const mainApp = document.getElementById('mainApp');
        const usernameInput = document.getElementById('usernameInput');
        const submitUsernameBtn = document.getElementById('submitUsernameBtn');
        const deviceSelection = document.getElementById('deviceSelection');
        const cameraSelect = document.getElementById('cameraSelect');
        const micSelect = document.getElementById('micSelect');
        const startCallBtn = document.getElementById('startCallBtn');
        
        const videoFeeds = document.getElementById('videoFeeds');
        const roomIdInput = document.getElementById('roomIdInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const toggleAudioBtn = document.getElementById('toggleAudioBtn');
        const toggleVideoBtn = document.getElementById('toggleVideoBtn');
        const screenShareBtn = document.getElementById('screenShareBtn');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const chatContainer = document.getElementById('chatContainer');
        const statusMessage = document.getElementById('status-message');
        const authStatus = document.getElementById('auth-status');
        const activeRoomsList = document.getElementById('activeRoomsList');
        const participantsList = document.getElementById('participantsList');

        // Firestore and Auth instances
        let app, db, auth;
        let userId;

        // User-specific variables
        let username;
        let isCreator = false;

        // WebRTC variables
        let peerConnections = {}; // Map of userId to RTCPeerConnection
        let localStream = null;
        let screenShareStream = null;
        let roomRef = null;
        let roomSnapshotListener = null;
        let roomsListener = null;
        let participantsListener = null;
        let remoteLayoutListener = null;

        // Recording variables
        let mediaRecorder;
        let recordedChunks = [];

        // WebRTC STUN servers
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
            ]
        };

        const showMessage = (msg, isError = false) => {
            statusMessage.textContent = msg;
            statusMessage.style.display = 'block';
            statusMessage.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg text-sm text-center transition-all duration-300 transform animate-fade-in ${isError ? 'text-red-700 bg-red-100' : 'text-gray-700 bg-gray-100'}`;
        };

        const hideMessage = () => {
            statusMessage.style.display = 'none';
        };

        const updateButtonState = () => {
            if (localStream && localStream.getAudioTracks().length > 0) {
                const audioTrack = localStream.getAudioTracks()[0];
                const isAudioMuted = !audioTrack.enabled;
                if (isAudioMuted) {
                    toggleAudioBtn.textContent = "Unmute Audio";
                    toggleAudioBtn.classList.remove('btn-toggle-active');
                } else {
                    toggleAudioBtn.textContent = "Mute Audio";
                    toggleAudioBtn.classList.add('btn-toggle-active');
                }
            }
            toggleAudioBtn.disabled = !localStream;

            if (localStream && localStream.getVideoTracks().length > 0) {
                const videoTrack = localStream.getVideoTracks()[0];
                const isVideoOff = !videoTrack.enabled;
                if (isVideoOff) {
                    toggleVideoBtn.textContent = "Turn On Video";
                    toggleVideoBtn.classList.remove('btn-toggle-active');
                } else {
                    toggleVideoBtn.textContent = "Mute Video";
                    toggleVideoBtn.classList.add('btn-toggle-active');
                }
            }
            toggleVideoBtn.disabled = !localStream;
            screenShareBtn.disabled = !localStream;
        };

        const getDevices = async () => {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                cameraSelect.innerHTML = '';
                micSelect.innerHTML = '';

                let hasCameras = false;
                let hasMics = false;
                
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `${device.kind === 'videoinput' ? 'Camera' : 'Microphone'} ${device.deviceId.substring(0, 5)}...`;
                    if (device.kind === 'videoinput') {
                        cameraSelect.appendChild(option);
                        hasCameras = true;
                    } else if (device.kind === 'audioinput') {
                        micSelect.appendChild(option);
                        hasMics = true;
                    }
                });

                if (!hasCameras) {
                    cameraSelect.innerHTML = '<option>No cameras found</option>';
                    cameraSelect.disabled = true;
                }
                if (!hasMics) {
                    micSelect.innerHTML = '<option>No microphones found</option>';
                    micSelect.disabled = true;
                }
            } catch (error) {
                console.error("Error getting devices:", error);
                showMessage("Could not access devices. Please check permissions.", true);
            }
        };

        const getLocalStream = async () => {
            try {
                const videoDeviceId = cameraSelect.value;
                const audioDeviceId = micSelect.value;
                const constraints = {
                    video: videoDeviceId ? { deviceId: { exact: videoDeviceId } } : false,
                    audio: audioDeviceId ? { deviceId: { exact: audioDeviceId } } : false
                };
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                return localStream;
            } catch (error) {
                console.error("Error getting user media:", error);
                showMessage("Could not access camera/microphone. Permissions may have been denied.", true);
                return null;
            }
        };

        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = `User ID: ${userId}`;
                        createRoomBtn.disabled = false;
                        joinRoomBtn.disabled = false;
                        listenForRooms();
                    } else {
                        authStatus.textContent = 'Authenticating...';
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            showMessage("Authentication failed.", true);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage(`Firebase initialization failed: ${error.message}`, true);
            }
        };

        const setupPeerConnection = (targetUserId) => {
            const peerConnection = new RTCPeerConnection(configuration);

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    const candidatesCollectionRef = collection(roomRef, `candidates-${targetUserId}`);
                    await addDoc(candidatesCollectionRef, { candidate: JSON.stringify(event.candidate.toJSON()), sender: userId });
                }
            };
            
            peerConnection.ontrack = (event) => {
                const videoElement = document.getElementById(`video-${targetUserId}`);
                if (videoElement) {
                    videoElement.srcObject = event.streams[0];
                }
            };
            
            peerConnections[targetUserId] = peerConnection;
            return peerConnection;
        };
        
        const createVideoElement = (id, label) => {
            const videoContainer = document.createElement('div');
            videoContainer.className = 'video-grid-item';
            videoContainer.id = `video-container-${id}`;
            
            const video = document.createElement('video');
            video.id = `video-${id}`;
            video.autoplay = true;
            video.playsinline = true;
            if (id === userId) {
                video.muted = true;
            }

            const labelDiv = document.createElement('div');
            labelDiv.className = 'video-label';
            labelDiv.textContent = label;

            videoContainer.appendChild(video);
            videoContainer.appendChild(labelDiv);
            videoFeeds.appendChild(videoContainer);
        };

        const listenForRooms = () => {
            if (roomsListener) {
                roomsListener();
            }
            const roomsCollectionRef = collection(db, `artifacts/${appId}/public/data/video-rooms`);
            roomsListener = onSnapshot(roomsCollectionRef, (snapshot) => {
                activeRoomsList.innerHTML = '';
                if (snapshot.empty) {
                    activeRoomsList.innerHTML = '<p class="text-gray-500 text-sm">No active rooms.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const roomData = doc.data();
                        const roomName = doc.id;
                        const roomDiv = document.createElement('div');
                        roomDiv.className = 'flex items-center justify-between p-2 bg-[#3c3836] rounded-sm hover:bg-[#504945] transition duration-150 cursor-pointer';
                        roomDiv.innerHTML = `
                            <div class="flex flex-col">
                                <span class="font-semibold">${roomName}</span>
                                <span class="text-xs text-gray-400">Created by: ${roomData.createdByUsername}</span>
                            </div>
                            <button data-room-id="${roomName}" class="join-room-btn px-3 py-1 text-sm rounded-sm bg-blue-600 text-white hover:bg-blue-700">Join</button>
                        `;
                        activeRoomsList.appendChild(roomDiv);
                    });
                    document.querySelectorAll('.join-room-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            roomIdInput.value = e.target.dataset.roomId;
                            joinRoom();
                        });
                    });
                }
            });
        };

        const createRoom = async () => {
            isCreator = true;
            
            const roomName = `room-${Math.random().toString(36).substring(2, 9)}`;
            roomIdInput.value = roomName;
            roomRef = doc(db, `artifacts/${appId}/public/data/video-rooms`, roomName);

            showMessage("Creating room...");

            createVideoElement(userId, username);
            document.getElementById(`video-${userId}`).srcObject = localStream;
            hangupBtn.disabled = false;

            await setDoc(roomRef, { 
                createdBy: userId, 
                createdByUsername: username,
                participants: { [userId]: username }
            });

            roomSnapshotListener = onSnapshot(roomRef, async (snapshot) => {
                const data = snapshot.data();
                if (!snapshot.exists()) {
                    hangup();
                    showMessage("Room closed by host.", false);
                    return;
                }
                const newParticipants = data.participants;
                for (const participantId in newParticipants) {
                    if (participantId === userId || peerConnections[participantId]) continue;

                    const peerConnection = setupPeerConnection(participantId);
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);

                    const offersRef = collection(roomRef, 'offers');
                    await setDoc(doc(offersRef, participantId), { offer: { sdp: offer.sdp, type: offer.type }, from: userId });
                    
                    createVideoElement(participantId, newParticipants[participantId]);
                    
                    onSnapshot(doc(roomRef, 'answers', participantId), async (snapshot) => {
                         const answerData = snapshot.data();
                         if (answerData && answerData.answer && !peerConnection.currentRemoteDescription) {
                             await peerConnection.setRemoteDescription(new RTCSessionDescription(answerData.answer));
                         }
                    });
                }
                updateParticipantsList(newParticipants);
            });
            
            const offersRef = collection(roomRef, 'offers');
            onSnapshot(offersRef, async (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added' && change.doc.id !== userId) {
                        const offerData = change.doc.data();
                        const peerConnection = setupPeerConnection(offerData.from);
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(offerData.offer));
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        const answersRef = collection(roomRef, 'answers');
                        await setDoc(doc(answersRef, offerData.from), { answer: { sdp: answer.s.dp, type: answer.type }, from: userId });
                    }
                });
            });

            const answersRef = collection(roomRef, 'answers');
            onSnapshot(answersRef, async (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added' && change.doc.id === userId) {
                        const answerData = change.doc.data();
                        const peerConnection = peerConnections[answerData.from];
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answerData.answer));
                    }
                });
            });

            showMessage(`Room created! Share ID: ${roomName}`);
            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            hangupBtn.disabled = false;
            sendChatBtn.disabled = false;
        };

        const joinRoom = async () => {
            const roomId = roomIdInput.value;
            if (!roomId) {
                showMessage("Please enter a Room ID.", true);
                return;
            }

            roomRef = doc(db, `artifacts/${appId}/public/data/video-rooms`, roomId);
            const roomSnapshot = await getDoc(roomRef);

            if (!roomSnapshot.exists()) {
                showMessage("Room does not exist.", true);
                return;
            }
            
            const roomData = roomSnapshot.data();
            const hostId = roomData.createdBy;

            const stream = await getLocalStream();
            if (!stream) return;
            
            createVideoElement(userId, username);
            document.getElementById(`video-${userId}`).srcObject = localStream;
            
            const peerConnection = setupPeerConnection(hostId);
            const offerRef = doc(roomRef, 'offers', userId);
            const answerRef = doc(roomRef, 'answers', userId);
            
            await setDoc(offerRef, { offer: null, from: userId, to: hostId });

            onSnapshot(doc(roomRef, 'answers', userId), async (snapshot) => {
                const answerData = snapshot.data();
                if (answerData && answerData.answer && !peerConnection.currentRemoteDescription) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answerData.answer));
                }
            });

            await updateDoc(roomRef, { [`participants.${userId}`]: username });
            listenForParticipants();
            listenForChat(roomRef);

            showMessage(`Successfully joined room ${roomId}!`);
            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            hangupBtn.disabled = false;
            sendChatBtn.disabled = false;
        };

        const updateParticipantsList = (participants) => {
            participantsList.style.display = 'block';
            participantsList.innerHTML = `<h2 class="text-xl font-bold font-['Crimson_Pro'] mb-4">Participants</h2>`;
            for (const id in participants) {
                const participantDiv = document.createElement('div');
                participantDiv.className = 'flex flex-col items-start p-2 bg-[#3c3836] rounded-sm mb-2';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'font-semibold';
                nameSpan.textContent = `${participants[id]} ${id === userId ? '(You)' : ''}`;

                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex mt-2 space-x-2';

                if (isCreator && id !== userId) {
                    const kickBtn = document.createElement('button');
                    kickBtn.textContent = 'Kick';
                    kickBtn.className = 'px-3 py-1 text-sm rounded-sm bg-red-600 text-white hover:bg-red-700';
                    kickBtn.addEventListener('click', () => kickParticipant(id));
                    buttonContainer.appendChild(kickBtn);

                    const muteBtn = document.createElement('button');
                    muteBtn.textContent = 'Mute';
                    muteBtn.className = 'px-3 py-1 text-sm rounded-sm bg-yellow-600 text-white hover:bg-yellow-700';
                    muteBtn.addEventListener('click', () => muteParticipant(id));
                    buttonContainer.appendChild(muteBtn);
                }
                
                participantDiv.appendChild(nameSpan);
                if (isCreator) participantDiv.appendChild(buttonContainer);
                participantsList.appendChild(participantDiv);
            }
        };

        const kickParticipant = async (participantId) => {
            if (roomRef) {
                const roomDoc = await getDoc(roomRef);
                const participants = roomDoc.data().participants;
                delete participants[participantId];
                await updateDoc(roomRef, { participants });
                showMessage(`${participants[participantId]} has been kicked.`);
            }
        };

        const muteParticipant = async (participantId) => {
            if (roomRef) {
                const muteRef = doc(roomRef, 'mutes', participantId);
                await setDoc(muteRef, { muted: true });
                showMessage(`${participants[participantId]} has been muted.`);
            }
        };

        const hangup = async () => {
            for (const peerId in peerConnections) {
                peerConnections[peerId].close();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (screenShareStream) {
                screenShareStream.getTracks().forEach(track => track.stop());
            }
            videoFeeds.innerHTML = '';
            
            if (roomSnapshotListener) roomSnapshotListener();
            if (roomsListener) roomsListener();
            if (participantsListener) participantsListener();
            roomSnapshotListener = null;
            roomsListener = null;
            participantsListener = null;

            if (roomRef) {
                const userPath = `participants.${userId}`;
                await updateDoc(roomRef, { [userPath]: null });
                const roomDoc = await getDoc(roomRef);
                const participants = roomDoc.data().participants;
                const remainingParticipants = Object.keys(participants).filter(key => participants[key] !== null);
                
                if (remainingParticipants.length === 0) {
                    try {
                        await deleteDoc(roomRef);
                    } catch (error) {
                        console.error("Error deleting empty room data:", error);
                    }
                }
            }
            isCreator = false;
            participantsList.style.display = 'none';

            roomIdInput.value = '';
            hideMessage();
            createRoomBtn.disabled = false;
            joinRoomBtn.disabled = false;
            hangupBtn.disabled = true;
            sendChatBtn.disabled = true;
        };

        const toggleAudio = () => {
            if (localStream && localStream.getAudioTracks().length > 0) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                updateButtonState();
            }
        };

        const toggleVideo = () => {
            if (localStream && localStream.getVideoTracks().length > 0) {
                const videoTrack = localStream.getVideoTracks()[0];
                videoTrack.enabled = !videoTrack.enabled;
                updateButtonState();
            }
        };
        
        const toggleScreenShare = async () => {
            if (screenShareStream) {
                screenShareStream.getTracks().forEach(track => track.stop());
                screenShareStream = null;
                localStream.getVideoTracks()[0].enabled = true; // Re-enable camera
                screenShareBtn.textContent = 'Share Screen';
            } else {
                try {
                    screenShareStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                    localStream.getVideoTracks()[0].enabled = false; // Disable camera
                    screenShareStream.getTracks().forEach(track => {
                        for (const peerId in peerConnections) {
                            const sender = peerConnections[peerId].getSenders().find(s => s.track.kind === 'video');
                            sender.replaceTrack(track);
                        }
                    });
                    screenShareBtn.textContent = 'Stop Sharing';
                } catch (error) {
                    console.error("Screen sharing failed:", error);
                    showMessage("Screen sharing was denied or failed.", true);
                    localStream.getVideoTracks()[0].enabled = true;
                }
            }
        };

        const sendMessage = async () => {
            const message = chatInput.value.trim();
            if (message === "" || !roomRef) return;

            const chatMessagesRef = collection(roomRef, 'chat-messages');
            await addDoc(chatMessagesRef, {
                senderId: userId,
                senderUsername: username,
                text: message,
                timestamp: serverTimestamp()
            });
            chatInput.value = '';
        };

        const listenForChat = (roomDocRef) => {
            const chatMessagesRef = collection(roomDocRef, 'chat-messages');
            onSnapshot(chatMessagesRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const messageData = change.doc.data();
                        displayMessage(messageData);
                    }
                });
            }, (error) => {
                console.error("Error listening to chat messages:", error);
            });
        };

        const displayMessage = (messageData) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${messageData.senderId === userId ? 'my-message' : 'other-message'}`;
            messageDiv.innerHTML = `<span class="font-bold">${messageData.senderUsername}:</span> ${messageData.text}`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const setUsername = () => {
            const user = usernameInput.value.trim();
            if (user) {
                username = user;
                usernamePrompt.style.display = 'none';
                deviceSelection.style.display = 'flex';
                getDevices();
            } else {
                showMessage("Please enter a username.", true);
            }
        };
        
        // Event Listeners
        window.onload = () => {
            initFirebase();
        };

        submitUsernameBtn.addEventListener('click', setUsername);
        usernameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') setUsername();
        });

        startCallBtn.addEventListener('click', async () => {
            deviceSelection.style.display = 'none';
            mainApp.style.display = 'grid';
            localStream = await getLocalStream();
            if (!localStream) {
                deviceSelection.style.display = 'flex';
                mainApp.style.display = 'none';
                return;
            }
            updateButtonState();
        });

        createRoomBtn.addEventListener('click', createRoom);
        joinRoomBtn.addEventListener('click', joinRoom);
        hangupBtn.addEventListener('click', hangup);
        toggleAudioBtn.addEventListener('click', toggleAudio);
        toggleVideoBtn.addEventListener('click', toggleVideo);
        screenShareBtn.addEventListener('click', toggleScreenShare);
        sendChatBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
