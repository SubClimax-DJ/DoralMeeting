<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruvbox Video Conference</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gruvbox-dark-bg': '#282828',
                        'gruvbox-dark-fg': '#ebdbb2',
                        'gruvbox-dark-red': '#cc241d',
                        'gruvbox-dark-navy': '#076678', // Using a dark navy as requested
                        'gruvbox-dark-silver': '#a89984', // Using a dark silver/gray as requested
                        'gruvbox-dark-crimson': '#dc322f', // Using a bright red for crimson
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #282828;
            color: #ebdbb2;
        }
        .container {
            max-width: 960px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .btn {
            @apply px-4 py-2 rounded-lg font-bold transition-transform transform hover:scale-105;
        }
        .btn-primary {
            @apply bg-gruvbox-dark-navy text-gruvbox-dark-fg;
        }
        .btn-secondary {
            @apply bg-gruvbox-dark-red text-gruvbox-dark-fg;
        }
        .input-field {
            @apply bg-gruvbox-dark-bg border border-gruvbox-dark-silver text-gruvbox-dark-fg rounded-lg p-3 w-full focus:outline-none focus:border-gruvbox-dark-navy;
        }
        .card {
            @apply bg-gruvbox-dark-bg border border-gruvbox-dark-silver p-6 rounded-2xl shadow-lg;
        }
        .video-container {
            position: relative;
            background-color: black;
            border-radius: 1rem;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            gap: 1rem; /* Added gap between videos */
            flex-wrap: wrap; /* Added for responsiveness */
        }
        .video-feed {
            width: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
            flex: 1 1 45%; /* Adjusted for a side-by-side layout */
            max-width: 48%; /* Ensure two videos fit */
        }
    </style>
</head>
<body>

<div id="app" class="container p-4">
    <!-- Login Screen -->
    <div id="login-screen" class="card">
        <h1 class="text-3xl font-bold text-center mb-6">Welcome to Gruvbox Video Chat</h1>
        <form id="login-form" class="space-y-4">
            <input id="username-input" type="text" placeholder="Enter your username" class="input-field" required>
            <button type="submit" class="btn btn-primary w-full">Go to Lobby</button>
            <button id="admin-login-btn" type="button" class="btn btn-secondary w-full">Admin Login</button>
        </form>
    </div>

    <!-- Admin Login Screen -->
    <div id="admin-login-screen" class="hidden card">
        <h1 class="text-3xl font-bold text-center mb-6">Admin Login</h1>
        <form id="admin-login-form" class="space-y-4">
            <input id="admin-username-input" type="text" placeholder="Username (e.g., admin)" class="input-field" required>
            <input id="admin-password-input" type="password" placeholder="Password" class="input-field" required>
            <button type="submit" class="btn btn-primary w-full">Login</button>
            <button type="button" id="admin-login-back-btn" class="btn btn-secondary w-full">Back</button>
        </form>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby-screen" class="hidden">
        <div class="card mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h1 class="text-2xl font-bold mb-2 sm:mb-0">Lobby</h1>
                <p class="text-sm text-gruvbox-dark-silver">User ID: <span id="user-id"></span></p>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="create-room-btn" class="btn btn-primary">Create New Room</button>
            </div>
        </div>

        <!-- Rooms List -->
        <div class="card mb-6">
            <h2 class="text-xl font-bold mb-4">Active Rooms</h2>
            <ul id="rooms-list" class="space-y-2">
                <!-- Rooms will be dynamically added here -->
            </ul>
        </div>

        <!-- Chat Box -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4">Chat</h2>
            <div id="chat-messages" class="h-64 overflow-y-auto mb-4 p-2 bg-gruvbox-dark-bg border border-gruvbox-dark-silver rounded-lg">
                <!-- Chat messages will be dynamically added here -->
            </div>
            <form id="chat-form" class="flex gap-2">
                <input id="chat-input" type="text" placeholder="Send a message..." class="input-field flex-grow">
                <button type="submit" class="btn btn-primary">Send</button>
            </form>
        </div>
    </div>

    <!-- Admin Console Screen -->
    <div id="admin-console-screen" class="hidden">
        <div class="card mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h1 class="text-2xl font-bold mb-2 sm:mb-0">Admin Console</h1>
                <button id="admin-logout-btn" class="btn btn-secondary">Logout</button>
            </div>
        </div>

        <!-- Admin Rooms List -->
        <div class="card mb-6">
            <h2 class="text-xl font-bold mb-4">Manage Rooms</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full table-auto">
                    <thead>
                        <tr class="text-left border-b border-gruvbox-dark-silver">
                            <th class="py-2 px-4">Room ID</th>
                            <th class="py-2 px-4">Creator</th>
                            <th class="py-2 px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-rooms-list">
                        <!-- Admin rooms will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Video Room Screen -->
    <div id="video-room-screen" class="hidden">
        <div class="card mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold">Video Room: <span id="room-id"></span></h1>
                <button id="hang-up-btn" class="btn btn-secondary">Hang Up</button>
            </div>
            <div class="video-container relative mb-4">
                <video id="remote-video" autoplay class="video-feed"></video>
                <video id="local-video" autoplay class="video-feed"></video>
            </div>
            <div class="flex justify-center gap-4">
                <button id="toggle-audio-btn" class="btn btn-primary">Toggle Audio</button>
                <button id="toggle-video-btn" class="btn btn-primary">Toggle Video</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase configuration and app ID.
    // These are provided by the canvas environment.
    const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : 'null';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Parse the Firebase config and initialize the app
    const firebaseConfig = firebaseConfigString !== 'null' ? JSON.parse(firebaseConfigString) : {
        apiKey: "AIzaSyBluS1Dl9abDJjPPeOhvTCfP8J1kyIh6BQ",
        authDomain: "video-meeting-e73eb.firebaseapp.com",
        projectId: "video-meeting-e73eb",
        storageBucket: "video-meeting-e73eb.firebasestorage.app",
        messagingSenderId: "80496795033",
        appId: "1:80496795033:web:3ac35c631d76301f77c708",
        measurementId: "G-SFPQ0PJRPG"
    };

    let app;
    let auth;
    let db;
    let userId = null;
    let username = null;
    let isAdmin = false;

    // --- DOM Elements ---
    const loginScreen = document.getElementById('login-screen');
    const adminLoginScreen = document.getElementById('admin-login-screen');
    const lobbyScreen = document.getElementById('lobby-screen');
    const videoRoomScreen = document.getElementById('video-room-screen');
    const adminConsoleScreen = document.getElementById('admin-console-screen');

    const usernameInput = document.getElementById('username-input');
    const loginForm = document.getElementById('login-form');
    const userIdDisplay = document.getElementById('user-id');
    const createRoomBtn = document.getElementById('create-room-btn');
    const roomsList = document.getElementById('rooms-list');
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const roomIdDisplay = document.getElementById('room-id');
    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');
    const hangUpBtn = document.getElementById('hang-up-btn');
    const toggleAudioBtn = document.getElementById('toggle-audio-btn');
    const toggleVideoBtn = document.getElementById('toggle-video-btn');
    const adminLoginBtn = document.getElementById('admin-login-btn');
    const adminLoginForm = document.getElementById('admin-login-form');
    const adminLoginBackBtn = document.getElementById('admin-login-back-btn');
    const adminUsernameInput = document.getElementById('admin-username-input');
    const adminPasswordInput = document.getElementById('admin-password-input');
    const adminLogoutBtn = document.getElementById('admin-logout-btn');
    const adminRoomsList = document.getElementById('admin-rooms-list');

    // --- WebRTC Variables ---
    const servers = {
        iceServers: [
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
        ],
        iceCandidatePoolSize: 10,
    };
    let localStream = null;
    let remoteStream = null;
    let peerConnection = null;
    let currentRoomId = null;

    // --- Firebase Initialization and Auth ---
    function initializeFirebase() {
        if (!app) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase Initialized");

            // Set up auth state listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    console.log("User authenticated:", userId);
                    // Check if the user is an admin based on the username entered
                    isAdmin = (username === 'admin');
                    if (username && !isAdmin) {
                         showLobbyScreen();
                         setupLobbyListeners();
                    } else if (username && isAdmin) {
                        showAdminConsole();
                    }
                } else {
                    userId = null;
                    console.log("No user signed in. Attempting sign-in...");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                    }
                }
            });
        }
    }

    // --- Screen Management ---
    function showScreen(screenId) {
        loginScreen.classList.add('hidden');
        adminLoginScreen.classList.add('hidden');
        lobbyScreen.classList.add('hidden');
        videoRoomScreen.classList.add('hidden');
        adminConsoleScreen.classList.add('hidden');
        document.getElementById(screenId).classList.remove('hidden');
    }

    function showLobbyScreen() {
        showScreen('lobby-screen');
        setupLobbyListeners();
    }

    function showAdminConsole() {
        showScreen('admin-console-screen');
        setupAdminListeners();
    }

    function showVideoRoomScreen(roomId) {
        showScreen('video-room-screen');
        roomIdDisplay.textContent = roomId;
    }

    // --- Login Logic ---
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        username = usernameInput.value;
        if (username.trim() && userId) {
            if (username === 'admin') {
                showCustomMessage("Please use the 'Admin Login' button to log in as an admin.");
                return;
            }
            showLobbyScreen();
        } else {
            console.error("Please enter a username or wait for authentication.");
        }
    });

    // --- Admin Login Logic ---
    adminLoginBtn.addEventListener('click', () => {
        showScreen('admin-login-screen');
    });

    adminLoginBackBtn.addEventListener('click', () => {
        showScreen('login-screen');
    });

    adminLoginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const inputUsername = adminUsernameInput.value.trim();
        const password = adminPasswordInput.value.trim();

        if (inputUsername === "admin" && password === "max") {
             username = 'admin';
             isAdmin = true;
             showAdminConsole();
        } else {
            showCustomMessage("Incorrect username or password. For this demo, please use username 'admin' and password 'max'.");
        }
    });

    adminLogoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            username = null;
            isAdmin = false;
            showScreen('login-screen');
        } catch (error) {
            console.error("Logout failed:", error);
        }
    });

    // --- Lobby Logic ---
    function setupLobbyListeners() {
        const roomsRef = collection(db, `artifacts/${appId}/public/data/rooms`);
        onSnapshot(roomsRef, (snapshot) => {
            roomsList.innerHTML = '';
            if (snapshot.empty) {
                const li = document.createElement('li');
                li.textContent = "No active rooms. Create one to get started!";
                li.classList.add('text-center', 'text-gruvbox-dark-silver', 'italic');
                roomsList.appendChild(li);
                return;
            }
            snapshot.forEach((doc) => {
                const roomData = doc.data();
                const roomName = roomData.creatorUsername;
                const roomId = doc.id;
                const li = document.createElement('li');
                li.classList.add('p-3', 'bg-gruvbox-dark-bg', 'rounded-lg', 'flex', 'justify-between', 'items-center', 'border', 'border-gruvbox-dark-silver');
                li.innerHTML = `
                    <span>Room created by <strong>${roomName}</strong></span>
                    <button class="btn btn-primary join-room-btn" data-room-id="${roomId}">Join</button>
                `;
                roomsList.appendChild(li);
            });
        });

        const chatRef = collection(db, `artifacts/${appId}/public/data/chat_messages`);
        onSnapshot(chatRef, (snapshot) => {
            chatMessages.innerHTML = '';
            snapshot.forEach((doc) => {
                const message = doc.data();
                const messageId = doc.id;
                const p = document.createElement('p');
                p.classList.add('mb-1', 'flex', 'items-center', 'justify-between');
                p.innerHTML = `
                    <span><span class="font-bold text-gruvbox-dark-navy">${message.username}:</span> ${message.text}</span>
                    ${isAdmin ? `<button class="text-gruvbox-dark-red ml-2 delete-chat-btn" data-message-id="${messageId}">x</button>` : ''}
                `;
                chatMessages.appendChild(p);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-chat-btn') && isAdmin) {
                const messageId = e.target.dataset.messageId;
                showCustomModal('Are you sure you want to delete this message?', () => deleteChatMessage(messageId));
            }
        });
    }

    async function deleteChatMessage(messageId) {
        try {
            const chatDocRef = doc(db, `artifacts/${appId}/public/data/chat_messages/${messageId}`);
            await deleteDoc(chatDocRef);
            showCustomMessage('Chat message deleted.');
        } catch (e) {
            console.error("Error deleting chat message:", e);
            showCustomMessage('Error deleting message.');
        }
    }

    // --- Admin Console Logic ---
    function setupAdminListeners() {
        const roomsRef = collection(db, `artifacts/${appId}/public/data/rooms`);
        onSnapshot(roomsRef, (snapshot) => {
            adminRoomsList.innerHTML = '';
            snapshot.forEach((roomDoc) => {
                const roomData = roomDoc.data();
                const roomId = roomDoc.id;
                const creatorUsername = roomData.creatorUsername;

                const tr = document.createElement('tr');
                tr.className = 'border-b border-gruvbox-dark-silver';
                tr.innerHTML = `
                    <td class="py-2 px-4">${roomId}</td>
                    <td class="py-2 px-4">${creatorUsername}</td>
                    <td class="py-2 px-4 flex gap-2">
                        <button class="btn btn-primary view-members-btn" data-room-id="${roomId}">View Members</button>
                        <button class="btn btn-secondary delete-room-btn" data-room-id="${roomId}">Delete Room</button>
                    </td>
                `;
                adminRoomsList.appendChild(tr);
            });
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-room-btn')) {
                const roomId = e.target.dataset.roomId;
                showCustomModal('Are you sure you want to delete this room?', () => deleteRoom(roomId));
            }
            if (e.target.classList.contains('view-members-btn')) {
                const roomId = e.target.dataset.roomId;
                showRoomMembersModal(roomId);
            }
        });
    }

    async function showRoomMembersModal(roomId) {
        const membersRef = collection(db, `artifacts/${appId}/public/data/rooms/${roomId}/members`);
        const membersSnapshot = await getDocs(membersRef);
        const members = membersSnapshot.docs.map(doc => doc.data());

        let membersListHtml = '';
        if (members.length === 0) {
            membersListHtml = '<p>No members in this room.</p>';
        } else {
            membersListHtml = members.map(member => `
                <div class="flex items-center justify-between p-2 my-2 bg-gruvbox-dark-bg border border-gruvbox-dark-silver rounded-lg">
                    <span>User ID: <strong>${member.userId}</strong></span>
                    <button class="btn btn-secondary kick-user-btn" data-room-id="${roomId}" data-member-id="${member.userId}">Kick</button>
                </div>
            `).join('');
        }

        const modalContent = `
            <h2 class="text-xl font-bold mb-4">Members in Room: ${roomId}</h2>
            <div>${membersListHtml}</div>
            <button id="modal-close" class="btn btn-primary mt-4 w-full">Close</button>
        `;

        showCustomModal(modalContent, () => {}, false);

        document.getElementById('modal-close').addEventListener('click', () => {
            const modal = document.querySelector('.fixed.inset-0.flex');
            modal.remove();
        });

        document.querySelectorAll('.kick-user-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const memberId = e.target.dataset.memberId;
                const roomId = e.target.dataset.roomId;
                showCustomModal(`Are you sure you want to kick user ${memberId}?`, () => kickUser(roomId, memberId));
            });
        });
    }

    async function kickUser(roomId, memberId) {
        try {
            const memberDocRef = doc(db, `artifacts/${appId}/public/data/rooms/${roomId}/members/${memberId}`);
            await deleteDoc(memberDocRef);
            showCustomMessage(`User ${memberId} has been kicked from room ${roomId}.`);
        } catch (e) {
            console.error("Error kicking user:", e);
            showCustomMessage("Error kicking user.");
        }
    }

    async function deleteRoom(roomId) {
        try {
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms/${roomId}`);
            const offersRef = collection(roomRef, 'offers');
            const answersRef = collection(roomRef, 'answers');
            const callerCandidatesRef = collection(roomRef, 'iceCandidatesCaller');
            const calleeCandidatesRef = collection(roomRef, 'iceCandidatesCallee');

            // Delete all sub-collections first
            const offersSnapshot = await getDocs(offersRef);
            offersSnapshot.forEach(doc => deleteDoc(doc.ref));
            const answersSnapshot = await getDocs(answersRef);
            answersSnapshot.forEach(doc => deleteDoc(doc.ref));
            const callerCandidatesSnapshot = await getDocs(callerCandidatesRef);
            callerCandidatesSnapshot.forEach(doc => deleteDoc(doc.ref));
            const calleeCandidatesSnapshot = await getDocs(calleeCandidatesRef);
            calleeCandidatesSnapshot.forEach(doc => deleteDoc(doc.ref));

            // Finally, delete the room document itself
            await deleteDoc(roomRef);
            showCustomMessage(`Room ${roomId} has been deleted.`);
        } catch (e) {
            console.error("Error deleting room documents:", e);
            showCustomMessage("Error deleting room.");
        }
    }


    // --- Chat Logic ---
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (text && userId && username) {
            const chatRef = collection(db, `artifacts/${appId}/public/data/chat_messages`);
            await addDoc(chatRef, {
                username: username,
                text: text,
                createdAt: serverTimestamp(),
            });
            chatInput.value = '';
        }
    });

    // --- WebRTC Logic ---

    // Get user media (video and audio)
    async function getUserMedia() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
            localVideo.muted = false;
        } catch (e) {
            console.error("Error getting user media: ", e);
            showCustomMessage("Could not access camera or microphone. Please check your permissions.");
        }
    }

    // Create a new room
    createRoomBtn.addEventListener('click', async () => {
        await getUserMedia();
        if (!localStream) return;

        showVideoRoomScreen('Creating...');
        const roomRef = doc(collection(db, `artifacts/${appId}/public/data/rooms`));
        currentRoomId = roomRef.id;

        console.log('Creating room with ID:', currentRoomId);
        await setDoc(roomRef, {
            creatorId: userId,
            creatorUsername: username,
            createdAt: serverTimestamp(),
            memberCount: 1, // Initialize with one member
        });

        await setDoc(doc(roomRef, `members/${userId}`), { userId: userId, username: username });

        await setupPeerConnection(roomRef);

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        const offerDoc = doc(roomRef, `offers/${userId}`);
        await setDoc(offerDoc, {
            sdp: offer.sdp,
            type: offer.type,
            userId: userId,
        });

        console.log("Offer created and sent to Firebase.");
        showVideoRoomScreen(currentRoomId);

        const answersRef = collection(roomRef, 'answers');
        onSnapshot(answersRef, (snapshot) => {
            snapshot.docChanges().forEach(async (change) => {
                if (change.type === 'added') {
                    const answer = change.doc.data();
                    console.log("Received answer from other user.");
                    if (peerConnection.currentRemoteDescription && peerConnection.currentRemoteDescription.type === 'answer') {
                      return;
                    }
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                }
            });
        });
    });

    // Join an existing room
    document.addEventListener('click', async (e) => {
        if (e.target.classList.contains('join-room-btn')) {
            const roomId = e.target.dataset.roomId;
            currentRoomId = roomId;
            await getUserMedia();
            if (!localStream) return;
            showVideoRoomScreen(roomId);

            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms/${roomId}`);
            await setupPeerConnection(roomRef);
            await setDoc(doc(roomRef, `members/${userId}`), { userId: userId, username: username });

            const offersRef = collection(roomRef, 'offers');
            onSnapshot(offersRef, async (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added') {
                        const offer = change.doc.data();
                        console.log("Received offer from room creator.");
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);

                        const answerDoc = doc(roomRef, `answers/${userId}`);
                        await setDoc(answerDoc, {
                            sdp: answer.sdp,
                            type: answer.type,
                            userId: userId,
                        });
                        console.log("Answer created and sent to Firebase.");
                    }
                });
            });
        }
    });

    async function setupPeerConnection(roomRef) {
        peerConnection = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // Use a more robust way to handle both audio and video tracks
        remoteVideo.srcObject = new MediaStream();

        peerConnection.ontrack = (event) => {
            console.log("Received remote track. Kind:", event.track.kind);
            // Add the new track to the remote video stream
            remoteVideo.srcObject.addTrack(event.track);
        };

        const callerCandidatesRef = collection(roomRef, `iceCandidatesCaller`);
        const calleeCandidatesRef = collection(roomRef, `iceCandidatesCallee`);
        let myCandidatesRef, theirCandidatesRef;

        const offerDoc = await getDoc(doc(roomRef, `offers/${userId}`));
        if (offerDoc.exists()) {
            myCandidatesRef = callerCandidatesRef;
            theirCandidatesRef = calleeCandidatesRef;
        } else {
            myCandidatesRef = calleeCandidatesRef;
            theirCandidatesRef = callerCandidatesRef;
        }

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                console.log("Found an ICE candidate, sending to Firebase.");
                addDoc(myCandidatesRef, event.candidate.toJSON());
            }
        };

        onSnapshot(theirCandidatesRef, (snapshot) => {
            snapshot.docChanges().forEach(async (change) => {
                if (change.type === 'added') {
                    console.log("Received remote ICE candidate.");
                    await peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                }
            });
        });

        peerConnection.onconnectionstatechange = (event) => {
            console.log(`Peer connection state: ${peerConnection.connectionState}`);
            if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed') {
                handleHangUp();
            }
        };
    }

    hangUpBtn.addEventListener('click', () => {
        handleHangUp();
    });

    async function handleHangUp() {
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        if (remoteVideo.srcObject) {
            remoteVideo.srcObject.getTracks().forEach(track => track.stop());
            remoteVideo.srcObject = null;
        }
        localVideo.srcObject = null;
        remoteVideo.srcObject = null;

        if (currentRoomId) {
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms/${currentRoomId}`);
            try {
                await deleteDoc(doc(roomRef, `members/${userId}`));
                const membersSnapshot = await getDocs(collection(roomRef, 'members'));
                if (membersSnapshot.empty) {
                    console.log("Room is now empty, deleting it.");
                    await deleteRoom(currentRoomId);
                } else {
                    console.log(`Room still has ${membersSnapshot.size} members.`);
                }
            } catch (e) {
                console.error("Error handling hang up:", e);
            }
            currentRoomId = null;
        }
        showLobbyScreen();
    }

    toggleAudioBtn.addEventListener('click', () => {
        if (localStream) {
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            toggleAudioBtn.textContent = audioTrack.enabled ? 'Mute Audio' : 'Unmute Audio';
        }
    });

    toggleVideoBtn.addEventListener('click', () => {
        if (localStream) {
            const videoTrack = localStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
            toggleVideoBtn.textContent = videoTrack.enabled ? 'Hide Video' : 'Show Video';
        }
    });

    function showCustomMessage(message) {
        const messageBox = document.createElement('div');
        messageBox.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
        messageBox.innerHTML = `
            <div class="card p-6 w-96 text-center">
                <p class="text-xl mb-4">${message}</p>
                <button onclick="this.parentNode.parentNode.remove()" class="btn btn-primary">OK</button>
            </div>
        `;
        document.body.appendChild(messageBox);
    }

    function showCustomModal(message, onConfirm, showCancel = true) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
      modal.innerHTML = `
        <div class="card p-6 w-96 text-center">
          <p class="text-xl mb-4">${message}</p>
          <div class="flex justify-center gap-4">
            <button class="btn btn-primary" id="modal-confirm">Confirm</button>
            ${showCancel ? `<button class="btn btn-secondary" id="modal-cancel">Cancel</button>` : ''}
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('modal-confirm').addEventListener('click', () => {
        onConfirm();
        modal.remove();
      });
      if (showCancel) {
        document.getElementById('modal-cancel').addEventListener('click', () => {
          modal.remove();
        });
      }
    }

    window.onload = function() {
        initializeFirebase();
    };
</script>

</body>
</html>
