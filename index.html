<!DOCTYPE html>
<html lang="en" class="h-full bg-[#282828]">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Conferencing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Gruvbox dark theme colors */
        :root {
            --dark0_hard: #1d2021;
            --dark0: #282828;
            --dark0_soft: #32302f;
            --dark1: #3c3836;
            --dark2: #504945;
            --dark3: #665c54;
            --dark4: #7c6f64;
            --gray_245: #928374;
            --gray_244: #928374;
            --light0_hard: #f9f5d7;
            --light0: #fbf1c7;
            --light0_soft: #f2e5bc;
            --light1: #ebdbb2;
            --light2: #d5c4a1;
            --light3: #bdae93;
            --light4: #a89984;
            --bright_red: #fb4934;
            --bright_green: #b8bb26;
            --bright_yellow: #fabd2f;
            --bright_blue: #83a598;
            --bright_purple: #d3869b;
            --bright_aqua: #8ec07c;
            --bright_orange: #fe8019;
            --neutral_red: #cc241d;
            --neutral_green: #98971a;
            --neutral_yellow: #d79921;
            --neutral_blue: #458588;
            --neutral_purple: #b16286;
            --neutral_aqua: #689d6a;
            --neutral_orange: #d65d0e;
        }
        .gruvbox-dark { background-color: var(--dark0); color: var(--light1); }
        .gruvbox-input { background-color: var(--dark1); border-color: var(--dark3); color: var(--light0); }
        .gruvbox-input:focus { outline-color: var(--bright_yellow); border-color: var(--bright_yellow); box-shadow: 0 0 0 2px var(--dark0), 0 0 0 4px var(--bright_yellow); }
        .gruvbox-button { background-color: var(--neutral_blue); color: var(--light0); }
        .gruvbox-button:hover { background-color: var(--bright_blue); }
        .gruvbox-button-green { background-color: var(--neutral_green); }
        .gruvbox-button-green:hover { background-color: var(--bright_green); }
        .gruvbox-button-red { background-color: var(--neutral_red); }
        .gruvbox-button-red:hover { background-color: var(--bright_red); }
        .gruvbox-header { color: var(--bright_yellow); }
        .gruvbox-bg-soft { background-color: var(--dark0_soft); }
        .gruvbox-bg-hard { background-color: var(--dark0_hard); }
        .gruvbox-border { border-color: var(--dark2); }
        .gruvbox-text-light { color: var(--light2); }
        .gruvbox-text-bright { color: var(--bright_aqua); }
        .gruvbox-text-faded { color: var(--gray_245); }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-available { background-color: var(--bright_green); }
        .status-in-call { background-color: var(--bright_red); }
        .status-ringing { background-color: var(--bright_orange); }
        .call-control-button { background: var(--dark2); border: none; color: var(--light0); width: 40px; height: 40px; border-radius: 50%; margin: 0 5px; cursor: pointer; }
        .call-control-button:hover { background: var(--dark4); }
        .call-control-button.active { background: var(--neutral_blue); }
    </style>
</head>
<body class="h-full font-sans gruvbox-dark">

    <div id="app" class="h-full flex items-center justify-center">

        <!-- Login Page -->
        <div id="login-page" class="w-full max-w-md p-8 space-y-8 gruvbox-bg-soft rounded-lg shadow-lg">
            <div>
                <img class="mx-auto h-24 w-auto" src="https://content.enrollmystudent.org/contact_school_logo/school_logo_1655490559.jpg" alt="Company Logo">
                <h2 class="mt-6 text-center text-3xl font-extrabold gruvbox-header">Video Conferencing</h2>
            </div>
            <div class="space-y-6">
                <div><input id="username" type="text" required class="relative block w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 gruvbox-input" placeholder="Username"></div>
                <div id="password-container" class="hidden"><input id="password" type="password" class="relative block w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 gruvbox-input" placeholder="Password"></div>
                <div><button id="join-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 gruvbox-button">Join</button></div>
                <p id="error-message" class="text-center text-sm text-red-400"></p>
            </div>
        </div>

        <!-- Waiting Lobby (for regular users) -->
        <div id="lobby-page" class="hidden h-full w-full flex flex-col p-4">
            <header class="flex-shrink-0 flex justify-between items-center p-4 border-b gruvbox-border">
                 <div class="flex items-center">
                    <img class="h-12 w-auto" src="https://content.enrollmystudent.org/contact_school_logo/school_logo_1655490559.jpg" alt="Company Logo">
                    <h1 class="text-xl ml-4 font-bold gruvbox-header">Waiting Lobby</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="gruvbox-text-light">Welcome, <span id="lobby-username" class="font-bold gruvbox-text-bright"></span>!</span>
                    <button id="logout-btn" class="text-xs px-3 py-1.5 rounded gruvbox-button-red text-white">Logout</button>
                </div>
            </header>
            <div class="flex flex-grow min-h-0">
                <div class="w-1/4 flex-shrink-0 p-4 border-r gruvbox-border overflow-y-auto"><h2 class="text-lg font-semibold mb-4 gruvbox-header">Active Users</h2><div id="user-list"></div></div>
                <div class="w-3/4 flex flex-col p-4">
                    <div id="chat-messages" class="flex-grow mb-4 p-4 gruvbox-bg-hard rounded-lg overflow-y-auto"></div>
                    <div class="flex">
                        <input id="chat-input" type="text" class="flex-grow px-3 py-2 rounded-l-md gruvbox-input" placeholder="Type a message...">
                        <button id="send-chat-btn" class="px-4 py-2 rounded-r-md gruvbox-button">Send</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Console -->
        <div id="admin-console-page" class="hidden h-full w-full flex flex-col p-4">
            <header class="flex-shrink-0 flex justify-between items-center p-4 border-b gruvbox-border">
                 <div class="flex items-center">
                    <img class="h-12 w-auto" src="https://content.enrollmystudent.org/contact_school_logo/school_logo_1655490559.jpg" alt="Company Logo">
                    <h1 class="text-xl ml-4 font-bold gruvbox-header">Admin Console</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="gruvbox-text-light">Welcome, <span id="admin-username" class="font-bold text-yellow-400"></span>!</span>
                    <button id="admin-logout-btn" class="text-xs px-3 py-1.5 rounded gruvbox-button-red text-white">Logout</button>
                </div>
            </header>
            <div class="flex flex-grow min-h-0">
                <div class="w-2/5 flex-shrink-0 p-4 border-r gruvbox-border overflow-y-auto"><h2 class="text-lg font-semibold mb-4 gruvbox-header">Users in Lobby</h2><div id="admin-user-list"></div></div>
                <div class="w-3/5 flex flex-col p-4">
                    <div class="flex-grow">
                        <h2 class="text-lg font-semibold mb-4 gruvbox-header">Lobby Chat</h2>
                        <div id="admin-chat-messages" class="h-1/2 mb-4 p-4 gruvbox-bg-hard rounded-lg overflow-y-auto"></div>
                         <div class="flex">
                            <input id="admin-chat-input" type="text" class="flex-grow px-3 py-2 rounded-l-md gruvbox-input" placeholder="Type a message...">
                            <button id="admin-send-chat-btn" class="px-4 py-2 rounded-r-md gruvbox-button">Send</button>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t gruvbox-border">
                         <h2 class="text-lg font-semibold mb-4 gruvbox-header">Broadcast Message</h2>
                         <p class="text-sm gruvbox-text-faded mb-2">Send an alert to all users in the lobby.</p>
                         <div class="flex">
                            <input id="broadcast-input" type="text" class="flex-grow px-3 py-2 rounded-l-md gruvbox-input" placeholder="Your announcement...">
                            <button id="send-broadcast-btn" class="px-4 py-2 rounded-r-md gruvbox-button-green">Broadcast</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Video Call Room -->
        <div id="video-call-page" class="hidden h-full w-full flex">
            <div class="w-3/4 flex flex-col items-center justify-center p-4 relative">
                <div class="relative w-full h-full flex items-center justify-center rounded-lg overflow-hidden gruvbox-bg-hard">
                    <video id="remote-video" autoplay playsinline class="w-full h-full object-cover"></video>
                    <video id="local-video" autoplay playsinline muted class="absolute bottom-4 right-4 w-1/4 h-auto border-2 rounded-md shadow-lg gruvbox-border"></video>
                </div>
                <div class="absolute top-4 left-4"><h2 class="text-2xl font-bold gruvbox-header">In Call With: <span id="call-partner-name"></span></h2></div>
                <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex items-center">
                    <button id="toggle-mic-btn" class="call-control-button active"><i class="fas fa-microphone"></i></button>
                    <button id="toggle-video-btn" class="call-control-button active"><i class="fas fa-video"></i></button>
                    <button id="end-call-btn" class="w-auto py-3 px-6 rounded-md font-bold gruvbox-button-red text-white mx-2">End Call</button>
                </div>
            </div>
            <div class="w-1/4 flex flex-col border-l gruvbox-border">
                <div class="flex-grow flex flex-col p-4">
                    <h3 class="text-xl font-semibold mb-4 text-center gruvbox-header">Chat</h3>
                    <div id="video-chat-messages" class="flex-grow mb-4 p-2 gruvbox-bg-hard rounded-lg overflow-y-auto"></div>
                    <div class="flex">
                        <input id="video-chat-input" type="text" class="flex-grow px-3 py-2 rounded-l-md gruvbox-input" placeholder="Type a message...">
                        <button id="send-video-chat-btn" class="px-4 py-2 rounded-r-md gruvbox-button">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Incoming Call Modal -->
    <div id="incoming-call-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="gruvbox-bg-soft p-8 rounded-lg shadow-xl text-center">
            <h2 class="text-2xl font-bold gruvbox-header mb-4">Incoming Call</h2>
            <p class="text-lg gruvbox-text-light mb-6">You have an incoming call from <span id="incoming-call-from" class="font-bold gruvbox-text-bright"></span>.</p>
            <div class="flex justify-center space-x-4">
                <button id="accept-call-btn" class="px-6 py-2 rounded-md font-semibold text-white gruvbox-button-green">Accept</button>
                <button id="reject-call-btn" class="px-6 py-2 rounded-md font-semibold text-white gruvbox-button-red">Reject</button>
            </div>
        </div>
    </div>

    <!-- Broadcast Alert Modal -->
    <div id="broadcast-alert-modal" class="hidden fixed top-5 right-5 bg-yellow-500 text-gray-900 px-6 py-4 rounded-lg shadow-lg z-50 animate-pulse">
        <strong class="font-bold">Admin Broadcast:</strong>
        <span id="broadcast-message" class="block sm:inline ml-2"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, onValue, onDisconnect, serverTimestamp, remove, push, onChildAdded, query, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbTFLhxzXf08OVDGGsK54t3qDzPVvsJ3w", authDomain: "conferencedoral.firebaseapp.com", projectId: "conferencedoral", storageBucket: "conferencedoral.firebasestorage.app", messagingSenderId: "668062587354", appId: "1:668062587354:web:9b831842ada6ebf87148e3", measurementId: "G-HDJ-S9G2T2", databaseURL: "https://conferencedoral-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // UI Elements
        const loginPage = document.getElementById('login-page'), lobbyPage = document.getElementById('lobby-page'), videoCallPage = document.getElementById('video-call-page'), adminConsolePage = document.getElementById('admin-console-page');
        const usernameInput = document.getElementById('username'), passwordInput = document.getElementById('password'), passwordContainer = document.getElementById('password-container');
        const joinBtn = document.getElementById('join-btn'), errorMessage = document.getElementById('error-message');
        const userListDiv = document.getElementById('user-list'), adminUserListDiv = document.getElementById('admin-user-list');
        const lobbyUsername = document.getElementById('lobby-username'), adminUsername = document.getElementById('admin-username');
        const chatMessagesDiv = document.getElementById('chat-messages'), chatInput = document.getElementById('chat-input'), sendChatBtn = document.getElementById('send-chat-btn');
        const adminChatMessagesDiv = document.getElementById('admin-chat-messages'), adminChatInput = document.getElementById('admin-chat-input'), adminSendChatBtn = document.getElementById('admin-send-chat-btn');
        const callPartnerName = document.getElementById('call-partner-name'), endCallBtn = document.getElementById('end-call-btn');
        const localVideo = document.getElementById('local-video'), remoteVideo = document.getElementById('remote-video');
        const incomingCallModal = document.getElementById('incoming-call-modal'), incomingCallFrom = document.getElementById('incoming-call-from'), acceptCallBtn = document.getElementById('accept-call-btn'), rejectCallBtn = document.getElementById('reject-call-btn');
        const logoutBtn = document.getElementById('logout-btn'), adminLogoutBtn = document.getElementById('admin-logout-btn');
        const toggleMicBtn = document.getElementById('toggle-mic-btn'), toggleVideoBtn = document.getElementById('toggle-video-btn');
        const broadcastInput = document.getElementById('broadcast-input'), sendBroadcastBtn = document.getElementById('send-broadcast-btn');
        const broadcastAlertModal = document.getElementById('broadcast-alert-modal'), broadcastMessage = document.getElementById('broadcast-message');


        let currentUser = null, currentUsername = '', isAdmin = false, localStream, remoteStream, peerConnection, callPartnerUid, callPartnerUsername, callRef, incomingCallListener;

        const configuration = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

        // --- Login ---
        usernameInput.addEventListener('input', () => { passwordContainer.style.display = usernameInput.value.toLowerCase() === 'admin' ? 'block' : 'none'; });
        joinBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim(), password = passwordInput.value;
            errorMessage.textContent = '';
            if (!username) { errorMessage.textContent = 'Please enter a username.'; return; }
            if (username.toLowerCase() === 'admin') {
                if (password !== 'max') { errorMessage.textContent = 'Incorrect password for admin.'; return; }
                isAdmin = true, currentUsername = 'Admin';
            } else { isAdmin = false, currentUsername = username; }
            try {
                const userCredential = await signInAnonymously(auth);
                currentUser = userCredential.user;
                if(isAdmin) showAdminConsole(); else showLobby();
            } catch (error) { console.error("Error signing in:", error); errorMessage.textContent = 'Could not join the lobby.'; }
        });

        // --- Page Navigation ---
        const showPage = (pageToShow) => { [loginPage, lobbyPage, videoCallPage, adminConsolePage].forEach(p => p.classList.add('hidden')); pageToShow.classList.remove('hidden'); };
        function showLobby() { showPage(lobbyPage); lobbyUsername.textContent = currentUsername; setupPresence(); listenForUsers(); listenForLobbyMessages(); listenForIncomingCalls(); listenForBroadcasts(); }
        function showAdminConsole() { showPage(adminConsolePage); adminUsername.textContent = currentUsername; setupPresence(); listenForUsers(); listenForLobbyMessages(); listenForBroadcasts(); }
        function showVideoCallPage(partnerName) { callPartnerName.textContent = partnerName; showPage(videoCallPage); }
        
        function logout() {
            endCall(false); // End call without returning to lobby

            if (currentUser) {
                const myStatusRef = ref(db, 'status/' + currentUser.uid);
                remove(myStatusRef);
            }

            // Reset local state
            currentUser = null;
            currentUsername = '';
            isAdmin = false;
            
            // Unsubscribe listeners
            // ... (add cleanup for onValue listeners if necessary)

            // Reset UI and show login page
            usernameInput.value = '';
            passwordInput.value = '';
            passwordContainer.style.display = 'none';
            errorMessage.textContent = '';
            showPage(loginPage);
        }
        logoutBtn.addEventListener('click', logout);
        adminLogoutBtn.addEventListener('click', logout);

        // --- Presence & User List ---
        function updateUserStatus(callStatus) {
            if (currentUser) {
                const myStatusRef = ref(db, 'status/' + currentUser.uid);
                const statusUpdate = {
                    username: currentUsername,
                    isAdmin: isAdmin,
                    online: true,
                    last_changed: serverTimestamp(),
                    callStatus: callStatus
                };

                // --- NEW DIAGNOSTIC LOGGING ---
                console.log(`%cAttempting to update status for UID: ${currentUser.uid}`, 'color: cyan; font-weight: bold;');
                console.log('%cData being sent:', 'color: cyan;', statusUpdate);
                
                set(myStatusRef, statusUpdate).catch(error => {
                    console.error(`%c!!! FAILED to update status for UID: ${currentUser.uid} !!!`, 'color: red; font-weight: bold;');
                    console.error('Data that was rejected:', statusUpdate);
                    console.error('Firebase Error:', error);
                });
            } else {
                 console.warn('updateUserStatus called but currentUser is null.');
            }
        }
        function setupPresence() { if (!currentUser) return; const myStatusRef = ref(db, 'status/' + currentUser.uid); const status = { username: currentUsername, isAdmin: isAdmin, online: true, last_changed: serverTimestamp(), callStatus: 'available' }; set(myStatusRef, status); onDisconnect(myStatusRef).remove(); }
        
        function listenForUsers() {
            const statusRef = ref(db, 'status');
            onValue(statusRef, (snapshot) => {
                const users = snapshot.val();
                const targetList = isAdmin ? adminUserListDiv : userListDiv;
                targetList.innerHTML = '';
                if (users) {
                    Object.keys(users).forEach(uid => {
                        const user = users[uid];
                        if (user.online && uid !== currentUser.uid) {
                            const userElement = document.createElement('div');
                            userElement.className = `p-2 my-1 rounded-md flex justify-between items-center gruvbox-bg-hard`;
                            
                            let statusIndicator = 'available';
                            let statusText = 'Available';
                            if (user.callStatus === 'in-call') {
                                statusIndicator = 'in-call';
                                statusText = 'In Call';
                            } else if (user.callStatus === 'ringing') {
                                statusIndicator = 'ringing';
                                statusText = 'Ringing';
                            }

                            userElement.innerHTML = `
                                <div class="flex items-center">
                                    <span class="status-dot status-${statusIndicator}"></span>
                                    <div>
                                        <span class="font-medium ${user.isAdmin ? 'text-yellow-400' : 'gruvbox-text-light'}">${user.username}${user.isAdmin ? ' (Admin)' : ''}</span>
                                        <p class="text-xs gruvbox-text-faded">${statusText}</p>
                                    </div>
                                </div>`;
                            
                            if (isAdmin && !user.isAdmin) {
                                const callBtn = document.createElement('button');
                                callBtn.textContent = 'Call';
                                callBtn.className = 'text-xs px-2 py-1 rounded gruvbox-button';
                                if (user.callStatus !== 'available') {
                                    callBtn.disabled = true;
                                    callBtn.style.opacity = '0.5';
                                }
                                callBtn.onclick = () => initiateCall(uid, user.username);
                                userElement.appendChild(callBtn);
                            }
                            targetList.appendChild(userElement);
                        }
                    });
                }
            });
        }
        
        // --- Universal Chat Logic ---
        const sendLobbyMessage = () => { const text = isAdmin ? adminChatInput.value.trim() : chatInput.value.trim(); if (text && currentUser) { push(ref(db, 'lobby-chat'), { uid: currentUser.uid, username: currentUsername, isAdmin, text, timestamp: serverTimestamp() }); if(isAdmin) adminChatInput.value = ''; else chatInput.value = ''; } };
        function listenForLobbyMessages() {
            const messagesQuery = query(ref(db, 'lobby-chat'), limitToLast(100));
            onChildAdded(messagesQuery, (snapshot) => {
                const msg = snapshot.val(), el = document.createElement('div'); el.classList.add('mb-2', 'break-words');
                const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                el.innerHTML = `<div><span class="font-bold ${msg.isAdmin ? 'text-yellow-400' : 'gruvbox-text-bright'}">${msg.username}</span><span class="text-xs ml-2 gruvbox-text-faded">${time}</span></div><p class="gruvbox-text-light">${msg.text}</p>`;
                
                const targetChat = isAdmin ? adminChatMessagesDiv : chatMessagesDiv;
                targetChat.appendChild(el); 
                targetChat.scrollTop = targetChat.scrollHeight;
            });
        }
        sendChatBtn.addEventListener('click', sendLobbyMessage);
        chatInput.addEventListener('keypress', (e) => e.key === 'Enter' && sendLobbyMessage());
        adminSendChatBtn.addEventListener('click', sendLobbyMessage);
        adminChatInput.addEventListener('keypress', (e) => e.key === 'Enter' && sendLobbyMessage());
        
        // --- Admin Broadcast ---
        sendBroadcastBtn.addEventListener('click', () => {
            const message = broadcastInput.value.trim();
            if (message) {
                const broadcastRef = ref(db, 'broadcasts');
                set(broadcastRef, { message, timestamp: serverTimestamp() });
                broadcastInput.value = '';
            }
        });

        function listenForBroadcasts() {
            const broadcastRef = ref(db, 'broadcasts');
            onValue(broadcastRef, (snapshot) => {
                const data = snapshot.val();
                if (data && (Date.now() - data.timestamp < 10000)) { // Only show recent broadcasts
                    if(!isAdmin) {
                        broadcastMessage.textContent = data.message;
                        broadcastAlertModal.classList.remove('hidden');
                        setTimeout(() => broadcastAlertModal.classList.add('hidden'), 5000);
                    }
                }
            });
        }

        // --- WebRTC Call Logic ---
        async function createPeerConnection(partnerUid, isCaller) {
            peerConnection = new RTCPeerConnection(configuration);
            remoteStream = new MediaStream();
            remoteVideo.srcObject = remoteStream;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            } catch (err) {
                console.error("Failed to get local stream", err);
                alert("Could not access camera and microphone. Please allow permissions and try again.");
                endCall();
                return;
            }
            peerConnection.ontrack = event => { event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track)); };
            const localCandidates = ref(db, `calls/${callRef.key}/${isCaller ? 'callerCandidates' : 'calleeCandidates'}`);
            const remoteCandidates = ref(db, `calls/${callRef.key}/${isCaller ? 'calleeCandidates' : 'callerCandidates'}`);
            peerConnection.onicecandidate = event => { event.candidate && push(localCandidates, event.candidate.toJSON()); };
            onChildAdded(remoteCandidates, (snapshot) => { try { peerConnection.addIceCandidate(new RTCIceCandidate(snapshot.val())); } catch(e){ console.error('Error adding received ice candidate', e); } });
            peerConnection.onconnectionstatechange = () => { if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'closed' || peerConnection.connectionState === 'failed') { endCall(); } };
        }

        async function initiateCall(calleeUid, calleeUsername) {
            callRef = push(ref(db, 'calls'));
            callPartnerUid = calleeUid; callPartnerUsername = calleeUsername; 
            updateUserStatus('ringing');
            const calleeStatusRef = ref(db, `status/${calleeUid}`);
            onValue(calleeStatusRef, (snapshot) => {
                if(snapshot.val()?.callStatus !== 'ringing' && peerConnection) endCall();
            }, { onlyOnce: true });

            await createPeerConnection(calleeUid, true);
            showVideoCallPage(calleeUsername);
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            set(callRef, { callerUid: currentUser.uid, callerUsername: currentUsername, calleeUid: calleeUid, status: 'ringing', offer: { sdp: offer.sdp, type: offer.type } });

            onValue(callRef, async (snapshot) => {
                const data = snapshot.val();
                if (data?.answer && peerConnection.signalingState !== 'stable') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    updateUserStatus('in-call');
                }
                if (!data) endCall(); 
            });
        }
        
        async function answerCall(callId, callData) {
            callRef = ref(db, `calls/${callId}`);
            callPartnerUid = callData.callerUid;
            await createPeerConnection(callPartnerUid, false);
            callPartnerUsername = callData.callerUsername;
            await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            await set(callRef, { ...callData, status: 'connected', answer: { sdp: answer.sdp, type: answer.type } });
            showVideoCallPage(callPartnerUsername);
            updateUserStatus('in-call');
            onValue(callRef, (snapshot) => { if (!snapshot.exists()) endCall(); });
        }
        
        const endCall = (returnToLobby = true) => {
            if (peerConnection) { peerConnection.close(); peerConnection = null; }
            if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
            if (callRef) { remove(callRef); callRef = null; }
            localVideo.srcObject = null; remoteVideo.srcObject = null;
            callPartnerUid = null; callPartnerUsername = null;
            updateUserStatus('available');

            if (returnToLobby) {
                if (isAdmin) showAdminConsole(); else showLobby();
            }
        };
        endCallBtn.addEventListener('click', () => endCall());

        function listenForIncomingCalls() {
            if (!currentUser || isAdmin) return;
            const callsQuery = query(ref(db, 'calls'));
            onChildAdded(callsQuery, (snapshot) => {
                const callData = snapshot.val();
                if (callData.calleeUid === currentUser.uid && callData.status === 'ringing') {
                    callPartnerUid = callData.callerUid;
                    incomingCallFrom.textContent = callData.callerUsername;
                    incomingCallModal.classList.remove('hidden');
                    updateUserStatus('ringing');
                    
                    acceptCallBtn.onclick = () => {
                        incomingCallModal.classList.add('hidden');
                        answerCall(snapshot.key, callData);
                    };
                    rejectCallBtn.onclick = () => {
                        incomingCallModal.classList.add('hidden');
                        remove(ref(db, `calls/${snapshot.key}`));
                        updateUserStatus('available');
                    };
                }
            });
        }

        toggleMicBtn.addEventListener('click', () => {
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            toggleMicBtn.classList.toggle('active');
            toggleMicBtn.innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
        });

        toggleVideoBtn.addEventListener('click', () => {
            const videoTrack = localStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
            toggleVideoBtn.classList.toggle('active');
            toggleVideoBtn.innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
        });
        
        window.addEventListener('beforeunload', () => { if (currentUser) { const myStatusRef = ref(db, 'status/' + currentUser.uid); remove(myStatusRef); endCall(false); } });
    </script>
</body>
</html>

