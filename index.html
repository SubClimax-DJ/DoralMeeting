import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, addDoc, getDoc, updateDoc, deleteDoc } from 'firebase/firestore';
import { getDatabase, ref, onValue, set, push, remove, off } from 'firebase/database';

const App = () => {
  // Global Firebase variables provided by the environment
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    apiKey: "AIzaSyBbTFLhxzXf08OVDGGsK54t3qDzPVvsJ3w",
    authDomain: "conferencedoral.firebaseapp.com",
    projectId: "conferencedoral",
    storageBucket: "conferencedoral.firebasestorage.app",
    messagingSenderId: "668062587354",
    appId: "1:668062587354:web:9b831842ada6ebf87148e3",
    measurementId: "G-HDJ9S9G2T2"
  };
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // State management
  const [view, setView] = useState('login'); // login, lobby, call
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [user, setUser] = useState(null);
  const [messages, setMessages] = useState([]);
  const [newMessage, setNewMessage] = useState('');
  const [users, setUsers] = useState([]);
  const [otherUser, setOtherUser] = useState(null);
  const [messageBox, setMessageBox] = useState({ visible: false, text: '' });
  const [isMuted, setIsMuted] = useState(false);
  const [isCameraOff, setIsCameraOff] = useState(false);
  const [isCallInitiator, setIsCallInitiator] = useState(false);

  // Refs for video elements and WebRTC
  const localVideoRef = useRef(null);
  const remoteVideoRef = useRef(null);
  const peerConnectionRef = useRef(null);
  const localStreamRef = useRef(null);
  const dbRef = useRef(null);
  const rtdbRef = useRef(null);

  // Gruvbox color palette for Tailwind CSS
  const colors = {
    'bg-dark': '#282828',
    'bg-light': '#3c3836',
    'fg-dark': '#ebdbb2',
    'red': '#cc241d',
    'green': '#98971a',
    'yellow': '#d79921',
    'blue': '#458588',
    'purple': '#b16286',
    'aqua': '#689d6a',
    'orange': '#d65d0e',
  };

  // Firebase Initialization and Authentication
  useEffect(() => {
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    dbRef.current = db;
    rtdbRef.current = rtdb;

    // Use the provided auth token if available, otherwise sign in anonymously
    const authenticate = async () => {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Firebase auth error:", error);
      }
    };

    onAuthStateChanged(auth, async (currentUser) => {
      if (currentUser) {
        setUser(currentUser);
        setIsAuthReady(true);
        // Set user presence using the currentUser.uid provided by auth
        await setDoc(doc(db, `artifacts/${appId}/public/data/users`, currentUser.uid), {
          uid: currentUser.uid,
          username: `guest-${currentUser.uid.substring(0, 5)}`,
          lastSeen: Date.now(),
        }, { merge: true });
      } else {
        setIsAuthReady(true);
      }
    });

    authenticate();

    // Cleanup on unmount
    return () => {
      if (user && dbRef.current) {
        setDoc(doc(dbRef.current, `artifacts/${appId}/public/data/users`, user.uid), {
          uid: user.uid,
          lastSeen: Date.now(),
          offline: true,
        }, { merge: true });
      }
    };
  }, []);

  // Set up Firestore listeners for lobby
  useEffect(() => {
    if (!isAuthReady || !user || !dbRef.current) return;

    // Listen for messages
    const messagesQuery = query(collection(dbRef.current, `artifacts/${appId}/public/data/messages`), orderBy('timestamp'));
    const unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
      const msgs = snapshot.docs.map(doc => doc.data());
      setMessages(msgs);
    }, (error) => { console.error("Error fetching messages:", error); });

    // Listen for users
    const usersQuery = query(collection(dbRef.current, `artifacts/${appId}/public/data/users`), orderBy('username'));
    const unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
      const currentUsers = snapshot.docs.map(doc => doc.data()).filter(u => !u.offline);
      setUsers(currentUsers);
    }, (error) => { console.error("Error fetching users:", error); });

    return () => {
      unsubscribeMessages();
      unsubscribeUsers();
    };
  }, [isAuthReady, user, appId]);

  // Handle WebRTC signaling
  useEffect(() => {
    if (!isAuthReady || !user || view !== 'call' || !peerConnectionRef.current || !rtdbRef.current) return;

    const callRef = ref(rtdbRef.current, `artifacts/${appId}/calls/${user.uid}`);

    const unsubscribeSignaling = onValue(callRef, async (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      try {
        if (data.offer && !peerConnectionRef.current.currentRemoteDescription) {
          await peerConnectionRef.current.setRemoteDescription(new RTCSessionDescription(data.offer));
          const answer = await peerConnectionRef.current.createAnswer();
          await peerConnectionRef.current.setLocalDescription(answer);
          set(callRef, {
            answer: peerConnectionRef.current.localDescription
          });
          console.log("WebRTC: Answer sent.");
        } else if (data.answer && !isCallInitiator && !peerConnectionRef.current.currentRemoteDescription) {
          await peerConnectionRef.current.setRemoteDescription(new RTCSessionDescription(data.answer));
          console.log("WebRTC: Answer received and set.");
        }
        
        // Handle ICE candidates
        if (data.candidates) {
          const newCandidates = Object.values(data.candidates).filter(c => c.from !== user.uid);
          for (const candidate of newCandidates) {
            await peerConnectionRef.current.addIceCandidate(new RTCIceCandidate(candidate.candidate));
          }
        }

      } catch (error) {
        console.error("WebRTC Signaling Error:", error);
      }
    });

    return () => {
      off(callRef, 'value', unsubscribeSignaling);
      // Clean up the call in Realtime Database when the call ends.
      if (isCallInitiator) {
        remove(callRef);
      }
    };
  }, [view, isAuthReady, user, isCallInitiator, appId]);

  // Utility to show temporary messages
  const showMessageBox = (text) => {
    setMessageBox({ visible: true, text });
    setTimeout(() => {
      setMessageBox({ visible: false, text: '' });
    }, 3000);
  };

  // Login handler
  const handleLogin = async (e) => {
    e.preventDefault();
    if (username.trim() === '') {
      showMessageBox('Username cannot be empty.');
      return;
    }

    if (!user || !dbRef.current) {
      showMessageBox('Application is still initializing. Please wait a moment.');
      return;
    }

    if (username === 'admin' && password !== 'max') {
      showMessageBox('Incorrect password.');
      return;
    }

    // Update user presence with the entered username
    await setDoc(doc(dbRef.current, `artifacts/${appId}/public/data/users`, user.uid), {
      username: username,
      uid: user.uid,
      lastSeen: Date.now(),
      offline: false
    }, { merge: true });

    setView('lobby');
  };

  // Send message to the chat
  const handleSendMessage = async (e) => {
    e.preventDefault();
    if (newMessage.trim() === '' || !dbRef.current) return;

    await addDoc(collection(dbRef.current, `artifacts/${appId}/public/data/messages`), {
      text: newMessage,
      sender: username,
      timestamp: Date.now(),
    });
    setNewMessage('');
  };

  // WebRTC Setup
  const setupWebRTC = async (targetUser) => {
    if (!user || !rtdbRef.current) {
        showMessageBox("Firebase is not ready. Please try again.");
        return null;
    }

    setOtherUser(targetUser);
    setView('call');

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideoRef.current.srcObject = stream;
      localStreamRef.current = stream;

      const servers = {
        iceServers: [
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: 'stun:stun2.l.google.com:19302' },
        ],
        iceCandidatePoolSize: 10,
      };

      const peer = new RTCPeerConnection(servers);
      peerConnectionRef.current = peer;

      stream.getTracks().forEach(track => {
        peer.addTrack(track, stream);
      });

      peer.ontrack = (event) => {
        if (remoteVideoRef.current) {
          remoteVideoRef.current.srcObject = event.streams[0];
        }
      };

      // Collect ICE candidates and send to Realtime Database
      peer.onicecandidate = async (event) => {
        if (event.candidate && rtdbRef.current) {
          const candidateData = {
            candidate: event.candidate.toJSON(),
            from: user.uid
          };
          const callRef = ref(rtdbRef.current, `artifacts/${appId}/calls/${targetUser.uid}/candidates`);
          push(callRef, candidateData);
        }
      };

      return peer;
    } catch (error) {
      console.error("Error setting up WebRTC:", error);
      showMessageBox('Could not access camera/mic. Please check permissions.');
      return null;
    }
  };

  // Initiate a call as the admin
  const handleStartCall = async (targetUser) => {
    setIsCallInitiator(true);
    const peer = await setupWebRTC(targetUser);
    if (!peer) return;

    try {
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);

      const callRef = ref(rtdbRef.current, `artifacts/${appId}/calls/${targetUser.uid}`);
      await set(callRef, {
        offer: {
          sdp: peer.localDescription.sdp,
          type: peer.localDescription.type
        },
        initiator: user.uid,
        target: targetUser.uid
      });
      showMessageBox(`Calling ${targetUser.username}...`);
    } catch (error) {
      console.error("Error creating and sending offer:", error);
      showMessageBox('Failed to initiate call.');
    }
  };

  // End the call and return to lobby
  const handleEndCall = () => {
    if (peerConnectionRef.current) {
      peerConnectionRef.current.close();
      peerConnectionRef.current = null;
    }
    if (localStreamRef.current) {
      localStreamRef.current.getTracks().forEach(track => track.stop());
    }
    setView('lobby');
    setOtherUser(null);
    setIsCallInitiator(false);
  };

  // Toggle microphone
  const toggleMute = () => {
    if (localStreamRef.current) {
      localStreamRef.current.getAudioTracks().forEach(track => {
        track.enabled = !isMuted;
      });
      setIsMuted(!isMuted);
    }
  };

  // Toggle camera
  const toggleCamera = () => {
    if (localStreamRef.current) {
      localStreamRef.current.getVideoTracks().forEach(track => {
        track.enabled = !isCameraOff;
      });
      setIsCameraOff(!isCameraOff);
    }
  };

  const renderView = () => {
    if (messageBox.visible) {
      return (
        <div className={`fixed inset-0 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 z-50`}>
          <div className={`p-4 rounded-xl shadow-lg text-${colors['fg-dark']} bg-${colors['bg-light']}`}>
            {messageBox.text}
          </div>
        </div>
      );
    }

    if (!isAuthReady) {
      return (
        <div className={`flex flex-col items-center justify-center min-h-screen bg-${colors['bg-dark']} text-${colors['fg-dark']}`}>
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div>
          <p className="mt-4">Initializing...</p>
        </div>
      );
    }

    // Login View Component
    const LoginView = () => (
      <div className={`min-h-screen flex items-center justify-center p-4 bg-${colors['bg-dark']}`}>
        <div className="w-full max-w-sm p-8 rounded-xl shadow-2xl bg-[#3c3836] border-2 border-[#458588] transition-all duration-300 transform hover:scale-105">
          <div className="flex justify-center mb-6">
            <img src="https://content.enrollmystudent.org/contact_school_logo/school_logo_1655490559.jpg" alt="Company Logo" className="w-24 h-24 rounded-full shadow-lg border-2 border-[#ebdbb2]" />
          </div>
          <h1 className="text-3xl font-bold text-center mb-6 text-[#d79921]">Join Conference</h1>
          <form onSubmit={handleLogin}>
            <div className="mb-4">
              <label className="block mb-2 font-medium text-[#ebdbb2]" htmlFor="username">Username</label>
              <input
                id="username"
                type="text"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                className="w-full px-4 py-2 rounded-lg bg-[#504945] border border-[#d65d0e] text-[#ebdbb2] focus:outline-none focus:ring-2 focus:ring-[#d79921] transition-all duration-300"
                required
              />
            </div>
            {username === 'admin' && (
              <div className="mb-6">
                <label className="block mb-2 font-medium text-[#ebdbb2]" htmlFor="password">Password</label>
                <input
                  id="password"
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full px-4 py-2 rounded-lg bg-[#504945] border border-[#d65d0e] text-[#ebdbb2] focus:outline-none focus:ring-2 focus:ring-[#d79921] transition-all duration-300"
                  required
                />
              </div>
            )}
            <button
              type="submit"
              className="w-full py-3 px-4 rounded-lg bg-[#98971a] hover:bg-[#689d6a] transition-all duration-300 text-[#282828] font-bold shadow-md transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-[#98971a]"
            >
              Join Lobby
            </button>
          </form>
        </div>
      </div>
    );

    // Lobby View Component
    const LobbyView = () => (
      <div className="min-h-screen flex flex-col md:flex-row p-6 bg-[#282828] text-[#ebdbb2]">
        <div className="flex-1 flex flex-col bg-[#3c3836] p-8 rounded-xl shadow-2xl mb-6 md:mb-0 md:mr-6 border border-[#458588]">
          <h1 className="text-4xl font-extrabold mb-6 text-[#d79921]">Lobby Chat</h1>
          <div className="flex-1 overflow-y-auto space-y-4 pr-2 custom-scrollbar">
            {messages.map((msg, index) => (
              <div key={index} className="p-4 rounded-lg bg-[#504945] text-base shadow-md">
                <span className="font-bold text-[#458588]">{msg.sender}:</span> {msg.text}
              </div>
            ))}
          </div>
          <form onSubmit={handleSendMessage} className="mt-6 flex space-x-3">
            <input
              type="text"
              value={newMessage}
              onChange={(e) => setNewMessage(e.target.value)}
              placeholder="Type a message..."
              className="flex-1 px-4 py-3 rounded-lg bg-[#504945] border border-[#d65d0e] text-[#ebdbb2] focus:outline-none focus:ring-2 focus:ring-[#d79921] transition-all duration-300"
            />
            <button
              type="submit"
              className="py-3 px-6 rounded-lg bg-[#98971a] hover:bg-[#689d6a] transition-all duration-300 text-[#282828] font-bold shadow-md transform hover:scale-105"
            >
              Send
            </button>
          </form>
        </div>
        <div className="md:w-1/4 flex flex-col bg-[#3c3836] p-8 rounded-xl shadow-2xl border border-[#458588]">
          <h2 className="text-3xl font-extrabold mb-6 text-[#d79921]">Active Users</h2>
          <div className="flex-1 flex flex-col space-y-4 overflow-y-auto custom-scrollbar">
            {users.map((u) => (
              <div key={u.uid} className="p-4 rounded-lg flex flex-col bg-[#504945] shadow-md transition-all duration-300 transform hover:scale-105">
                <span className="font-medium text-lg text-[#ebdbb2]">{u.username}</span>
                <span className="text-xs text-gray-400 mt-1 mb-2">ID: {u.uid.substring(0, 8)}...</span>
                {username === 'admin' && u.uid !== user.uid && (
                  <button
                    onClick={() => handleStartCall(u)}
                    className="mt-2 py-2 px-4 rounded-lg bg-[#b16286] hover:bg-[#d65d0e] transition-all duration-300 text-white font-bold shadow-sm"
                  >
                    Call
                  </button>
                )}
              </div>
            ))}
          </div>
        </div>
      </div>
    );

    // Call View Component
    const CallView = () => (
      <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-[#282828] text-[#ebdbb2]">
        <div className="w-full max-w-6xl p-8 rounded-xl shadow-2xl bg-[#3c3836] mb-6 border border-[#458588]">
          <h1 className="text-3xl font-bold text-center mb-6 text-[#d79921]">{otherUser?.username}'s Call</h1>
          <div className="relative w-full aspect-video rounded-xl overflow-hidden shadow-lg border-4 border-[#504945]">
            <video
              ref={remoteVideoRef}
              autoPlay
              playsInline
              className="absolute inset-0 w-full h-full object-cover"
            ></video>
            <video
              ref={localVideoRef}
              autoPlay
              playsInline
              muted
              className="absolute bottom-4 right-4 w-1/4 max-w-[150px] aspect-video rounded-lg border-2 border-[#ebdbb2] shadow-xl"
            ></video>
          </div>
          <div className="flex justify-center space-x-6 mt-8">
            <button
              onClick={toggleMute}
              className={`p-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-110 ${isMuted ? 'bg-[#cc241d]' : 'bg-[#98971a]'} text-white font-bold`}
            >
              <svg className="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                {isMuted ? (
                  <path d="M12 14c2.21 0 4-1.79 4-4V5c0-2.21-1.79-4-4-4S8 2.79 8 5v5c0 2.21 1.79 4 4 4zM17 10h-1a1 1 0 010-2h1c.55 0 1 .45 1 1v2a.5.5 0 00.5.5.5.5 0 00.5-.5V10zM12 21a6.99 6.99 0 006-6h-2c0 2.2-1.8 4-4 4s-4-1.8-4-4H6a6.99 6.99 0 006 6z" />
                ) : (
                  <path d="M12 14c2.21 0 4-1.79 4-4V5c0-2.21-1.79-4-4-4S8 2.79 8 5v5c0 2.21 1.79 4 4 4zm-1 6h2v3h-2v-3zm7-1h-2a.999.999 0 00-.99 1A.999.999 0 0015 20h2v1h-2a.999.999 0 00-.99 1.001A.999.999 0 0015 23h2v1a.999.999 0 001.001-1.001A.999.999 0 0018 22h-1v-1h1.999a1 1 0 001-1v-1a1 1 0 00-1-1zm-10-1H6a.999.999 0 00-1 1v1a1 1 0 001 1h2a1 1 0 001-1v-1a1 1 0 00-1-1z" />
                )}
              </svg>
            </button>
            <button
              onClick={toggleCamera}
              className={`p-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-110 ${isCameraOff ? 'bg-[#cc241d]' : 'bg-[#98971a]'} text-white font-bold`}
            >
              <svg className="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                {isCameraOff ? (
                  <path d="M18.79 17.03c.51-.51.93-1.06 1.25-1.63L22 13v-2l-3.21-1.37c-.32-.57-.74-1.12-1.25-1.63L15 6l-1.37-3.21c-.57-.32-1.12-.74-1.63-1.25L11 0l-2 3.21c-.57.32-1.12.74-1.63 1.25L6 6l-3.21 1.37C2.47 8.35 2.05 8.9 1.73 9.47L0 11v2l3.21 1.37c.32.57.74 1.12 1.25 1.63L6 18l1.37 3.21c.57.32 1.12.74 1.63 1.25L11 24l2-3.21c.57-.32 1.12-.74 1.63-1.25L18 18zM12 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" />
                ) : (
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                )}
              </svg>
            </button>
            <button
              onClick={handleEndCall}
              className="p-4 rounded-full shadow-lg bg-[#cc241d] hover:bg-[#d65d0e] transition-all duration-300 transform hover:scale-110 text-white font-bold"
            >
              <svg className="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                <path d="M22.5 16.5c-.71 0-1.37.15-2 .43-.93-.68-2.02-1.1-3.17-1.26a1.5 1.5 0 00-1.42 1.05l-.5.9c-.38.68-.9 1.16-1.48 1.45-1.05.51-2.18.79-3.32.79-1.14 0-2.27-.28-3.32-.79-.58-.29-1.1-.77-1.48-1.45l-.5-.9a1.5 1.5 0 00-1.42-1.05c-1.15.16-2.24.58-3.17 1.26-.63-.28-1.29-.43-2-.43-.83 0-1.5.67-1.5 1.5v3c0 .83.67 1.5 1.5 1.5h19c.83 0 1.5-.67 1.5-1.5v-3c0-.83-.67-1.5-1.5-1.5z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    );

    switch (view) {
      case 'login':
        return <LoginView />;
      case 'lobby':
        return <LobbyView />;
      case 'call':
        return <CallView />;
    }
  };

  return (
    <div className="font-sans antialiased bg-[#282828]">
      {renderView()}
    </div>
  );
};

export default App;
