<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruvbox Video Conference</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Gruvbox Dark Theme Palette */
        :root {
            --bg: #282828;
            --bg1: #3c3836;
            --fg: #ebdbb2;
            --fg1: #d5c4a1;
            --red: #cc241d;
            --green: #98971a;
            --yellow: #d79921;
            --blue: #458588;
            --purple: #b16286;
            --aqua: #689d6a;
            --orange: #d65d0e;
            --gray: #a89984;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--fg);
        }
        .video-container {
            @apply relative w-full bg-black rounded-lg overflow-hidden shadow-lg;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
        }
        video {
            @apply absolute top-0 left-0 w-full h-full object-cover;
        }
        #localVideo {
            @apply w-32 h-24 md:w-48 md:h-36 absolute bottom-4 right-4 border-2 rounded-md z-10;
            border-color: var(--aqua);
        }
        .btn {
            @apply inline-flex items-center justify-center gap-2 px-5 py-3 font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all transform hover:scale-105 disabled:bg-gray-600 disabled:cursor-not-allowed disabled:transform-none disabled:opacity-50;
        }
        .btn-primary {
            background-color: var(--blue);
            color: var(--bg);
        }
        .btn-primary:hover {
             background-color: var(--aqua);
        }
        .btn-danger {
            background-color: var(--red);
            color: #fff;
        }
         .btn-danger:hover {
            background-color: #fb4934; /* Brighter red */
        }
        .input-field {
            @apply mt-1 block w-full px-4 py-3 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 sm:text-sm;
            background-color: var(--bg1);
            border: 1px solid var(--gray);
            color: var(--fg);
            border-color: var(--gray);
            focus:ring-color: var(--orange);
            focus:border-color: var(--orange);
        }
        .icon {
            width: 1.25em;
            height: 1.25em;
        }
        /* Custom notification for alerts */
        #notification {
            @apply fixed top-5 right-5 p-4 rounded-md shadow-lg text-white text-sm z-50 opacity-0 transition-opacity duration-300;
        }
        #notification.show {
            opacity: 1;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <div class="rounded-xl shadow-2xl p-6" style="background-color: var(--bg1);">
            <h1 class="text-3xl font-bold text-center mb-2 flex items-center justify-center gap-3">
                <svg class="icon" style="color: var(--yellow);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9A2.25 2.25 0 0013.5 5.25h-9A2.25 2.25 0 002.25 7.5v9A2.25 2.25 0 004.5 18.75z" /></svg>
                Gruvbox Video Conference
            </h1>
            <p id="status" class="text-center mb-6" style="color: var(--gray);">Waiting to start camera...</p>

            <div class="video-container bg-black">
                <video id="remoteVideo" autoplay playsinline></video>
                <video id="localVideo" autoplay playsinline muted></video>
            </div>

            <!-- Controls -->
            <div class="mt-6">
                <div id="initialControls" class="text-center">
                    <button id="startCamBtn" class="btn btn-primary w-full sm:w-auto">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9A2.25 2.25 0 0013.5 5.25h-9A2.25 2.25 0 002.25 7.5v9A2.25 2.25 0 004.5 18.75z" /></svg>
                        <span>Step 1: Start Camera</span>
                    </button>
                </div>

                <div id="callControls" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                    <div class="p-4 rounded-lg border" style="background-color: var(--bg); border-color: var(--gray);">
                        <h2 class="text-lg font-semibold mb-3 text-center">Create a New Call</h2>
                        <button id="createCallBtn" class="btn btn-primary w-full">
                           <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>
                            <span>Step 2: Create Call</span>
                        </button>
                        <div class="mt-4 text-center" id="callIdDisplayWrapper" style="display: none;">
                            <p class="text-sm" style="color: var(--gray);">Share this ID to connect:</p>
                            <div class="mt-2 p-2 rounded-md font-mono text-sm break-all" style="background-color: var(--bg); color: var(--yellow);" id="callIdDisplay"></div>
                            <button id="copyBtn" class="mt-2 text-sm hover:underline" style="color: var(--aqua);">Copy ID</button>
                        </div>
                    </div>

                    <div class="p-4 rounded-lg border" style="background-color: var(--bg); border-color: var(--gray);">
                         <h2 class="text-lg font-semibold mb-3 text-center">Join an Existing Call</h2>
                        <input type="text" id="callIdInput" class="input-field w-full" placeholder="Enter Call ID here...">
                        <button id="joinCallBtn" class="btn btn-primary w-full mt-3">
                           <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                           <span>Step 2: Join Call</span>
                        </button>
                    </div>
                </div>
                 <div id="hangupControls" class="hidden text-center mt-6">
                    <button id="hangupBtn" class="btn btn-danger w-full md:w-1/2">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.658-.463 1.243-1.117 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.117 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                        <span>Hang Up</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification Element -->
    <div id="notification"></div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, updateDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";


        // --- User-provided Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBluS1Dl9abDJjPPeOhvTCfP8J1kyIh6BQ",
            authDomain: "video-meeting-e73eb.firebaseapp.com",
            projectId: "video-meeting-e73eb",
            storageBucket: "video-meeting-e73eb.firebasestorage.app",
            messagingSenderId: "80496795033",
            appId: "1:80496795033:web:3ac35c631d76301f77c708",
            measurementId: "G-SFPQ0PJRPG"
        };


        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        signInAnonymously(auth).catch(error => {
            console.error("Anonymous sign-in failed:", error);
            showNotification("Error: Could not connect to authentication service.", true);
        });

        // --- DOM Elements ---
        const startCamBtn = document.getElementById('startCamBtn');
        const createCallBtn = document.getElementById('createCallBtn');
        const joinCallBtn = document.getElementById('joinCallBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const callIdInput = document.getElementById('callIdInput');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const status = document.getElementById('status');
        const initialControls = document.getElementById('initialControls');
        const callControls = document.getElementById('callControls');
        const hangupControls = document.getElementById('hangupControls');
        const callIdDisplay = document.getElementById('callIdDisplay');
        const callIdDisplayWrapper = document.getElementById('callIdDisplayWrapper');
        const copyBtn = document.getElementById('copyBtn');
        const notification = document.getElementById('notification');

        // --- WebRTC Configuration ---
        const servers = {
            iceServers: [{ urls: ['stun:stun.l.google.com:19302', 'stun:stun1.l.google.com:19302'] }],
            iceCandidatePoolSize: 10,
        };

        // --- Global State ---
        let pc = new RTCPeerConnection(servers);
        let localStream = null;
        let remoteStream = null;
        let callId = null;
        let unsubscribe = null;

        // --- UI Helper Functions ---
        function updateStatus(message) {
            status.textContent = message;
        }
        
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.style.backgroundColor = isError ? 'var(--red)' : 'var(--green)';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // --- Core WebRTC and Signaling Logic ---

        startCamBtn.onclick = async () => {
            startCamBtn.disabled = true;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                remoteStream = new MediaStream();

                localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));
                localVideo.srcObject = localStream;
                remoteVideo.srcObject = remoteStream;

                initialControls.classList.add('hidden');
                callControls.classList.remove('hidden');
                updateStatus("Camera active. Ready to create or join a call.");
            } catch (error) {
                console.error("Error accessing media devices.", error);
                showNotification("Error: Could not access camera and microphone.", true);
                startCamBtn.disabled = false;
            }
        };

        createCallBtn.onclick = async () => {
            createCallBtn.disabled = true;
            joinCallBtn.disabled = true;
            updateStatus("Creating call...");

            const callDocRef = doc(collection(db, 'calls'));
            callId = callDocRef.id;

            callIdDisplay.textContent = callId;
            callIdDisplayWrapper.style.display = 'block';

            pc.onicecandidate = event => {
                event.candidate && addDoc(collection(db, `calls/${callId}/offerCandidates`), event.candidate.toJSON());
            };

            const offerDescription = await pc.createOffer();
            await pc.setLocalDescription(offerDescription);

            const offer = { sdp: offerDescription.sdp, type: offerDescription.type };
            await setDoc(callDocRef, { offer });

            updateStatus("Call created. Share the ID.");

            unsubscribe = onSnapshot(doc(db, `calls/${callId}`), (snapshot) => {
                const data = snapshot.data();
                if (!pc.currentRemoteDescription && data?.answer) {
                    const answerDescription = new RTCSessionDescription(data.answer);
                    pc.setRemoteDescription(answerDescription);
                }
            });

            onSnapshot(collection(db, `calls/${callId}/answerCandidates`), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                });
            });
            
            callControls.classList.add('hidden');
            hangupControls.classList.remove('hidden');
        };

        joinCallBtn.onclick = async () => {
            callId = callIdInput.value.trim();
            if (!callId) {
                showNotification("Please enter a valid Call ID.", true);
                return;
            }
            
            createCallBtn.disabled = true;
            joinCallBtn.disabled = true;
            updateStatus("Joining call...");

            const callDocRef = doc(db, `calls/${callId}`);
            const callDocSnap = await getDoc(callDocRef);

            if (!callDocSnap.exists()) {
                showNotification("Invalid Call ID. Please check and try again.", true);
                createCallBtn.disabled = false;
                joinCallBtn.disabled = false;
                updateStatus("Failed to join. Please try again.");
                return;
            }

            pc.onicecandidate = event => {
                event.candidate && addDoc(collection(db, `calls/${callId}/answerCandidates`), event.candidate.toJSON());
            };

            await pc.setRemoteDescription(new RTCSessionDescription(callDocSnap.data().offer));

            const answerDescription = await pc.createAnswer();
            await pc.setLocalDescription(answerDescription);

            const answer = { type: answerDescription.type, sdp: answerDescription.sdp };
            await updateDoc(callDocRef, { answer });

            onSnapshot(collection(db, `calls/${callId}/offerCandidates`), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                });
            });

            callControls.classList.add('hidden');
            hangupControls.classList.remove('hidden');
        };
        
        hangupBtn.onclick = async () => {
             if (unsubscribe) unsubscribe();

            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (pc) pc.close();
            
            // A more robust cleanup
            if (callId) {
                const callDocRef = doc(db, 'calls', callId);
                // Delete candidate subcollections
                const offerCandidatesQuery = query(collection(callDocRef, 'offerCandidates'));
                const answerCandidatesQuery = query(collection(callDocRef, 'answerCandidates'));
                const [offerCandidatesSnap, answerCandidatesSnap] = await Promise.all([
                    getDocs(offerCandidatesQuery),
                    getDocs(answerCandidatesQuery)
                ]);
                
                const deletePromises = [];
                offerCandidatesSnap.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                answerCandidatesSnap.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                
                await Promise.all(deletePromises);
                await deleteDoc(callDocRef);
            }

            window.location.reload();
        };

        pc.ontrack = (event) => {
            event.streams[0].getTracks().forEach((track) => remoteStream.addTrack(track));
            updateStatus("Connected!");
        };

        copyBtn.onclick = () => {
            navigator.clipboard.writeText(callId).then(() => {
                showNotification("Call ID copied to clipboard!");
                copyBtn.textContent = "Copied!";
                setTimeout(() => { copyBtn.textContent = "Copy ID"; }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showNotification("Failed to copy ID.", true);
            });
        };
    </script>
</body>
</html>

