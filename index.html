<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Add</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;7.00&display=swap" rel="stylesheet">

    <style>
        /* Gruvbox Dark Colors (Same as Admin) */
        :root {
            --bg: #282828;
            --bg-dark: #1d2021;
            --bg-light: #3c3836;
            --bg-med: #504945;
            --fg: #ebdbb2;
            --fg-gray: #a89984;
            --red: #fb4934;
            --green: #b8bb26;
            --yellow: #fabd2f;
            --blue: #83a598;
            --purple: #d3869b;
            --aqua: #8ec07c;
            --orange: #fe8019;
            --border-color: #504945;
        }

        /* Base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--fg);
            margin: 0;
            padding: 0;
            /* Space for sticky footer */
            padding-bottom: 80px;
        }
        
        /* Header */
        header {
            background-color: var(--bg-dark);
            color: var(--fg);
            padding: 1rem;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            font-size: 1.25rem;
            color: var(--fg);
            margin: 0;
        }

        #auth-status {
            font-size: 0.9rem;
            color: var(--fg-gray);
        }
        .connected { color: var(--green) !important; }
        .disconnected { color: var(--red) !important; }

        /* Main Content */
        main {
            padding: 1rem;
        }

        .section {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--aqua);
            margin-top: 0;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        h3 {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--blue);
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        
        /* Forms */
        input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--bg-med);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--fg);
            font-size: 1.1rem; /* Larger for mobile */
            box-sizing: border-box; 
            margin-bottom: 0.5rem;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: var(--blue);
        }
        .btn {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: opacity 0.2s;
            width: 100%; /* Full width for mobile */
            box-sizing: border-box;
            margin-top: 0.5rem;
        }
        .btn:hover { opacity: 0.8; }
        .btn-blue { background-color: var(--blue); color: var(--bg-dark); }
        .btn-green { background-color: var(--green); color: var(--bg-dark); }
        .btn-gray { background-color: var(--bg-med); color: var(--fg); }
        .btn-purple { background-color: var(--purple); color: var(--bg-dark); }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
        }
        .btn-group .btn {
            width: 100%;
            margin-top: 0;
        }

        /* Search Results */
        #search-results, #sibling-group-list {
            background-color: var(--bg-med);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            max-height: 250px; /* Taller for mobile */
            overflow-y: auto;
            padding: 0.25rem;
        }
        #sibling-group-list { min-height: 50px; }

        .search-item, .sibling-item {
            display: flex;
            flex-direction: column; /* Stack info and actions */
            align-items: flex-start;
            padding: 0.75rem;
            border-radius: 4px;
        }
        .search-item:hover { background-color: var(--bg-light); }
        .search-item.group-result {
            background-color: var(--bg-dark);
            border-left: 3px solid var(--green);
        }
        .search-item-info {
            font-weight: 500;
            margin-bottom: 0.75rem;
        }
        .search-item-actions {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2x2 grid for actions */
            gap: 0.5rem;
            width: 100%;
        }
        /* Full width for permanent group add */
        .search-item.group-result .search-item-actions {
            grid-template-columns: 1fr;
        }
        .search-item-actions .btn {
            padding: 0.6rem;
            font-size: 0.9rem;
            width: 100%;
            margin: 0;
        }

        .sibling-item {
            background-color: var(--bg-dark);
            margin: 0.25rem;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }

        /* Lightweight Queue View */
        .queue-list-container {
            background-color: var(--bg-med);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            min-height: 50px;
        }
        .queue-item {
            background-color: var(--bg-light);
            color: var(--fg);
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            font-weight: 500;
            /* UPDATED: Changed to a flex row layout */
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }
        .queue-item.group-header {
            background-color: var(--bg-dark);
            color: var(--green);
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .queue-item.group-student {
            padding-left: 1.5rem;
            font-weight: 400;
        }

        /* Sticky Footer Navigation */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-dark);
            border-top: 1px solid var(--border-color);
            display: flex;
            z-index: 10;
        }
        .nav-btn {
            flex: 1;
            background-color: transparent;
            border: none;
            color: var(--fg-gray);
            font-size: 1rem;
            font-weight: 600;
            padding: 1.25rem 1rem;
            border-bottom: 3px solid transparent;
        }
        .nav-btn.active {
            color: var(--fg);
            border-bottom-color: var(--blue);
        }

        /* Action buttons for queue list */
        .queue-item-actions {
            display: flex;
            gap: 0.5rem;
            /* REMOVED: margin-top: 0.5rem; */
            flex-shrink: 0; /* Added to prevent buttons from shrinking/wrapping */
        }
        .queue-item-actions .btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            width: auto; /* Not full width */
            /* REMOVED: flex-grow: 1; */
            margin-top: 0; /* Override base .btn margin */
        }
        .btn-red-outline {
            background-color: transparent;
            border: 1px solid var(--red);
            color: var(--red);
        }
        .btn-blue-outline {
            background-color: transparent;
            border: 1px solid var(--blue);
            color: var(--blue);
        }

        /* Lightweight confirmation modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 20;
            display: none; /* hidden */
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-box {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 400px;
        }
        .modal-box h3 {
            color: var(--fg);
            margin-top: 0;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .modal-actions .btn {
            width: auto; /* Don't stretch */
        }

    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <h1>Mobile Carline</h1>
        <div id="auth-status">Connecting...</div>
    </header>

    <!-- MAIN CONTENT -->
    <main>
    
        <!-- 1. ADD STUDENT VIEW (Default) -->
        <div id="add-view">
            <!-- Find Student -->
            <section class="section">
                <h2>Find Student</h2>
                <input type="text" id="search-input" placeholder="Type a student's name...">
                <div id="search-results">
                    <p style="padding: 0.5rem 0.75rem; color: var(--fg-gray);">Start typing to see results...</p>
                </div>
            </section>
            
            <!-- Ad-hoc Group Add -->
            <section class="section">
                <h2>Ad-Hoc Group Add</h2>
                <p style="font-size: 0.9rem; color: var(--fg-gray); margin-top: 0; margin-bottom: 0.5rem;">Click "Group" in search to build a group below.</p>
                <div id="sibling-group-list">
                    <p style="padding: 0.5rem 0.75rem; color: var(--fg-gray);">No students staged.</p>
                </div>
                <button id="add-staged-group-btn" class="btn btn-green">
                    Add Group to Sibling Queue
                </button>
            </section>
            
            <!-- Manual Add -->
            <section class="section">
                <h2>Manual Add (Visitor)</h2>
                <input type="text" id="manual-name-input" placeholder="e.g., 'Visitor', 'Aunt Mary'">
                <div class="btn-group">
                    <button id="manual-add-btn" class="btn btn-blue" data-queue="1">Pre-K-5</button>
                    <button id="manual-add-btn-sib" class="btn btn-green" data-queue="2">6th-8th</button>
                    <button id="manual-add-btn-walk" class="btn btn-gray" data-queue="3">Walk</button>
                </div>
            </section>
        </div>

        <!-- 2. VIEW QUEUES (Hidden by default) -->
        <div id="queues-view" style="display: none;">
            <section class="section">
                <h3 style="color: var(--blue);">Pre-K thru Grade 5 <span id="q1-count">(0)</span></h3>
                <div id="q1-list" class="queue-list-container">
                    <p style="color: var(--fg-gray);">Loading...</p>
                </div>
            </section>
            
            <section class="section">
                <h3 style="color: var(--green);">Siblings & 6th - 8th <span id="q2-count">(0)</span></h3>
                <div id="q2-list" class="queue-list-container">
                    <p style="color: var(--fg-gray);">Loading...</p>
                </div>
            </section>
            
            <section class="section">
                <h3 style="color: var(--fg-gray);">Walkers <span id="q3-count">(0)</span></h3>
                <div id="q3-list" class="queue-list-container">
                    <p style="color: var(--fg-gray);">Loading...</p>
                </div>
            </section>
        </div>
    
    </main>

    <!-- STICKY FOOTER NAVIGATION -->
    <footer>
        <button id="nav-add-btn" class="nav-btn active">Add Student</button>
        <button id="nav-queues-btn" class="nav-btn">View Queues</button>
    </footer>

    <!-- CONFIRMATION MODAL -->
    <div id="confirmation-modal-backdrop" class="modal-backdrop">
        <div id="confirmation-modal-box" class="modal-box">
            <h3 id="confirmation-modal-title">Confirm Action</h3>
            <p id="confirmation-modal-prompt" style="color: var(--fg-gray); margin-bottom: 1rem;">Are you sure?</p>
            
            <div class="modal-actions">
                <button id="confirmation-modal-cancel-btn" class="btn btn-gray">
                    Cancel
                </button>
                <button id="confirmation-modal-confirm-btn" class="btn btn-red">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc,
            updateDoc,
            deleteDoc, /* FIXED: Added missing import */
            addDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config (IDENTICAL to index.html) ---
        const firebaseConfig = {
          apiKey: "AIzaSyBbTFLhxzXf08OVDGGsK54t3qDzPVvsJ3w",
          authDomain: "conferencedoral.firebaseapp.com",
          databaseURL: "https://conferencedoral-default-rtdb.firebaseio.com",
          projectId: "conferencedoral",
          storageBucket: "conferencedoral.firebasestorage.app",
          messagingSenderId: "668062587354",
          appId: "1:668062587354:web:9b831842ada6ebf87148e3",
          measurementId: "G-HDJ9S9G2T2"
        };
        
        // --- DOM Elements ---
        const authStatus = document.getElementById('auth-status');
        
        // View Toggling
        const addView = document.getElementById('add-view');
        const queuesView = document.getElementById('queues-view');
        const navAddBtn = document.getElementById('nav-add-btn');
        const navQueuesBtn = document.getElementById('nav-queues-btn');

        // Add Student Section
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const manualNameInput = document.getElementById('manual-name-input');
        const manualAddBtn = document.getElementById('manual-add-btn');
        const manualAddBtnSib = document.getElementById('manual-add-btn-sib');
        const manualAddBtnWalk = document.getElementById('manual-add-btn-walk');
        const stagedList = document.getElementById('sibling-group-list');
        const addStagedGroupBtn = document.getElementById('add-staged-group-btn');

        // Queues
        const q1List = document.getElementById('q1-list');
        const q2List = document.getElementById('q2-list');
        const q3List = document.getElementById('q3-list');
        const q1Count = document.getElementById('q1-count');
        const q2Count = document.getElementById('q2-count');
        const q3Count = document.getElementById('q3-count');

        // Confirmation Modal
        const confirmationModalBackdrop = document.getElementById('confirmation-modal-backdrop');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalPrompt = document.getElementById('confirmation-modal-prompt');
        const confirmationModalCancelBtn = document.getElementById('confirmation-modal-cancel-btn');
        const confirmationModalConfirmBtn = document.getElementById('confirmation-modal-confirm-btn');

        // --- App State ---
        let stagedSiblingGroup = []; 
        let currentRoster = []; 
        let currentPermanentGroups = [];
        let confirmationModalAction = null;
        
        // --- Firebase Globals ---
        let app, auth, db, userId;
        let q1ColRef, q2ColRef, q3ColRef, rosterColRef, permanentGroupsColRef, pickedupColRef;
        const appId = firebaseConfig.projectId || 'default-carline-app';

        // --- Collection Names ---
        const Q1_COLLECTION = 'queue_k5';
        const Q2_COLLECTION = 'queue_siblings';
        const Q3_COLLECTION = 'queue_walkers';
        const ROSTER_COLLECTION = 'ROSTER';
        const PERMANENT_GROUPS_COLLECTION = 'permanent_groups';
        const PICKEDUP_COLLECTION = 'queue_pickedup';

        // --- Utility Functions ---
        function sanitize(str) {
            if (!str) return "";
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        // --- Render Functions (Mobile) ---

        function renderSearchResults_Mobile(students, groups) {
            let html = '';

            // Render groups first
            if (groups.length > 0) {
                html += groups.map(group => {
                    return `
                    <div class="search-item group-result">
                        <div class="search-item-info">
                            <span style="font-weight: 500;">${sanitize(group.groupName)}</span>
                            <span style="color: var(--fg-gray); font-size: 0.8rem; margin-left: 4px;">(Permanent Group)</span>
                        </div>
                        <div class="search-item-actions">
                            <button class="btn btn-green" data-action="add-permanent-group" data-group-id="${group.id}">Add to Sibling Queue</button>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            // Render individual students
            if (students.length > 0) {
                html += students.map(student => {
                    const fullName = `${student.firstName} ${student.lastName}`;
                    return `
                    <div class="search-item">
                        <div class="search-item-info">
                            <span style="font-weight: 500;">${fullName}</span>
                            <span style="color: var(--fg-gray); font-size: 0.8rem; margin-left: 4px;">(Gr: ${student.grade})</span>
                        </div>
                        <div class="search-item-actions">
                            <button class="btn btn-blue" data-queue="1" data-name="${fullName}" data-grade="${student.grade}">K-5</button>
                            <button class="btn btn-green" data-queue="2" data-name="${fullName}" data-grade="${student.grade}">6-8</button>
                            <button class="btn btn-gray" data-queue="3" data-name="${fullName}" data-grade="${student.grade}">Walk</button>
                            <button class="btn btn-purple" data-action="stage-group" data-name="${fullName}" data-grade="${student.grade}">Group</button>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            if (html === '') {
                searchResults.innerHTML = `<p style="padding: 0.5rem 0.75rem; color: var(--fg-gray);">No students or groups found.</p>`;
                return;
            }
            
            searchResults.innerHTML = html;
        }

        function renderStagedGroup_Mobile() {
            if (stagedSiblingGroup.length === 0) {
                stagedList.innerHTML = `<p style="padding: 0.5rem 0.75rem; color: var(--fg-gray);">No students staged.</p>`;
                return;
            }
            stagedList.innerHTML = stagedSiblingGroup.map((student, index) => {
                return `
                <div class="sibling-item">
                    <span style="font-weight: 500;">${student.name} (Gr: ${student.grade})</span>
                    <button class="remove-staged-btn" data-index="${index}" title="Remove" style="background: none; border: none; color: var(--red); cursor: pointer;">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                `;
            }).join('');
        }

        /**
         * Renders a simple list for a queue
         */
        function renderQueueList_Mobile(listEl, countEl, docs) {
            docs.sort((a, b) => (a.addedAt?.seconds || 0) - (b.addedAt?.seconds || 0));
            countEl.textContent = `(${docs.length})`;
            
            if (docs.length === 0) {
                listEl.innerHTML = `<p style="padding: 0.5rem 0.75rem; color: var(--fg-gray);">Queue is empty.</p>`;
                return;
            }
            
            listEl.innerHTML = docs.map(student => {
                const highlightClass = student.isHighlighted ? 'highlighted' : ''; // Style not in use, but good to have
                return `
                <div class="queue-item ${highlightClass}">
                   <div>
                       ${sanitize(student.name)} (${sanitize(student.grade)})
                       ${student.note ? `<span style="font-size: 0.8rem; color: var(--blue); display: block;">Note: ${sanitize(student.note)}</span>` : ''}
                   </div>
                   <!-- Action buttons -->
                   <div class="queue-item-actions">
                       <button class="btn btn-blue-outline" 
                               data-action="add-note" 
                               data-id="${student.id}"
                               data-queue="${getQueueName(listEl)}">
                           Note
                       </button>
                       <button class="btn btn-red-outline" 
                               data-action="dismiss-queue" 
                               data-id="${student.id}"
                               data-queue="${getQueueName(listEl)}">
                           Dismiss
                       </button>
                   </div>
                </div>
                `;
            }).join('');
        }
        
       // Helper to determine queue name from element
       function getQueueName(listEl) {
           if (listEl === q1List) return Q1_COLLECTION;
           if (listEl === q2List) return Q2_COLLECTION;
           if (listEl === q3List) return Q3_COLLECTION;
           return null;
       }

        /**
         * Renders a simple list for the sibling queue
         */
        function renderSiblingList_Mobile(listEl, countEl, docs) {
            docs.sort((a, b) => (a.addedAt?.seconds || 0) - (b.addedAt?.seconds || 0));
            
            let studentCount = docs.reduce((count, doc) => {
                return count + (doc.isGroup ? doc.students.length : 1);
            }, 0);
            countEl.textContent = `(${studentCount})`;
            
            if (docs.length === 0) {
                listEl.innerHTML = `<p style="padding: 0.5rem 0.75rem; color: var(--fg-gray);">Queue is empty.</p>`;
                return;
            }
            
            let html = '';
            docs.forEach(student => {
                if (student.isGroup) {
                    html += `<div class="queue-item group-header">GROUP:</div>`;
                    html += student.students.map((s, index) => {
                        const highlightClass = s.isHighlighted ? 'highlighted' : '';
                        return `
                        <div class="queue-item group-student ${highlightClass}">
                           <div>
                               ${sanitize(s.name)} (${sanitize(s.grade)})
                               ${s.note ? `<span style="font-size: 0.8rem; color: var(--blue); display: block;">Note: ${sanitize(s.note)}</span>` : ''}
                           </div>
                           <!-- Action buttons for group students -->
                           <div class="queue-item-actions">
                               <button class="btn btn-blue-outline" 
                                       data-action="add-note-group"
                                       data-id="${student.id}"
                                       data-queue="${Q2_COLLECTION}"
                                       data-index="${index}">
                                   Note
                               </button>
                               <button class="btn btn-red-outline" 
                                       data-action="dismiss-group-student"
                                       data-id="${student.id}"
                                       data-queue="${Q2_COLLECTION}"
                                       data-index="${index}">
                                   Dismiss
                               </button>
                           </div>
                        </div>`;
                    }).join('');

                   // Add a "Dismiss All" for the group
                   html += `
                   <div class="queue-item-actions" style="padding-left: 1.5rem;">
                       <button class="btn btn-red-outline" 
                               data-action="dismiss-queue" 
                               data-id="${student.id}"
                               data-queue="${Q2_COLLECTION}"
                               title="Dismiss Entire Group">
                           Dismiss Entire Group
                       </button>
                   </div>`;

                } else {
                    const highlightClass = student.isHighlighted ? 'highlighted' : '';
                     html += `
                     <div class="queue-item ${highlightClass}">
                       <div>
                           ${sanitize(student.name)} (${sanitize(student.grade)})
                           ${student.note ? `<span style="font-size: 0.8rem; color: var(--blue); display: block;">Note: ${sanitize(student.note)}</span>` : ''}
                       </div>
                       <!-- Action buttons for single students -->
                       <div class="queue-item-actions">
                           <button class="btn btn-blue-outline" 
                                   data-action="add-note" 
                                   data-id="${student.id}"
                                   data-queue="${Q2_COLLECTION}">
                               Note
                           </button>
                           <button class="btn btn-red-outline" 
                                   data-action="dismiss-queue" 
                                   data-id="${student.id}"
                                   data-queue="${Q2_COLLECTION}">
                               Dismiss
                           </button>
                       </div>
                    </div>`;
                }
            });
            listEl.innerHTML = html;
        }

        // --- Firebase Actions ---

        async function addStudentToQueue(queueNum, name, grade) {
            let collection;
            if (queueNum == 1) collection = q1ColRef;
            else if (queueNum == 2) collection = q2ColRef;
            else if (queueNum == 3) collection = q3ColRef;
            else return;

            try {
                await addDoc(collection, {
                    name: name,
                    grade: grade,
                    addedAt: serverTimestamp(),
                    addedBy: userId,
                    isHighlighted: false,
                    note: ""
                });
            } catch (error) {
                console.error("Error adding student: ", error);
            }
        }

        async function addGroupToQueue(studentGroup) {
            if (studentGroup.length === 0) return;

            const studentsForFirestore = studentGroup.map(student => ({
                name: student.name,
                grade: student.grade,
                isHighlighted: false,
                note: ""
            }));

            try {
                await addDoc(q2ColRef, {
                    isGroup: true,
                    students: studentsForFirestore,
                    addedAt: serverTimestamp(),
                    addedBy: userId
                });
                
                stagedSiblingGroup = [];
                renderStagedGroup_Mobile();
            } catch (error) {
                console.error("Error adding group to queue: ", error);
            }
        }

        async function addPermanentGroupToQueue(groupId) {
            const group = currentPermanentGroups.find(g => g.id === groupId);
            if (!group) return;

            const studentGroup = group.students.map(studentId => {
                const student = currentRoster.find(s => s.id === studentId);
                if (!student) return null;
                return {
                    name: `${student.firstName} ${student.lastName}`,
                    grade: student.grade
                };
            }).filter(s => s !== null);

            if (studentGroup.length > 0) {
                 await addDoc(q2ColRef, {
                    isGroup: true,
                    students: studentGroup.map(s => ({ ...s, isHighlighted: false, note: "" })),
                    addedAt: serverTimestamp(),
                    addedBy: userId
                });
            }
        }

       // --- Modal and Queue Actions (adapted from index.html) ---

       async function dismissStudent(queueName, docId) {
           try {
               const docRef = doc(db, `/artifacts/${appId}/public/data/${queueName}/${docId}`);
               const studentDoc = await getDoc(docRef);
               
               if (studentDoc.exists()) {
                   const studentData = studentDoc.data();
                   
                   if (studentData.isGroup) {
                       const addPromises = studentData.students.map(student => {
                           return addDoc(pickedupColRef, {
                               name: student.name,
                               grade: student.grade,
                               pickedUpAt: serverTimestamp(),
                               addedBy: userId
                           });
                       });
                       await Promise.all(addPromises);
                   } else {
                       await addDoc(pickedupColRef, {
                           name: studentData.name,
                           grade: studentData.grade,
                           pickedUpAt: serverTimestamp(),
                           addedBy: userId
                       });
                   }
                   await deleteDoc(docRef);
               }
           } catch (error) {
               console.error("Error dismissing student: ", error);
           }
       }

       async function dismissGroupStudent(queueName, docId, studentIndex) {
           try {
               const docRef = doc(db, `/artifacts/${appId}/public/data/${queueName}/${docId}`);
               const studentDoc = await getDoc(docRef);

               if (!studentDoc.exists()) return;

               let students = studentDoc.data().students;
               const studentToDismiss = students[studentIndex];

               if (!studentToDismiss) return;

               await addDoc(pickedupColRef, {
                   name: studentToDismiss.name,
                   grade: studentToDismiss.grade,
                   pickedUpAt: serverTimestamp(),
                   addedBy: userId
               });

               students.splice(studentIndex, 1);

               if (students.length === 0) {
                   await deleteDoc(docRef);
               } else {
                   await updateDoc(docRef, { students: students });
               }
           } catch (error) {
               console.error("Error dismissing group student: ", error);
           }
       }

       async function updateStudentNote(queueName, docId, studentIndex, currentNote) {
           const newNote = prompt("Enter note (or leave blank to clear):", currentNote);
           
           if (newNote === null) {
               return; // User cancelled prompt
           }
           
           try {
               const docRef = doc(db, `/artifacts/${appId}/public/data/${queueName}/${docId}`);
               
               if (studentIndex === null || studentIndex === undefined) {
                   // This is a single student (not in a group)
                   await updateDoc(docRef, { note: newNote.trim() });
               } else {
                   // This is a student inside a group
                   const studentDoc = await getDoc(docRef);
                   if (studentDoc.exists()) {
                       const studentData = studentDoc.data();
                       const students = studentData.students;
                       
                       if (students && students[studentIndex]) {
                           students[studentIndex].note = newNote.trim();
                       }
                       
                       await updateDoc(docRef, { students: students });
                   }
               }
           } catch (error) {
               console.error("Error updating note: ", error);
           }
       }

       function openConfirmationModal(title, prompt, actionPayload) {
           confirmationModalTitle.textContent = title;
           confirmationModalPrompt.textContent = prompt;
           confirmationModalAction = actionPayload;
           confirmationModalBackdrop.style.display = 'flex';
       }

       function closeConfirmationModal() {
           confirmationModalBackdrop.style.display = 'none';
           confirmationModalAction = null;
       }

       async function handleConfirmationConfirm_Mobile() {
           if (!confirmationModalAction) return;

           const { action, docId, queue, studentIndex } = confirmationModalAction;

           if (action === 'dismissQueue') {
               await dismissStudent(queue, docId);
           } else if (action === 'dismissGroupStudent') {
               await dismissGroupStudent(queue, docId, studentIndex);
           }
           
           closeConfirmationModal();
       }


        // --- Firebase Setup ---
        async function setupFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); 

                authStatus.textContent = "Authenticating...";
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = "Connected";
                        authStatus.classList.add('connected');
                        setupListeners();
                    } else {
                        authStatus.textContent = "Connection Failed. Not Authenticated.";
                        authStatus.classList.add('disconnected');
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error: ", error);
                authStatus.textContent = "Connection Failed. Check console.";
                authStatus.classList.add('disconnected');
            }
        }
        
        function setupListeners() {
            if (!db) return; 

            q1ColRef = collection(db, `/artifacts/${appId}/public/data/${Q1_COLLECTION}`);
            q2ColRef = collection(db, `/artifacts/${appId}/public/data/${Q2_COLLECTION}`);
            q3ColRef = collection(db, `/artifacts/${appId}/public/data/${Q3_COLLECTION}`);
            rosterColRef = collection(db, `/artifacts/${appId}/public/data/${ROSTER_COLLECTION}`);
            permanentGroupsColRef = collection(db, `/artifacts/${appId}/public/data/${PERMANENT_GROUPS_COLLECTION}`);
            pickedupColRef = collection(db, `/artifacts/${appId}/public/data/${PICKEDUP_COLLECTION}`);

            // Queue Listeners (call mobile renderers)
            onSnapshot(query(q1ColRef), (snapshot) => {
                const students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderQueueList_Mobile(q1List, q1Count, students);
            }, (error) => console.error("Q1 Snapshot Error:", error));

            onSnapshot(query(q2ColRef), (snapshot) => {
                const students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSiblingList_Mobile(q2List, q2Count, students);
            }, (error) => console.error("Q2 Snapshot Error:", error));

            onSnapshot(query(q3ColRef), (snapshot) => {
                const students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderQueueList_Mobile(q3List, q3Count, students);
            }, (error) => console.error("Q3 Snapshot Error:", error));
            
            // Roster Listener (for search)
            onSnapshot(query(rosterColRef), (snapshot) => {
                const students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                students.sort((a, b) => {
                    const lastCompare = (a.lastName || '').localeCompare(b.lastName || '');
                    if (lastCompare !== 0) return lastCompare;
                    return (a.firstName || '').localeCompare(b.firstName || '');
                });
                currentRoster = students; 
                
                if (searchInput.value.trim().length > 0) {
                    filterStudents(searchInput.value.trim());
                }
            }, (error) => console.error("Roster Snapshot Error:", error));
            
            // Permanent Groups Listener (for search)
            onSnapshot(query(permanentGroupsColRef), (snapshot) => {
                currentPermanentGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentPermanentGroups.sort((a, b) => a.groupName.localeCompare(b.groupName));
            }, (error) => console.error("Permanent Groups Snapshot Error:", error));
        }

        function filterStudents(searchText) {
            const lowerCaseSearch = searchText.toLowerCase();
            
            if (searchText.length === 0) {
                searchResults.innerHTML = `<p style="padding: 0.5rem 0.75rem; color: var(--fg-gray);">Start typing to see results...</p>`;
                return;
            }
            
            const filteredStudents = currentRoster.filter(student => {
                const fullName = `${student.firstName} ${student.lastName}`;
                return fullName.toLowerCase().includes(lowerCaseSearch);
            });

            const filteredGroups = currentPermanentGroups.filter(group => {
                return group.groupName.toLowerCase().includes(lowerCaseSearch);
            });

            renderSearchResults_Mobile(filteredStudents, filteredGroups);
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {

            setupFirebase();
            
            // --- View Toggling Listeners ---
            navAddBtn.addEventListener('click', () => {
                addView.style.display = 'block';
                queuesView.style.display = 'none';
                navAddBtn.classList.add('active');
                navQueuesBtn.classList.remove('active');
            });
            
            navQueuesBtn.addEventListener('click', () => {
                addView.style.display = 'none';
                queuesView.style.display = 'block';
                navAddBtn.classList.remove('active');
                navQueuesBtn.classList.add('active');
            });

            // --- Queue Action Listeners ---
           queuesView.addEventListener('click', async (e) => {
               const target = e.target.closest('.btn');
               if (!target) return;

               const { action, id, queue, index } = target.dataset;
               const studentIndex = index ? parseInt(index, 10) : null;

               if (action === 'dismiss-queue') {
                   openConfirmationModal(
                       'Dismiss Entry?',
                       `Are you sure you want to dismiss this entry?`,
                       { action: 'dismissQueue', docId: id, queue: queue }
                   );
               } else if (action === 'dismiss-group-student') {
                    openConfirmationModal(
                       'Dismiss Student?',
                       `Are you sure you want to dismiss this student from the group?`,
                       { action: 'dismissGroupStudent', docId: id, queue: queue, studentIndex: studentIndex }
                   );
               } else if (action === 'add-note') {
                   const docRef = doc(db, `/artifacts/${appId}/public/data/${queue}/${id}`);
                   const studentDoc = await getDoc(docRef);
                   const currentNote = studentDoc.data().note || "";
                   updateStudentNote(queue, id, null, currentNote);

               } else if (action === 'add-note-group') {
                   const docRef = doc(db, `/artifacts/${appId}/public/data/${queue}/${id}`);
                   const studentDoc = await getDoc(docRef);
                   const currentNote = studentDoc.data().students[studentIndex].note || "";
                   updateStudentNote(queue, id, studentIndex, currentNote);
               }
           });

           // --- Modal Listeners ---
           confirmationModalCancelBtn.addEventListener('click', closeConfirmationModal);
           confirmationModalConfirmBtn.addEventListener('click', handleConfirmationConfirm_Mobile);

            // --- Add Student Section Listeners ---
            searchInput.addEventListener('input', (e) => {
                filterStudents(e.target.value);
            });

            searchResults.addEventListener('click', (e) => {
                const target = e.target;
                const { queue, name, grade, action, groupId } = target.dataset;

                if (action === 'stage-group') {
                    stagedSiblingGroup.push({ name, grade });
                    renderStagedGroup_Mobile();
                } else if (action === 'add-permanent-group') {
                    addPermanentGroupToQueue(groupId);
                    searchInput.value = '';
                    filterStudents('');
                } else if (name && grade && queue) {
                    addStudentToQueue(queue, name, grade);
                    searchInput.value = '';
                    filterStudents('');
                }
            });

            stagedList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-staged-btn');
                if (removeBtn) {
                    const indexToRemove = parseInt(removeBtn.dataset.index, 10);
                    stagedSiblingGroup.splice(indexToRemove, 1);
                    renderStagedGroup_Mobile();
                }
            });
            
            addStagedGroupBtn.addEventListener('click', () => {
                addGroupToQueue(stagedSiblingGroup);
            });

            manualAddBtn.addEventListener('click', () => {
                const name = manualNameInput.value.trim();
                if (name) { addStudentToQueue(1, name, 'N/A'); manualNameInput.value = ''; }
            });
            manualAddBtnSib.addEventListener('click', () => {
                const name = manualNameInput.value.trim();
                if (name) { addStudentToQueue(2, name, 'N/A'); manualNameInput.value = ''; }
            });
            manualAddBtnWalk.addEventListener('click', () => {
                const name = manualNameInput.value.trim();
                if (name) { addStudentToQueue(3, name, 'N/A'); manualNameInput.value = ''; }
            });
        });
    </script>

</body>
</html>
