<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GruvBox Video Conference</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Gruvbox Dark Hard Palette */
            --bg0-hard: #1d2021;
            --bg0-soft: #32302f;
            --bg1: #3c3836;
            --bg4: #7c6f64;
            --fg0: #fbf1c7;
            --red: #cc241d;
            --green: #98971a;
            --yellow: #d79921;
            --blue: #458588;
            --purple: #b16286;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg0-hard);
            color: var(--fg0);
        }

        .gruvbox-card {
            background-color: var(--bg1);
            border: 2px solid var(--bg4);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .gruvbox-input {
            background-color: var(--bg0-soft);
            border: 1px solid var(--bg4);
            color: var(--fg0);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .gruvbox-btn {
            background-color: var(--blue);
            color: var(--fg0);
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .gruvbox-btn:hover:not(:disabled) {
            background-color: var(--yellow);
            color: var(--bg0-hard);
        }

        .gruvbox-btn:disabled {
            background-color: var(--bg4);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            background-color: var(--bg0-soft);
            border: 1px solid var(--bg4);
        }
        
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
        }

        #local-video {
            transform: scaleX(-1);
        }

        .user-info {
            background-color: var(--bg0-soft);
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--bg4);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 400px;
        }

        .message-list {
            flex-grow: 1;
            overflow-y: auto;
        }
        .message {
            background-color: var(--bg0-soft);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <!-- Main Container -->
    <div class="gruvbox-card w-full max-w-6xl rounded-xl p-6 md:p-8 flex flex-col lg:flex-row gap-6">

        <!-- Video & Controls Section -->
        <div class="flex-1 flex flex-col gap-6">
            <h1 class="text-3xl font-bold text-center">GruvBox Connect</h1>

            <!-- Username Input Section -->
            <div id="username-section" class="flex flex-col md:flex-row items-center gap-4 p-4 rounded-xl gruvbox-card">
                <input type="text" id="username-input" placeholder="Enter your username" class="gruvbox-input w-full md:flex-1 text-center" />
                <button id="set-username-btn" class="gruvbox-btn w-full md:w-auto">
                    <i class="fa-solid fa-user-check"></i> Set Username
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Local Video -->
                <div class="video-container rounded-xl overflow-hidden">
                    <video id="local-video" autoplay muted playsinline class="shadow-lg"></video>
                    <span class="absolute bottom-2 left-2 px-2 py-1 bg-black bg-opacity-50 text-white text-xs rounded-md">You</span>
                </div>
                <!-- Remote Video -->
                <div class="video-container rounded-xl overflow-hidden">
                    <video id="remote-video" autoplay playsinline class="shadow-lg"></video>
                    <span class="absolute bottom-2 left-2 px-2 py-1 bg-black bg-opacity-50 text-white text-xs rounded-md">Guest</span>
                </div>
            </div>

            <!-- Call Controls -->
            <div class="flex flex-col md:flex-row items-center justify-center gap-4 mt-4">
                <button id="start-cam-btn" class="gruvbox-btn flex-1 md:flex-none" disabled>
                    <i class="fa-solid fa-video"></i> Start Camera
                </button>

                <div class="flex flex-1 md:flex-row flex-col gap-4 w-full md:w-auto">
                    <input type="text" id="call-id-input" placeholder="Enter Call ID" class="gruvbox-input w-full md:flex-1 text-center" disabled />
                    <button id="create-call-btn" class="gruvbox-btn" disabled>
                        <i class="fa-solid fa-plus"></i> Create
                    </button>
                    <button id="join-call-btn" class="gruvbox-btn" disabled>
                        <i class="fa-solid fa-right-to-bracket"></i> Join
                    </button>
                </div>

                <button id="hangup-btn" class="gruvbox-btn flex-1 md:flex-none bg-red-700 hover:bg-red-500" disabled>
                    <i class="fa-solid fa-phone-slash"></i> Hang Up
                </button>
            </div>

            <div class="user-info text-sm text-center">
                <p><strong>Your User ID:</strong> <span id="user-id-display" class="font-mono text-xs">Waiting for Auth...</span></p>
                <p><strong>Current Call ID:</strong> <span id="current-call-id-display" class="font-mono text-xs text-yellow-500">None</span></p>
                <p><strong>Your Username:</strong> <span id="username-display" class="font-mono text-xs text-green-500">None</span></p>
                <button id="copy-btn" class="mt-2 gruvbox-btn bg-gray-600 hover:bg-gray-400 text-xs py-1 px-2" disabled>Copy Call ID</button>
            </div>
        </div>
        
        <!-- Chat Section -->
        <div class="flex-1 flex flex-col gap-4">
            <h2 class="text-xl font-bold text-center">Chat</h2>
            <div id="chat-messages" class="gruvbox-card p-4 rounded-xl flex-1 overflow-y-auto">
                <p class="text-xs text-center text-gray-400">Join a call to start chatting...</p>
            </div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Type a message..." class="gruvbox-input flex-grow" disabled>
                <button id="send-chat-btn" class="gruvbox-btn" disabled>
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>

    </div>

    <!-- Modal for copy feedback -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center transition-opacity duration-300">
        <div class="bg-blue-800 text-white p-6 rounded-lg text-center shadow-lg">
            <p id="modal-text" class="text-lg">Call ID copied to clipboard!</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, serverTimestamp, orderBy, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Global variables for Firebase and WebRTC
        let localStream;
        let remoteStream;
        let peerConnection;
        let db;
        let auth;
        let callId;
        let userId;
        let username = "";

        // Firebase Config from user
        const firebaseConfig = {
            apiKey: "AIzaSyBluS1Dl9abDJjPPeOhvTCfP8J1kyIh6BQ",
            authDomain: "video-meeting-e73eb.firebaseapp.com",
            projectId: "video-meeting-e73eb",
            storageBucket: "video-meeting-e73eb.firebasestorage.app",
            messagingSenderId: "80496795033",
            appId: "1:80496795033:web:3ac35c631d76301f77c708",
            measurementId: "G-SFPQ0PJRPG"
        };
        
        // Canvas-provided global variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // HTML element references
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const startCamBtn = document.getElementById('start-cam-btn');
        const createCallBtn = document.getElementById('create-call-btn');
        const joinCallBtn = document.getElementById('join-call-btn');
        const hangupBtn = document.getElementById('hangup-btn');
        const callIdInput = document.getElementById('call-id-input');
        const userIdDisplay = document.getElementById('user-id-display');
        const currentCallIdDisplay = document.getElementById('current-call-id-display');
        const usernameInput = document.getElementById('username-input');
        const setUsernameBtn = document.getElementById('set-username-btn');
        const usernameDisplay = document.getElementById('username-display');
        const copyBtn = document.getElementById('copy-btn');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatMessages = document.getElementById('chat-messages');
        const modal = document.getElementById('modal');
        const modalText = document.getElementById('modal-text');
        
        // Disable buttons initially
        startCamBtn.disabled = true;
        createCallBtn.disabled = true;
        joinCallBtn.disabled = true;
        hangupBtn.disabled = true;
        chatInput.disabled = true;
        sendChatBtn.disabled = true;

        // WebRTC Config
        const servers = {
            iceServers: [
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
            ],
        };

        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                getAnalytics(app); // Ensure analytics is initialized
                console.log("Firebase initialized successfully.");

                // Sign in with the provided custom token, or anonymously if it fails.
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Successfully signed in with custom token.");
                    } catch (error) {
                        console.error("Custom token sign-in failed. Falling back to anonymous auth.", error);
                        // Fallback to anonymous sign-in
                        await signInAnonymously(auth);
                        console.log("Successfully signed in anonymously.");
                    }
                } else {
                    await signInAnonymously(auth);
                    console.log("No custom token provided. Successfully signed in anonymously.");
                }

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                userIdDisplay.textContent = "Error!";
            }
        }
        
        // Listen for auth state changes to update the UI
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                startCamBtn.disabled = false;
                console.log("Auth state changed. User ID:", userId);
            } else {
                userId = null;
                userIdDisplay.textContent = "Not authenticated";
                startCamBtn.disabled = true;
                console.log("Auth state changed. User is signed out.");
            }
        });
        
        initializeFirebase();

        // --- UI Functions ---
        function showModal(message, duration = 2000) {
            modalText.textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, duration);
        }

        // --- Username Logic ---
        function setUsername() {
            const inputUsername = usernameInput.value.trim();
            if (inputUsername.length > 0) {
                username = inputUsername;
                usernameDisplay.textContent = username;
                usernameInput.disabled = true;
                setUsernameBtn.disabled = true;
                createCallBtn.disabled = false;
                joinCallBtn.disabled = false;
                copyBtn.disabled = false;
                showModal(`Username "${username}" set!`, 2000);
            } else {
                showModal("Please enter a username.", 2000);
            }
        }

        // --- WebRTC Logic ---
        async function startWebcam() {
            if (!username) {
                showModal("Please set a username first.", 3000);
                return;
            }
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                startCamBtn.disabled = true;
                hangupBtn.disabled = false;
                
            } catch (error) {
                console.error("Error accessing webcam:", error);
            }
        }

        async function createCall() {
            if (!localStream) {
                showModal("Please start your camera first.", 3000);
                return;
            }

            createCallBtn.disabled = true;
            joinCallBtn.disabled = true;
            callIdInput.disabled = true;
            
            const callDocRef = doc(collection(db, `artifacts/${appId}/public/data/calls`));
            callId = callDocRef.id;
            currentCallIdDisplay.textContent = callId;
            
            const offerCandidates = collection(db, `artifacts/${appId}/public/data/calls/${callId}/offerCandidates`);
            const answerCandidates = collection(db, `artifacts/${appId}/public/data/calls/${callId}/answerCandidates`);

            peerConnection = new RTCPeerConnection(servers);
            setupPeerConnection(offerCandidates, answerCandidates);

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            const offerDescription = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offerDescription);

            const offer = {
                sdp: offerDescription.sdp,
                type: offerDescription.type
            };

            await setDoc(callDocRef, { offer });
            console.log("Call created with ID:", callId);
        }

        async function joinCall() {
            if (!localStream) {
                showModal("Please start your camera first.", 3000);
                return;
            }

            const inputCallId = callIdInput.value.trim();
            if (!inputCallId) {
                showModal("Please enter a call ID.", 3000);
                return;
            }

            callId = inputCallId;
            const callDocRef = doc(db, `artifacts/${appId}/public/data/calls`, callId);
            const callDoc = await getDoc(callDocRef);

            if (!callDoc.exists()) {
                showModal("Invalid Call ID", 3000);
                return;
            }

            createCallBtn.disabled = true;
            joinCallBtn.disabled = true;
            callIdInput.disabled = true;
            currentCallIdDisplay.textContent = callId;
            chatInput.disabled = false;
            sendChatBtn.disabled = false;

            const offerCandidates = collection(db, `artifacts/${appId}/public/data/calls/${callId}/offerCandidates`);
            const answerCandidates = collection(db, `artifacts/${appId}/public/data/calls/${callId}/answerCandidates`);

            peerConnection = new RTCPeerConnection(servers);
            setupPeerConnection(offerCandidates, answerCandidates);

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            const offerDescription = callDoc.data().offer;
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offerDescription));

            const answerDescription = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answerDescription);

            const answer = {
                sdp: answerDescription.sdp,
                type: answerDescription.type
            };
            await updateDoc(callDocRef, { answer });
        }

        function setupPeerConnection(offerCandidatesRef, answerCandidatesRef) {
            remoteStream = new MediaStream();
            remoteVideo.srcObject = remoteStream;

            peerConnection.ontrack = event => {
                event.streams[0].getTracks().forEach(track => {
                    remoteStream.addTrack(track);
                });
            };

            peerConnection.onicecandidate = event => {
                event.candidate && addDoc(
                    (peerConnection.localDescription.type === 'offer') ? offerCandidatesRef : answerCandidatesRef,
                    event.candidate.toJSON()
                );
            };

            // Listen for remote candidates
            onSnapshot(offerCandidatesRef, snapshot => {
                snapshot.docChanges().forEach(async change => {
                    if (change.type === 'added' && peerConnection.localDescription.type !== 'offer') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        try {
                            await peerConnection.addIceCandidate(candidate);
                        } catch (error) {
                            console.error("Error adding offer candidate:", error);
                        }
                    }
                });
            });

            onSnapshot(answerCandidatesRef, snapshot => {
                snapshot.docChanges().forEach(async change => {
                    if (change.type === 'added' && peerConnection.localDescription.type !== 'answer') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        try {
                            await peerConnection.addIceCandidate(candidate);
                        } catch (error) {
                            console.error("Error adding answer candidate:", error);
                        }
                    }
                });
            });

            // Listen for remote description (answer)
            const callDocRef = doc(db, `artifacts/${appId}/public/data/calls`, callId);
            onSnapshot(callDocRef, async snapshot => {
                const data = snapshot.data();
                if (peerConnection.localDescription.type === 'offer' && data?.answer) {
                    const answerDescription = new RTCSessionDescription(data.answer);
                    await peerConnection.setRemoteDescription(answerDescription);
                }
            });
            
            chatInput.disabled = false;
            sendChatBtn.disabled = false;
            listenForChatMessages();
        }

        async function hangUp() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localVideo.srcObject = null;
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteVideo.srcObject = null;
            }
            if (peerConnection) {
                peerConnection.close();
            }
            
            // Clean up Firestore data
            if (callId) {
                const callDocRef = doc(db, `artifacts/${appId}/public/data/calls`, callId);
                const offerCandidatesRef = collection(db, `artifacts/${appId}/public/data/calls/${callId}/offerCandidates`);
                const answerCandidatesRef = collection(db, `artifacts/${appId}/public/data/calls/${callId}/answerCandidates`);
                
                const deleteDocs = async (colRef) => {
                    const docs = await getDocs(colRef);
                    docs.forEach(d => deleteDoc(d.ref));
                };
                
                // deleteDocs(offerCandidatesRef);
                // deleteDocs(answerCandidatesRef);
                // deleteDoc(callDocRef);
                // Not deleting for demo purpose, to allow re-joining, but this is how you would clean up.
            }

            // Reset UI
            startCamBtn.disabled = false;
            createCallBtn.disabled = false;
            joinCallBtn.disabled = false;
            hangupBtn.disabled = true;
            callIdInput.disabled = false;
            callIdInput.value = '';
            currentCallIdDisplay.textContent = "None";
            chatInput.disabled = true;
            sendChatBtn.disabled = true;
            chatMessages.innerHTML = '<p class="text-xs text-center text-gray-400">Join a call to start chatting...</p>';
        }

        // --- Chat Logic ---
        async function sendMessage() {
            if (chatInput.value.trim() === "" || !callId || !userId || !username) return;

            const chatRef = collection(db, `artifacts/${appId}/public/data/chats`);
            await addDoc(chatRef, {
                callId: callId,
                userId: userId,
                username: username,
                message: chatInput.value.trim(),
                timestamp: serverTimestamp()
            });
            chatInput.value = "";
        }

        function listenForChatMessages() {
            const chatRef = collection(db, `artifacts/${appId}/public/data/chats`);
            const chatQuery = query(
                chatRef,
                where("callId", "==", callId),
                orderBy("timestamp")
            );

            onSnapshot(chatQuery, (snapshot) => {
                chatMessages.innerHTML = '';
                if (snapshot.docs.length === 0) {
                    chatMessages.innerHTML = '<p class="text-xs text-center text-gray-400">No messages yet...</p>';
                    return;
                }
                snapshot.docs.forEach(doc => {
                    const msg = doc.data();
                    const isSelf = msg.userId === userId;
                    const messageElement = document.createElement('div');
                    messageElement.className = `message mb-2 p-2 rounded-lg text-sm ${isSelf ? 'bg-blue-700 ml-auto' : 'bg-gray-600 mr-auto'}`;
                    messageElement.innerHTML = `
                        <p class="font-bold text-xs">${isSelf ? 'You' : msg.username || msg.userId.substring(0, 8)}</p>
                        <p>${msg.message}</p>
                    `;
                    chatMessages.appendChild(messageElement);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            });
        }
        
        // --- Event Listeners ---
        setUsernameBtn.addEventListener('click', setUsername);
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                setUsername();
            }
        });
        startCamBtn.addEventListener('click', startWebcam);
        createCallBtn.addEventListener('click', createCall);
        joinCallBtn.addEventListener('click', joinCall);
        hangupBtn.addEventListener('click', hangUp);
        sendChatBtn.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        copyBtn.addEventListener('click', () => {
            if (callId) {
                const tempInput = document.createElement('input');
                tempInput.value = callId;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showModal("Call ID copied!", 2000);
            } else {
                showModal("No active call ID to copy.", 2000);
            }
        });

    </script>
</body>
</html>
