<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Screen Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .video-placeholder {
            background-color: #2d3748;
            border: 2px dashed #4a5568;
        }
        #remoteScreen {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .lds-ring {
          display: inline-block;
          position: relative;
          width: 80px;
          height: 80px;
        }
        .lds-ring div {
          box-sizing: border-box;
          display: block;
          position: absolute;
          width: 64px;
          height: 64px;
          margin: 8px;
          border: 8px solid #fff;
          border-radius: 50%;
          animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
          border-color: #fff transparent transparent transparent;
        }
        .lds-ring div:nth-child(1) {
          animation-delay: -0.45s;
        }
        .lds-ring div:nth-child(2) {
          animation-delay: -0.3s;
        }
        .lds-ring div:nth-child(3) {
          animation-delay: -0.15s;
        }
        @keyframes lds-ring {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-2">Simple Screen Share</h1>
        <p class="text-center text-gray-400 mb-6">Share your screen with another person using a Room ID.</p>

        <!-- Room Connection UI -->
        <div id="room-ui" class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6 flex flex-col sm:flex-row items-center justify-center gap-4">
            <button id="createRoomBtn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Create Room</button>
            <div class="text-gray-400 font-mono text-center">OR</div>
            <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                <input type="text" id="roomIdInput" placeholder="Enter Room ID to Join" class="w-full sm:w-64 bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="joinRoomBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Join Room</button>
            </div>
        </div>

        <!-- Info and Controls -->
        <div id="session-info" class="hidden text-center mb-4 bg-gray-800 p-4 rounded-lg">
            <p class="text-gray-400">Your User ID: <span id="userId" class="font-mono text-gray-300"></span></p>
            <p class="text-green-400">Connected to Room: <span id="roomIdDisplay" class="font-mono text-green-300"></span></p>
            <div id="controls" class="mt-4 flex justify-center gap-4">
                <button id="startShareBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg transition-colors">Start Sharing</button>
                <button id="stopShareBtn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg transition-colors">Stop Sharing</button>
            </div>
        </div>

        <!-- Screen Display Area -->
        <div class="w-full grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Remote Screen -->
            <div class="bg-gray-800 rounded-lg shadow-xl p-4 flex flex-col items-center justify-center aspect-video">
                <h2 class="text-lg font-semibold mb-2 text-gray-400">Remote Screen</h2>
                <div id="remoteScreenContainer" class="w-full h-full flex items-center justify-center video-placeholder rounded-md">
                     <div id="waiting-message" class="text-gray-500">Waiting for other user to share...</div>
                     <div id="loading-spinner" class="hidden lds-ring"><div></div><div></div><div></div><div></div></div>
                     <img id="remoteScreen" class="hidden rounded-md"/>
                </div>
            </div>
            <!-- Local Preview -->
            <div class="bg-gray-800 rounded-lg shadow-xl p-4 flex flex-col items-center justify-center aspect-video">
                <h2 class="text-lg font-semibold mb-2 text-gray-400">Your Preview</h2>
                <div class="w-full h-full flex items-center justify-center video-placeholder rounded-md">
                    <video id="localVideo" class="rounded-md" autoplay muted playsinline style="transform: scaleX(-1); max-width: 100%; max-height:100%"></video>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        } catch (e) {
            console.error("Firebase config parsing error:", e);
            firebaseConfig = { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- DOM Elements ---
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const roomIdInput = document.getElementById('roomIdInput');
        const startShareBtn = document.getElementById('startShareBtn');
        const stopShareBtn = document.getElementById('stopShareBtn');
        const localVideo = document.getElementById('localVideo');
        const remoteScreen = document.getElementById('remoteScreen');
        const roomUi = document.getElementById('room-ui');
        const sessionInfo = document.getElementById('session-info');
        const roomIdDisplay = document.getElementById('roomIdDisplay');
        const userIdDisplay = document.getElementById('userId');
        const remoteScreenContainer = document.getElementById('remoteScreenContainer');
        const waitingMessage = document.getElementById('waiting-message');
        const loadingSpinner = document.getElementById('loading-spinner');

        // --- App State ---
        let currentRoomId = null;
        let userId = null;
        let localStream = null;
        let captureInterval = null;
        let firestoreUnsubscribe = null;

        // --- Core Functions ---
        async function initializeAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                userIdDisplay.textContent = userId;
            } catch (error) {
                console.error("Authentication failed:", error);
                userIdDisplay.textContent = "Error: Could not authenticate.";
            }
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        async function createRoom() {
            if (!userId) {
                alert("Please wait for authentication to complete.");
                return;
            }
            const newRoomId = generateRoomId();
            const roomRef = doc(db, `artifacts/${appId}/public/data/screenshare`, newRoomId);
            await setDoc(roomRef, {
                createdAt: serverTimestamp(),
                sharerId: null,
                frame: null,
            });
            joinRoom(newRoomId);
        }

        async function joinRoom(roomIdToJoin) {
            if (!roomIdToJoin) {
                alert("Please enter a Room ID.");
                return;
            }
            const roomRef = doc(db, `artifacts/${appId}/public/data/screenshare`, roomIdToJoin);
            const roomSnap = await getDoc(roomRef);

            if (!roomSnap.exists()) {
                alert("Room not found. Please check the ID.");
                return;
            }

            currentRoomId = roomIdToJoin;
            roomUi.classList.add('hidden');
            sessionInfo.classList.remove('hidden');
            roomIdDisplay.textContent = currentRoomId;

            listenToRoomChanges();
        }

        function listenToRoomChanges() {
            if (firestoreUnsubscribe) firestoreUnsubscribe();
            const roomRef = doc(db, `artifacts/${appId}/public/data/screenshare`, currentRoomId);
            
            firestoreUnsubscribe = onSnapshot(roomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const frameData = data.frame;
                    const sharerId = data.sharerId;

                    if (frameData && sharerId !== userId) {
                        waitingMessage.classList.add('hidden');
                        loadingSpinner.classList.add('hidden');
                        remoteScreen.classList.remove('hidden');
                        remoteScreen.src = frameData;
                    } else if (!frameData) {
                         waitingMessage.classList.remove('hidden');
                         remoteScreen.classList.add('hidden');
                    }
                }
            });
        }

        async function startSharing() {
            try {
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "always" },
                    audio: false
                });
                localVideo.srcObject = localStream;
                startShareBtn.classList.add('hidden');
                stopShareBtn.classList.remove('hidden');

                const roomRef = doc(db, `artifacts/${appId}/public/data/screenshare`, currentRoomId);
                await updateDoc(roomRef, { sharerId: userId });

                // Start capturing frames
                captureInterval = setInterval(captureAndSendFrame, 750); // ~1.3 FPS, adjust for performance

            } catch (err) {
                console.error("Error starting screen share:", err);
                stopSharing();
            }
        }

        function stopSharing() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }
            localStream = null;
            localVideo.srcObject = null;
            startShareBtn.classList.remove('hidden');
            stopShareBtn.classList.add('hidden');

            const roomRef = doc(db, `artifacts/${appId}/public/data/screenshare`, currentRoomId);
            updateDoc(roomRef, { frame: null, sharerId: null });
        }
        
        function captureAndSendFrame() {
            if (!localStream || !localStream.active) {
                stopSharing();
                return;
            }
            
            const videoTrack = localStream.getVideoTracks()[0];
            const imageCapture = new ImageCapture(videoTrack);

            imageCapture.grabFrame()
                .then(imageBitmap => {
                    const canvas = document.createElement('canvas');
                    canvas.width = imageBitmap.width / 2; // Reduce resolution for performance
                    canvas.height = imageBitmap.height / 2;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(imageBitmap, 0, 0, canvas.width, canvas.height);
                    
                    // Convert to data URL (jpeg is smaller than png)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.4); // Quality 0.4

                    const roomRef = doc(db, `artifacts/${appId}/public/data/screenshare`, currentRoomId);
                    updateDoc(roomRef, { frame: dataUrl });
                })
                .catch(error => {
                    console.error('grabFrame() error: ', error);
                });
        }


        // --- Event Listeners ---
        createRoomBtn.addEventListener('click', createRoom);
        joinRoomBtn.addEventListener('click', () => joinRoom(roomIdInput.value.trim()));
        startShareBtn.addEventListener('click', startSharing);
        stopShareBtn.addEventListener('click', stopSharing);

        // --- Initialization ---
        initializeAuth();

    </script>
</body>
</html>
