<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1 on 1 gamer chat</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;500&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            background-image: url('https://i.postimg.cc/NjL7WtvQ/gamerchat.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #E8E8E8;
            min-height: 100vh;
        }

        .header {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            color: #E8E8E8;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .container-card {
            background-color: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease-in-out;
            border: 1px solid rgba(48, 48, 48, 0.6);
        }

        .btn-primary {
            @apply px-6 py-3 font-semibold rounded-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#00FFFF] focus:ring-offset-[#121212];
            background-color: #00FFFF; /* Neon Cyan */
            color: #121212;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-danger {
            @apply px-6 py-3 font-semibold rounded-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#FF00FF] focus:ring-offset-[#121212];
            background-color: #FF00FF; /* Neon Magenta */
            color: #E8E8E8;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-toggle {
            @apply px-4 py-2 font-semibold rounded-lg transition-all duration-300 focus:outline-none hover:bg-gray-700 hover:shadow-lg;
            background-color: rgba(48, 48, 48, 0.6);
            color: #E8E8E8;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-toggle-active {
            @apply bg-[#00FFFF] text-[#121212] hover:bg-cyan-400 focus:ring-[#00FFFF];
        }

        .layout-btn-active {
            @apply bg-[#FF00FF] text-white hover:bg-fuchsia-400;
        }

        .input-field {
            @apply w-full px-4 py-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#00FFFF] transition-all duration-200;
            background-color: rgba(18, 18, 18, 0.8);
            color: #E8E8E8;
        }
        
        .video-grid {
            position: relative;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
            gap: 1rem;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 0.75rem;
            padding: 0.5rem;
            aspect-ratio: 16/9;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            background-image: linear-gradient(45deg, #1d2021, #32302f);
            animation: background-pan 10s ease-in-out infinite alternate;
            background-size: 200% 200%;
        }

        @keyframes background-pan {
            from {
                background-position: 0% 0%;
            }
            to {
                background-position: 100% 100%;
            }
        }

        .video-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            background-color: #121212;
        }

        .video-element {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.75rem;
        }

        #localVideo {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            width: 150px;
            height: 112.5px;
            border-radius: 0.75rem;
            z-index: 10;
            border: 2px solid #00FFFF;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease-in-out;
            object-fit: cover;
        }

        .chat-container {
            background-color: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(48, 48, 48, 0.6);
            border-radius: 0.75rem;
            height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
        }

        .message {
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .my-message {
            background-color: #00FFFF;
            color: #121212;
            align-self: flex-end;
        }
        
        .other-message {
            background-color: rgba(48, 48, 48, 0.6);
            color: #E8E8E8;
            align-self: flex-start;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .spinner {
            border: 4px solid #333;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-top-color: #00FFFF;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .logo-text {
            font-family: 'Space Mono', monospace;
            color: #FF00FF;
            text-shadow: 0 0 5px #FF00FF;
        }
        
        .reaction {
            position: absolute;
            font-size: 3rem;
            animation: rise-and-fade 3s forwards;
            pointer-events: none;
            opacity: 0;
            z-index: 20;
        }

        @keyframes rise-and-fade {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            100% {
                transform: translateY(-200px) scale(1);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">
    <header class="header w-full py-4 mb-8 flex flex-col sm:flex-row items-center justify-between px-6 shadow-md rounded-lg">
        <div class="flex items-center">
            <h1 class="text-3xl sm:text-4xl font-semibold logo-text">
                1 on 1 gamer chat
            </h1>
        </div>
        <div class="text-sm mt-2 sm:mt-0 font-light" id="auth-status">Authenticating...</div>
    </header>

    <!-- Initial Username Prompt -->
    <div id="usernamePrompt" class="w-full max-w-lg container-card flex flex-col items-center justify-center p-8">
        <h2 class="text-2xl font-bold logo-text mb-4">Welcome</h2>
        <p class="text-sm text-gray-400 mb-6 text-center">Enter your name to join the conference.</p>
        <input type="text" id="usernameInput" placeholder="Your Name" class="input-field max-w-sm mb-4" />
        <div class="flex flex-col space-y-2 text-sm w-full max-w-sm">
            <label class="flex items-center space-x-2">
                <input type="checkbox" id="micOffCheckbox" class="rounded text-[#00FFFF]">
                <span>Start with microphone off</span>
            </label>
            <label class="flex items-center space-x-2">
                <input type="checkbox" id="cameraOffCheckbox" class="rounded text-[#00FFFF]">
                <span>Start with camera off</span>
            </label>
            <label class="flex items-center space-x-2">
                <span class="text-gray-400">Video Quality:</span>
                <select id="videoQuality" class="input-field py-1">
                    <option value="480p">480p</option>
                    <option value="720p" selected>720p</option>
                    <option value="1080p">1080p</option>
                </select>
            </label>
        </div>
        <button id="submitUsernameBtn" class="btn-primary max-w-xs w-full mt-6">Start Conference</button>
    </div>

    <!-- Main App Content (hidden initially) -->
    <main id="mainApp" class="w-full max-w-6xl mx-auto flex flex-col md:flex-row gap-8 hidden">
        <!-- Main Video and Controls -->
        <div class="w-full md:w-3/4 flex flex-col space-y-8">
            <div class="container-card flex-grow flex flex-col items-center">
                <h2 class="text-xl font-bold logo-text mb-4">Video Feed</h2>
                <div id="videoGrid" class="video-grid flex-grow w-full">
                    <div id="localVideoWrapper" class="video-wrapper">
                        <video id="localVideo" autoplay playsinline muted class="video-element"></video>
                    </div>
                    <div id="remoteVideoWrapper" class="video-wrapper">
                        <video id="remoteVideo" autoplay playsinline class="video-element"></video>
                    </div>
                </div>

                <div id="loadingIndicator" class="flex items-center space-x-3 text-sm text-gray-400 mt-4 hidden">
                    <div class="spinner"></div>
                    <span>Connecting...</span>
                </div>
                
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 items-center justify-center mt-4 w-full">
                    <button id="toggleAudioBtn" class="btn-toggle rounded-lg"><i class="fas fa-microphone"></i> Mute Audio</button>
                    <button id="toggleVideoBtn" class="btn-toggle rounded-lg"><i class="fas fa-video"></i> Mute Video</button>
                    <button id="hangupBtn" class="btn-danger rounded-lg flex-1">Hang Up</button>
                    <button id="toggleFullscreenBtn" class="btn-toggle rounded-lg"><i class="fas fa-expand"></i> Full Screen</button>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-volume-down text-lg text-gray-400"></i>
                        <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="1" class="w-20 cursor-pointer">
                        <i class="fas fa-volume-up text-lg text-gray-400"></i>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 items-center justify-center mt-4 w-full">
                    <button id="likeBtn" class="btn-toggle rounded-lg"><i class="fas fa-thumbs-up"></i> Like</button>
                    <button id="drumrollBtn" class="btn-toggle rounded-lg"><i class="fas fa-drum"></i> Drumroll</button>
                    <button id="applauseBtn" class="btn-toggle rounded-lg"><i class="fas fa-hands-clapping"></i> Applause</button>
                </div>

                <div id="screenShareControls" class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 items-center justify-center mt-4 w-full">
                     <button id="toggleScreenShareBtn" class="btn-toggle rounded-lg"><i class="fas fa-desktop"></i> Start Screen Share</button>
                </div>

                <div id="hostControls" style="display: none;" class="flex flex-col space-y-4 w-full mt-4">
                    <div class="container-card w-full">
                        <h2 class="text-xl font-bold logo-text mb-4">Layout Controls</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <button class="btn-toggle layout-btn rounded-lg" data-layout="full">Full Screen</button>
                            <button class="btn-toggle layout-btn rounded-lg" data-layout="pip-bottom-right">Picture-in-Picture</button>
                            <button class="btn-toggle layout-btn rounded-lg" data-layout="side-by-side">Side-by-Side</button>
                            <button class="btn-toggle layout-btn rounded-lg" data-layout="local-on-top">Local-on-Top</button>
                        </div>
                    </div>
                    <button class="btn-primary w-full rounded-lg" id="takeStageBtn"><i class="fas fa-star"></i> Take the Stage</button>
                </div>
            </div>
        </div>

        <!-- Right Side Panels -->
        <div class="w-full md:w-1/4 space-y-8 flex flex-col">
            <div class="container-card">
                <h2 class="text-xl font-bold logo-text mb-4">Room Management</h2>
                <div class="flex flex-col space-y-4">
                    <div class="flex space-x-2">
                        <input type="text" id="roomIdInput" placeholder="Enter Room ID" class="input-field flex-1" />
                        <button id="joinRoomBtn" class="btn-primary">Join</button>
                    </div>
                    <button id="createRoomBtn" class="btn-primary">Create New Room</button>
                </div>
            </div>

            <div class="container-card flex-grow" id="participantsList" style="display: none;">
                <h2 class="text-xl font-bold logo-text mb-4">Participants</h2>
                <div class="space-y-2">
                    <p class="text-gray-400 text-sm">No other participants.</p>
                </div>
            </div>
            
            <div class="container-card" id="activeUsersPanel" style="display: none;">
                <h2 class="text-xl font-bold logo-text mb-4">Active Users</h2>
                <div id="activeUsersList" class="space-y-2">
                    <p class="text-gray-400 text-sm">Loading users...</p>
                </div>
            </div>

            <div class="container-card">
                <h2 class="text-xl font-bold logo-text mb-4">Active Rooms</h2>
                <div id="activeRoomsList" class="space-y-2">
                    <p class="text-gray-400 text-sm">Loading rooms...</p>
                </div>
            </div>
        </div>
    </main>
    <div id="status-message" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg text-sm text-center text-gray-700 bg-gray-100 hidden"></div>
    
    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Constants and UI Elements ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initial UI elements outside of the main app container
        const ui = {
            usernamePrompt: document.getElementById('usernamePrompt'),
            mainApp: document.getElementById('mainApp'),
            usernameInput: document.getElementById('usernameInput'),
            submitUsernameBtn: document.getElementById('submitUsernameBtn'),
            micOffCheckbox: document.getElementById('micOffCheckbox'),
            cameraOffCheckbox: document.getElementById('cameraOffCheckbox'),
            videoQuality: document.getElementById('videoQuality'),
            statusMessage: document.getElementById('status-message'),
            authStatus: document.getElementById('auth-status'),
            activeRoomsList: document.getElementById('activeRoomsList'),
            activeUsersPanel: document.getElementById('activeUsersPanel'),
            activeUsersList: document.getElementById('activeUsersList'),
            roomIdInput: document.getElementById('roomIdInput'),
            createRoomBtn: document.getElementById('createRoomBtn'),
            joinRoomBtn: document.getElementById('joinRoomBtn'),
        };

        // Firestore and Auth instances
        let app, db, auth;
        let userId;
        let cleanupIntervalId = null;

        // User-specific variables
        let username;
        let isCreator = false;
        let screenStream = null;

        // WebRTC variables
        let peerConnection = null;
        let localStream = null;
        let roomRef = null;
        let roomSnapshotListener = null;
        let candidatesListener = null;
        let chatListener = null;
        let roomsListener = null;
        let activeUsersListener = null;
        let participantsListener = null;
        let previousParticipants = {};
        let isMuted = false;
        let isVideoOff = false;

        // WebRTC STUN servers
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
            ]
        };

        // --- Helper Functions ---
        
        /**
         * Displays a temporary toast-style message at the bottom of the screen.
         * @param {string} msg The message to display.
         * @param {boolean} isError If true, styles the message as an error.
         */
        const showMessage = (msg, isError = false) => {
            ui.statusMessage.textContent = msg;
            ui.statusMessage.style.display = 'block';
            ui.statusMessage.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg text-sm text-center transition-all duration-300 transform animate-fade-in ${isError ? 'text-red-700 bg-red-100' : 'text-gray-700 bg-gray-100'}`;
            setTimeout(() => {
                ui.statusMessage.style.display = 'none';
            }, 5000);
        };
        
        /**
         * Cleans up and deletes any rooms that have no participants.
         * This function runs periodically for the host.
         */
        const cleanupRooms = async () => {
            const roomsCollectionRef = collection(db, `artifacts/${appId}/public/data/video-rooms`);
            const querySnapshot = await getDocs(roomsCollectionRef);

            querySnapshot.forEach(async (roomDoc) => {
                const roomData = roomDoc.data();
                const participants = roomData.participants || {};
                const participantCount = Object.keys(participants).length;

                if (participantCount === 0) {
                    try {
                        const messagesCollectionRef = collection(roomDoc.ref, 'chat-messages');
                        const messagesSnapshot = await getDocs(messagesCollectionRef);
                        messagesSnapshot.forEach(async (msgDoc) => await deleteDoc(doc(messagesCollectionRef, msgDoc.id)));
                        await deleteDoc(roomDoc.ref);
                        console.log(`Cleaned up empty room: ${roomDoc.id}`);
                    } catch (error) {
                        console.error(`Error cleaning up room ${roomDoc.id}:`, error);
                    }
                }
            });
        };
        
        // --- Sound and Visual Effects ---
        let drum;
        let applause;
        
        const initAudio = () => {
            // Drumroll effect
            drum = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 10,
                oscillator: { type: 'sine' }
            }).toDestination();

            // Simple applause effect
            applause = new Tone.NoiseSynth({
                noise: { type: 'white' },
                envelope: {
                    attack: 0.01,
                    decay: 0.5,
                    sustain: 0.1,
                    release: 0.3
                }
            }).toDestination();
        };
        
        const playDrumroll = () => {
            Tone.start();
            drum.triggerAttackRelease("C1", "1n");
            drum.triggerAttackRelease("G1", "1n", "+0.25");
            drum.triggerAttackRelease("C2", "1n", "+0.5");
        };
        
        const playApplause = () => {
            Tone.start();
            applause.triggerAttackRelease("1n");
        };
        
        const sendReaction = () => {
            const reaction = document.createElement('div');
            reaction.classList.add('reaction');
            reaction.textContent = '❤️';
            
            const videoGrid = document.getElementById('videoGrid');
            const rect = videoGrid.getBoundingClientRect();
            const startX = Math.random() * rect.width;
            
            reaction.style.left = `${startX}px`;
            reaction.style.bottom = `${rect.height * 0.1}px`;
            
            videoGrid.appendChild(reaction);
            
            setTimeout(() => {
                reaction.remove();
            }, 3000);
        };

        // --- Firebase and Authentication ---
        
        /**
         * Initializes Firebase and sets up the authentication state listener.
         */
        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     showMessage("Firebase configuration is missing.", true);
                     return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        ui.authStatus.textContent = `User ID: ${userId}`;
                        ui.createRoomBtn.disabled = false;
                        ui.joinRoomBtn.disabled = false;
                        listenForRooms();
                        listenForActiveUsers();
                    } else {
                        ui.authStatus.textContent = 'Authenticating...';
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            showMessage("Authentication failed.", true);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage(`Firebase initialization failed: ${error.message}`, true);
            }
        };

        const setUsername = () => {
            const user = ui.usernameInput.value.trim();
            if (user) {
                username = user;
                ui.usernamePrompt.style.display = 'none';
                ui.mainApp.style.display = 'flex';
                
                // Now that the main app is visible, get and enable its elements.
                const mainAppUi = {
                    localVideo: document.getElementById('localVideo'),
                    remoteVideo: document.getElementById('remoteVideo'),
                    hangupBtn: document.getElementById('hangupBtn'),
                    toggleAudioBtn: document.getElementById('toggleAudioBtn'),
                    toggleVideoBtn: document.getElementById('toggleVideoBtn'),
                    chatInput: document.getElementById('chatInput'),
                    sendChatBtn: document.getElementById('sendChatBtn'),
                    chatContainer: document.getElementById('chatContainer'),
                    hostControls: document.getElementById('hostControls'),
                    participantsList: document.getElementById('participantsList'),
                    takeStageBtn: document.getElementById('takeStageBtn'),
                    toggleFullscreenBtn: document.getElementById('toggleFullscreenBtn'),
                    volumeControl: document.getElementById('volumeControl'),
                    toggleScreenShareBtn: document.getElementById('toggleScreenShareBtn'),
                    loadingIndicator: document.getElementById('loadingIndicator'),
                    likeBtn: document.getElementById('likeBtn'),
                    drumrollBtn: document.getElementById('drumrollBtn'),
                    applauseBtn: document.getElementById('applauseBtn'),
                };
                
                // Update the global ui object with these new references
                Object.assign(ui, mainAppUi);
                
                // Add event listeners for the main app UI after it's visible
                ui.createRoomBtn.addEventListener('click', createRoom);
                ui.joinRoomBtn.addEventListener('click', joinRoom);
                ui.hangupBtn.addEventListener('click', hangup);
                ui.toggleAudioBtn.addEventListener('click', toggleAudio);
                ui.toggleVideoBtn.addEventListener('click', toggleVideo);
                ui.sendChatBtn.addEventListener('click', sendMessage);
                ui.chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') sendMessage();
                });
                
                ui.toggleScreenShareBtn.addEventListener('click', toggleScreenShare);

                ui.takeStageBtn.addEventListener('click', async () => {
                    if (roomRef && isCreator) {
                        const remoteStyles = { width: 100, height: 100, top: 0, left: 0, units: '%' };
                        const localStyles = { width: 0, height: 0, top: 0, left: 0, units: '%' };
                        await updateDoc(roomRef, { layout: { remote: remoteStyles, local: localStyles }, spotlight: userId });
                    }
                });

                ui.toggleFullscreenBtn.addEventListener('click', () => {
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                        ui.toggleFullscreenBtn.innerHTML = `<i class="fas fa-expand"></i> Full Screen`;
                    } else {
                        ui.remoteVideo.requestFullscreen();
                        ui.toggleFullscreenBtn.innerHTML = `<i class="fas fa-compress"></i> Exit Full Screen`;
                    }
                });

                ui.volumeControl.addEventListener('input', () => {
                    ui.remoteVideo.volume = ui.volumeControl.value;
                });
                
                ui.likeBtn.addEventListener('click', sendReaction);
                ui.drumrollBtn.addEventListener('click', playDrumroll);
                ui.applauseBtn.addEventListener('click', playApplause);
                setupLayoutButtons();
                
                ui.chatInput.disabled = false;
                ui.sendChatBtn.disabled = false;
            } else {
                showMessage("Please enter a username.", true);
            }
        };

        // --- WebRTC Functions ---

        /**
         * Gets the local video and audio stream from the user's camera/mic.
         * Sets initial state based on user preferences.
         */
        const getLocalStream = async () => {
            ui.loadingIndicator.classList.remove('hidden');

            const videoConstraints = getVideoConstraints(ui.videoQuality.value);
            const audioEnabled = !ui.micOffCheckbox.checked;
            const videoEnabled = !ui.cameraOffCheckbox.checked;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: videoEnabled ? videoConstraints : false,
                    audio: audioEnabled
                });
                
                ui.localVideo.srcObject = localStream;
                ui.localVideo.muted = true;
                
                isMuted = !audioEnabled;
                isVideoOff = !videoEnabled;

                ui.toggleAudioBtn.innerHTML = `<i class="fas fa-${isMuted ? 'microphone-slash' : 'microphone'}"></i> ${isMuted ? "Unmute Audio" : "Mute Audio"}`;
                ui.toggleAudioBtn.classList.toggle('btn-toggle-active', !isMuted);

                ui.toggleVideoBtn.innerHTML = `<i class="fas fa-${isVideoOff ? 'video-slash' : 'video'}"></i> ${isVideoOff ? "Turn On Video" : "Turn Off Video"}`;
                ui.toggleVideoBtn.classList.toggle('btn-toggle-active', !isVideoOff);

                ui.toggleAudioBtn.disabled = false;
                ui.toggleVideoBtn.disabled = false;
                
                ui.loadingIndicator.classList.add('hidden');
                return localStream;
            } catch (error) {
                console.error("Error getting user media:", error);
                if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
                    showMessage("Access to camera/microphone was denied. Please check your browser's settings.", true);
                } else {
                    showMessage("Could not access camera and microphone. Please grant permissions.", true);
                }
                ui.loadingIndicator.classList.add('hidden');
                return null;
            }
        };

        const getVideoConstraints = (quality) => {
            switch (quality) {
                case '480p':
                    return { width: { ideal: 640 }, height: { ideal: 480 } };
                case '720p':
                    return { width: { ideal: 1280 }, height: { ideal: 720 } };
                case '1080p':
                    return { width: { ideal: 1920 }, height: { ideal: 1080 } };
                default:
                    return true;
            }
        };
        
        /**
         * Sets up the RTCPeerConnection object and its event handlers.
         */
        const setupPeerConnection = () => {
            peerConnection = new RTCPeerConnection(configuration);

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidatesCollection = collection(roomRef, 'candidates');
                    addDoc(candidatesCollection, { candidate: JSON.stringify(event.candidate.toJSON()), sender: userId });
                }
            };

            peerConnection.ontrack = (event) => {
                if (event.streams && event.streams[0]) {
                    ui.remoteVideo.srcObject = event.streams[0];
                }
            };
        };

        // --- Room Management and Call Flow ---

        const createRoom = async () => {
            if (!userId || !username) {
                showMessage("Authentication in progress or no username. Please wait.", true);
                return;
            }

            isCreator = true;
            ui.hostControls.style.display = 'flex';
            ui.participantsList.style.display = 'block';
            ui.hangupBtn.disabled = false;
            ui.sendChatBtn.disabled = false;
            ui.toggleScreenShareBtn.disabled = false;
            ui.createRoomBtn.disabled = true;
            ui.joinRoomBtn.disabled = true;

            const roomName = `room-${Math.random().toString(36).substring(2, 9)}`;
            ui.roomIdInput.value = roomName;
            roomRef = doc(db, `artifacts/${appId}/public/data/video-rooms`, roomName);

            showMessage("Creating room...");

            const stream = await getLocalStream();
            if (!stream) {
                 ui.createRoomBtn.disabled = false;
                 ui.joinRoomBtn.disabled = false;
                 return;
            }

            setupPeerConnection();
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            await setDoc(roomRef, { 
                offer: { sdp: offer.sdp, type: offer.type }, 
                createdBy: userId, 
                createdByUsername: username,
                participants: { [userId]: username }
            });

            // Start cleanup only for the host
            cleanupIntervalId = setInterval(cleanupRooms, 300000); // Check every 5 minutes

            showMessage(`Room created! Share this ID: ${roomName}`);
            
            // Set up listeners for the call
            listenForChat(roomRef);
            listenForParticipants();
        };

        const joinRoom = async () => {
            if (!userId || !username) {
                showMessage("Authentication in progress or no username. Please wait.", true);
                return;
            }

            const roomId = ui.roomIdInput.value;
            if (!roomId) {
                showMessage("Please enter a Room ID.", true);
                return;
            }
            
            // Disable join buttons to prevent multiple clicks
            ui.joinRoomBtn.disabled = true;
            ui.createRoomBtn.disabled = true;

            roomRef = doc(db, `artifacts/${appId}/public/data/video-rooms`, roomId);
            const roomSnapshot = await getDoc(roomRef);

            if (!roomSnapshot.exists()) {
                showMessage("Room does not exist.", true);
                 ui.joinRoomBtn.disabled = false;
                 ui.createRoomBtn.disabled = false;
                return;
            }
            
            const roomData = roomSnapshot.data();
            const participantCount = Object.keys(roomData.participants || {}).length;
            
            if (participantCount >= 2) {
                showMessage("Room is full. Waiting for a spot...", true);
                
                const waitingListener = onSnapshot(roomRef, (snapshot) => {
                    const data = snapshot.data();
                    if (data && Object.keys(data.participants || {}).length < 2) {
                        waitingListener(); // Stop waiting
                        showMessage("A spot has opened up! Join now.");
                        ui.joinRoomBtn.disabled = false;
                        ui.createRoomBtn.disabled = false;
                    }
                });
                return;
            }

            isCreator = false;
            ui.hostControls.style.display = 'none';
            ui.participantsList.style.display = 'block';
            ui.hangupBtn.disabled = false;
            ui.sendChatBtn.disabled = false;
            ui.toggleScreenShareBtn.disabled = false;

            showMessage(`Joining room: ${roomId}`);

            const stream = await getLocalStream();
            if (!stream) {
                 ui.joinRoomBtn.disabled = false;
                 ui.createRoomBtn.disabled = false;
                 return;
            }

            setupPeerConnection();
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

            const offer = roomSnapshot.data().offer;
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            await updateDoc(roomRef, { 
                answer: { sdp: answer.sdp, type: answer.type },
                [`participants.${userId}`]: username
            });

            showMessage(`Successfully joined room ${roomId}!`);
            
            // Set up listeners for the call
            listenForChat(roomRef);
            listenForParticipants();
            listenForLayouts();
        };
        
        const hangup = async () => {
            // Stop streams and close connections
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (screenStream) screenStream.getTracks().forEach(track => track.stop());
            
            // Clear video elements
            if (ui.localVideo) ui.localVideo.srcObject = null;
            if (ui.remoteVideo) ui.remoteVideo.srcObject = null;

            // Stop all listeners
            if (roomSnapshotListener) roomSnapshotListener();
            if (candidatesListener) candidatesListener();
            if (chatListener) chatListener();
            if (roomsListener) roomsListener();
            if (participantsListener) participantsListener();
            if (cleanupIntervalId) clearInterval(cleanupIntervalId);
            if (activeUsersListener) activeUsersListener();

            // Clean up room data if this is the last user
            if (roomRef) {
                const roomDoc = await getDoc(roomRef);
                if (roomDoc.exists()) {
                    const roomData = roomDoc.data();
                    const participants = roomData.participants || {};
                    const participantCount = Object.keys(participants).length;

                    if (participantCount === 1 && participants[userId]) {
                         // This user is the last one in the room, so delete it
                        try {
                            const messagesCollectionRef = collection(roomRef, 'chat-messages');
                            const messagesSnapshot = await getDocs(messagesCollectionRef);
                            messagesSnapshot.forEach(async (msgDoc) => await deleteDoc(doc(messagesCollectionRef, msgDoc.id)));
                            await deleteDoc(roomRef);
                        } catch (error) {
                            console.error("Error deleting room data:", error);
                        }
                    } else if (participants[userId]) {
                        // Not the last person, just remove this participant
                        await updateDoc(roomRef, { [`participants.${userId}`]: null });
                    }
                }
            }

            // Reset UI and state
            isCreator = false;
            screenStream = null;
            if (ui.hostControls) ui.hostControls.style.display = 'none';
            if (ui.participantsList) ui.participantsList.style.display = 'none';
            if (ui.roomIdInput) ui.roomIdInput.value = '';
            if (ui.hangupBtn) ui.hangupBtn.disabled = true;
            if (ui.toggleAudioBtn) ui.toggleAudioBtn.disabled = true;
            if (ui.toggleVideoBtn) ui.toggleVideoBtn.disabled = true;
            if (ui.sendChatBtn) ui.sendChatBtn.disabled = true;
            if (ui.chatInput) ui.chatInput.disabled = true;
            if (ui.chatContainer) ui.chatContainer.innerHTML = '';
            if (ui.toggleScreenShareBtn) ui.toggleScreenShareBtn.disabled = true;
            
            ui.createRoomBtn.disabled = false;
            ui.joinRoomBtn.disabled = false;
            
            showMessage("Call ended.");
        };

        // --- Stream Control Functions ---

        const toggleAudio = () => {
            if (localStream) {
                isMuted = !isMuted;
                localStream.getAudioTracks()[0].enabled = !isMuted;
                ui.toggleAudioBtn.innerHTML = `<i class="fas fa-${isMuted ? 'microphone-slash' : 'microphone'}"></i> ${isMuted ? "Unmute Audio" : "Mute Audio"}`;
                ui.toggleAudioBtn.classList.toggle('btn-toggle-active', !isMuted);
            }
        };

        const toggleVideo = () => {
            if (localStream) {
                isVideoOff = !isVideoOff;
                localStream.getVideoTracks()[0].enabled = !isVideoOff;
                ui.toggleVideoBtn.innerHTML = `<i class="fas fa-${isVideoOff ? 'video-slash' : 'video'}"></i> ${isVideoOff ? "Turn On Video" : "Turn Off Video"}`;
                ui.toggleVideoBtn.classList.toggle('btn-toggle-active', !isVideoOff);
            }
        };

        const toggleScreenShare = async () => {
            if (screenStream) {
                // Currently sharing, so stop
                stopScreenShare();
            } else {
                // Not sharing, so start
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true,
                        preferCurrentTab: true,
                    });
                    const screenTrack = screenStream.getVideoTracks()[0];
                    const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');

                    if (sender) {
                        sender.replaceTrack(screenTrack);
                    } else {
                        peerConnection.addTrack(screenTrack, screenStream);
                    }
                    
                    ui.toggleScreenShareBtn.innerHTML = `<i class="fas fa-video"></i> Stop Sharing`;
                    ui.toggleScreenShareBtn.classList.add('btn-danger');
                    ui.toggleScreenShareBtn.classList.remove('btn-toggle');
                    
                    screenTrack.onended = () => {
                        // This handles when the user stops sharing via the browser UI
                        stopScreenShare();
                    };

                } catch (error) {
                    console.error("Error starting screen share:", error);
                    showMessage("Failed to start screen share. Please check permissions or try again.", true);
                }
            }
        };

        const stopScreenShare = () => {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
                if (sender) {
                    sender.replaceTrack(videoTrack);
                }
            }
            
            ui.toggleScreenShareBtn.innerHTML = `<i class="fas fa-desktop"></i> Start Screen Share`;
            ui.toggleScreenShareBtn.classList.remove('btn-danger');
            ui.toggleScreenShareBtn.classList.add('btn-toggle');
        };

        // --- Host/Participant-specific Controls ---

        const spotlightParticipant = async (participantId) => {
            if (roomRef && isCreator) {
                const remoteStyles = { width: 100, height: 100, top: 0, left: 0, units: '%' };
                const localStyles = { width: 0, height: 0, top: 0, left: 0, units: '%' };
                await updateDoc(roomRef, { layout: { remote: remoteStyles, local: localStyles }, spotlight: participantId });
            }
        };
        
        const setupLayoutButtons = () => {
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const layout = btn.dataset.layout;
                    let remoteStyles = {};
                    let localStyles = { width: 150, height: 112.5, bottom: 1, right: 1, units: 'px' };

                    switch (layout) {
                        case 'full':
                            remoteStyles = { width: 100, height: 100, top: 0, left: 0, units: '%' };
                            localStyles = { width: 25, height: 25, bottom: 5, right: 5, units: '%' };
                            break;
                        case 'pip-bottom-right':
                            remoteStyles = { width: 100, height: 100, top: 0, left: 0, units: '%' };
                            localStyles = { width: 150, height: 112.5, bottom: 4, right: 4, units: 'px' };
                            break;
                        case 'side-by-side':
                            remoteStyles = { width: 50, height: 100, top: 0, left: 50, units: '%' };
                            localStyles = { width: 50, height: 100, top: 0, left: 0, units: '%' };
                            break;
                        case 'local-on-top':
                            remoteStyles = { width: 100, height: 100, top: 0, left: 0, units: '%' };
                            localStyles = { width: 100, height: 100, top: 0, left: 0, units: '%' };
                            break;
                    }
                    if (roomRef && isCreator) {
                        await updateDoc(roomRef, { layout: { remote: remoteStyles, local: localStyles } });
                    }
                });
            });
        };

        const listenForLayouts = () => {
            if (isCreator) return;
            onSnapshot(roomRef, (snapshot) => {
                const data = snapshot.data();
                if (data && data.layout) {
                    const { remote, local } = data.layout;
                    ui.remoteVideo.style.width = `${remote.width}${remote.units}`;
                    ui.remoteVideo.style.height = `${remote.height}${remote.units}`;
                    ui.remoteVideo.style.top = `${remote.top}${remote.units}`;
                    ui.remoteVideo.style.left = `${remote.left}${remote.units}`;
                    ui.localVideo.style.width = `${local.width}${local.units}`;
                    ui.localVideo.style.height = `${local.height}${local.units}`;
                    ui.localVideo.style.bottom = `${local.bottom}${local.units}`;
                    ui.localVideo.style.right = `${local.right}${local.units}`;
                }
            });
        };

        // --- Real-time Listeners ---

        const listenForActiveUsers = () => {
            if (activeUsersListener) activeUsersListener();
            ui.activeUsersPanel.style.display = 'block';

            const roomsCollectionRef = collection(db, `artifacts/${appId}/public/data/video-rooms`);
            activeUsersListener = onSnapshot(roomsCollectionRef, (snapshot) => {
                const activeUsers = new Set();
                snapshot.forEach(doc => {
                    const participants = doc.data().participants || {};
                    for (const id in participants) {
                        if (participants[id]) {
                            activeUsers.add(participants[id]);
                        }
                    }
                });

                ui.activeUsersList.innerHTML = '';
                if (activeUsers.size === 0) {
                    ui.activeUsersList.innerHTML = '<p class="text-gray-400 text-sm">No active users.</p>';
                } else {
                    activeUsers.forEach(user => {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'flex items-center justify-between p-2 bg-[#3c3836] rounded-lg mb-2';
                        userDiv.innerHTML = `<span>${user}</span>`;
                        ui.activeUsersList.appendChild(userDiv);
                    });
                }
            });
        };

        const listenForRooms = () => {
            if (roomsListener) {
                roomsListener();
            }
            const roomsCollectionRef = collection(db, `artifacts/${appId}/public/data/video-rooms`);
            roomsListener = onSnapshot(roomsCollectionRef, (snapshot) => {
                ui.activeRoomsList.innerHTML = '';
                if (snapshot.empty) {
                    ui.activeRoomsList.innerHTML = '<p class="text-gray-400 text-sm">No active rooms.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const roomData = doc.data();
                        const roomName = doc.id;
                        const roomDiv = document.createElement('div');
                        roomDiv.className = 'flex items-center justify-between p-2 bg-[#3c3836] rounded-lg hover:bg-[#504945] transition duration-150 cursor-pointer';
                        roomDiv.innerHTML = `
                            <div class="flex flex-col">
                                <span class="font-semibold text-sm">${roomName}</span>
                                <span class="text-xs text-gray-400">Host: ${roomData.createdByUsername}</span>
                            </div>
                            <button data-room-id="${roomName}" class="join-room-btn px-3 py-1 text-sm rounded-lg bg-[#b8bb26] text-[#1d2021] hover:bg-[#83a598] transition-colors duration-200">Join</button>
                        `;
                        ui.activeRoomsList.appendChild(roomDiv);
                    });
                    document.querySelectorAll('.join-room-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            ui.roomIdInput.value = e.target.dataset.roomId;
                            joinRoom();
                        });
                    });
                }
            });
        };
        
        const listenForParticipants = () => {
            if (participantsListener) participantsListener();
            ui.participantsList.style.display = 'block';

            participantsListener = onSnapshot(roomRef, (snapshot) => {
                const roomData = snapshot.data();
                if (!roomData || !roomData.participants) return;

                const currentParticipants = roomData.participants;
                const previousKeys = Object.keys(previousParticipants);
                const currentKeys = Object.keys(currentParticipants);

                currentKeys.forEach(id => {
                    if (!previousKeys.includes(id)) {
                        showMessage(`${currentParticipants[id]} joined the room.`);
                    }
                });

                previousKeys.forEach(id => {
                    if (!currentKeys.includes(id)) {
                        if (id !== userId) {
                           showMessage(`${previousParticipants[id]} left the room.`);
                        }
                    }
                });

                previousParticipants = currentParticipants;

                const participantsDiv = ui.participantsList.querySelector('div');
                participantsDiv.innerHTML = '';
                for (const id in currentParticipants) {
                    const participantDiv = document.createElement('div');
                    participantDiv.className = 'flex items-center justify-between p-2 bg-[#3c3836] rounded-lg mb-2';
                    participantDiv.innerHTML = `<span>${currentParticipants[id]} ${id === userId ? '(You)' : ''}</span>`;
                    
                    if (isCreator && id !== userId) {
                        const spotlightBtn = document.createElement('button');
                        spotlightBtn.className = 'btn-toggle rounded-lg ml-2';
                        spotlightBtn.innerHTML = '<i class="fas fa-video"></i> Spotlight';
                        spotlightBtn.onclick = () => spotlightParticipant(id);
                        participantDiv.appendChild(spotlightBtn);
                    }
                    
                    participantsDiv.appendChild(participantDiv);
                }
            });
        };

        // --- Chat Functions ---

        const sendMessage = async () => {
            const message = ui.chatInput.value.trim();
            if (message === "" || !roomRef) return;

            const chatMessagesRef = collection(roomRef, 'chat-messages');
            await addDoc(chatMessagesRef, {
                senderId: userId,
                senderUsername: username,
                text: message,
                timestamp: serverTimestamp()
            });
            ui.chatInput.value = '';
        };

        const listenForChat = (roomDocRef) => {
            if (chatListener) chatListener();
            const chatMessagesRef = collection(roomDocRef, 'chat-messages');
            chatListener = onSnapshot(chatMessagesRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const messageData = change.doc.data();
                        displayMessage(messageData);
                    }
                });
            }, (error) => {
                console.error("Error listening to chat messages:", error);
            });
        };

        const displayMessage = (messageData) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message rounded-xl ${messageData.senderId === userId ? 'my-message' : 'other-message'}`;
            messageDiv.innerHTML = `<span class="font-bold">${messageData.senderUsername}:</span> ${messageData.text}`;
            ui.chatContainer.appendChild(messageDiv);
            ui.chatContainer.scrollTop = ui.chatContainer.scrollHeight;
        };

        // --- Event Listeners ---
        
        window.onload = () => {
            initFirebase();
            initAudio();
        };

        ui.submitUsernameBtn.addEventListener('click', setUsername);
        ui.usernameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') setUsername();
        });

    </script>
</body>
</html>
