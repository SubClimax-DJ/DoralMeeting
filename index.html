<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Conference App</title>
    <style>
        :root {
            --primary-color: #dc322f; /* Crimson */
            --secondary-color: #002b36; /* Navy */
            --background-color: #1a1a1a; /* Black */
            --text-color: #b58900; /* Gruvbox yellowish */
            --accent-color: #839496; /* Silver */
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 2rem;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--secondary-color);
            border: 2px solid var(--primary-color);
            padding: 2rem;
            border-radius: 10px;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .section {
            display: none;
            flex-direction: column;
            gap: 1rem;
        }

        .section.active {
            display: flex;
        }

        h2, h3 {
            color: var(--primary-color);
            text-align: center;
        }
        
        h3 {
             border-bottom: 1px solid var(--accent-color);
             padding-bottom: 0.5rem;
             margin-top: 1rem;
        }

        input, button {
            background-color: var(--background-color);
            color: var(--text-color);
            border: 1px solid var(--accent-color);
            padding: 0.75rem;
            border-radius: 5px;
            outline: none;
        }

        button {
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--primary-color);
            color: var(--background-color);
        }

        .video-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        video {
            width: 100%;
            max-width: 350px;
            background-color: var(--background-color);
            border: 2px solid var(--accent-color);
            border-radius: 10px;
        }
        
        #local-video {
            transform: scaleX(-1);
        }

        #chat-box-container, #room-chat-box {
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        #lobby-chat-messages, #room-chat-messages {
            flex-grow: 1;
            border: 1px solid var(--accent-color);
            padding: 0.5rem;
            overflow-y: auto;
            background-color: var(--background-color);
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }

        #lobby-chat-form, #room-chat-form {
            display: flex;
            margin-top: 0.5rem;
            gap: 0.5rem;
        }

        #lobby-chat-form input, #room-chat-form input {
            flex-grow: 1;
        }
        
        #user-list-container {
            flex-grow: 1;
        }
        
        #online-users-list {
            list-style-type: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        #online-users-list li {
            background-color: var(--background-color);
            padding: 0.75rem;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #online-users-list button {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="login-section" class="section active">
            <h2>Login</h2>
            <form id="login-form">
                <input type="text" id="username-input" placeholder="Enter username" required>
                <button type="submit">Join Lobby</button>
            </form>
        </div>

        <!-- Lobby Section -->
        <div id="lobby-section" class="section">
            <h2>Lobby</h2>
            <div id="user-list-container">
                <h3>Online Users</h3>
                <ul id="online-users-list"></ul>
            </div>
            <div id="chat-box-container">
                <h3>Lobby Chat</h3>
                <div id="lobby-chat-messages"></div>
                <form id="lobby-chat-form">
                    <input type="text" id="lobby-message-input" placeholder="Type a message..." required>
                    <button type="submit">Send</button>
                </form>
            </div>
            <button id="create-room-btn">Create a New Room</button>
        </div>

        <!-- Room Section -->
        <div id="room-section" class="section">
            <h2 id="room-title">Room</h2>
            <div class="video-container">
                <video id="local-video" autoplay playsinline muted></video>
                <video id="remote-video" autoplay playsinline></video>
            </div>
            <div class="controls">
                <button id="hangup-btn">Leave Room</button>
                <button id="toggle-audio-btn">Mute</button>
                <button id="toggle-video-btn">Hide Video</button>
            </div>
            <div id="room-chat-box">
                <h3>Room Chat</h3>
                <div id="room-chat-messages"></div>
                <form id="room-chat-form">
                    <input type="text" id="room-message-input" placeholder="Type a message..." required>
                    <button type="submit">Send</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <!-- WebRTC Adapter for cross-browser compatibility -->
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBluS1Dl9abDJjPPeOhvTCfP8J1kyIh6BQ",
            authDomain: "video-meeting-e73eb.firebaseapp.com",
            projectId: "video-meeting-e73eb",
            storageBucket: "video-meeting-e73eb.firebasestorage.app",
            messagingSenderId: "80496795033",
            appId: "1:80496795033:web:3ac35c631d76301f77c708",
            measurementId: "G-SFPQ0PJRPG"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const loginSection = document.getElementById('login-section');
        const lobbySection = document.getElementById('lobby-section');
        const roomSection = document.getElementById('room-section');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username-input');
        const onlineUsersList = document.getElementById('online-users-list');
        const createRoomBtn = document.getElementById('create-room-btn');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const hangupBtn = document.getElementById('hangup-btn');
        const toggleAudioBtn = document.getElementById('toggle-audio-btn');
        const toggleVideoBtn = document.getElementById('toggle-video-btn');
        const lobbyChatForm = document.getElementById('lobby-chat-form');
        const lobbyMessageInput = document.getElementById('lobby-message-input');
        const lobbyChatMessages = document.getElementById('lobby-chat-messages');
        const roomChatForm = document.getElementById('room-chat-form');
        const roomMessageInput = document.getElementById('room-message-input');
        const roomChatMessages = document.getElementById('room-chat-messages');
        const roomTitle = document.getElementById('room-title');

        // Global variables
        let currentUser = null;
        let currentRoomId = null;
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;

        // Firebase Firestore references
        const publicDataRef = db.collection('artifacts').doc(firebaseConfig.appId).collection('public').doc('data');
        const roomsRef = publicDataRef.collection('video-rooms');
        const usersRef = publicDataRef.collection('users');
        const chatRef = publicDataRef.collection('chat');
        
        /**
         * UTILITY FUNCTIONS
         */
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            section.classList.add('active');
        }

        function addChatMessage(message, sender, container) {
            const p = document.createElement('p');
            p.innerHTML = `<strong>${sender}:</strong> ${message}`;
            container.appendChild(p);
            container.scrollTop = container.scrollHeight;
        }

        /**
         * AUTHENTICATION AND LOBBY LOGIC
         */
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            if (username) {
                try {
                    // Sign in anonymously to get a UID
                    const userCredential = await auth.signInAnonymously();
                    currentUser = userCredential.user;
                    await usersRef.doc(currentUser.uid).set({
                        username: username,
                        status: 'online',
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showSection(lobbySection);
                    listenForOnlineUsers();
                    listenForLobbyChat();
                } catch (error) {
                    console.error("Login failed:", error);
                    alert("Could not log in. Please try again.");
                }
            }
        });

        function listenForOnlineUsers() {
            usersRef.where('status', '==', 'online').onSnapshot(snapshot => {
                onlineUsersList.innerHTML = '';
                snapshot.forEach(doc => {
                    if (doc.id !== currentUser.uid) {
                        const user = doc.data();
                        const li = document.createElement('li');
                        li.innerHTML = `
                            ${user.username} <button data-user-id="${doc.id}">Call</button>
                        `;
                        onlineUsersList.appendChild(li);
                    }
                });
            });
        }

        function listenForLobbyChat() {
            chatRef.orderBy('timestamp').onSnapshot(snapshot => {
                lobbyChatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const message = doc.data();
                    addChatMessage(message.text, message.senderUsername, lobbyChatMessages);
                });
            });
        }

        lobbyChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = lobbyMessageInput.value.trim();
            if (message && currentUser) {
                await chatRef.add({
                    text: message,
                    senderId: currentUser.uid,
                    senderUsername: (await usersRef.doc(currentUser.uid).get()).data().username,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                lobbyMessageInput.value = '';
            }
        });

        createRoomBtn.addEventListener('click', async () => {
            const newRoomRef = roomsRef.doc();
            const username = (await usersRef.doc(currentUser.uid).get()).data().username;
            currentRoomId = newRoomRef.id;
            await newRoomRef.set({
                createdBy: currentUser.uid,
                createdByUsername: username,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                participants: {
                    [currentUser.uid]: {
                        username: username,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }
                }
            });
            roomTitle.innerText = `Room: ${currentRoomId}`;
            await startVideoCall();
        });

        // Event listener for calling other users
        onlineUsersList.addEventListener('click', async (e) => {
            if (e.target.tagName === 'BUTTON') {
                const userId = e.target.dataset.userId;
                const newRoomRef = roomsRef.doc();
                const username = (await usersRef.doc(currentUser.uid).get()).data().username;
                const targetUsername = (await usersRef.doc(userId).get()).data().username;

                currentRoomId = newRoomRef.id;
                await newRoomRef.set({
                    createdBy: currentUser.uid,
                    createdByUsername: username,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    participants: {
                        [currentUser.uid]: { username: username, joinedAt: firebase.firestore.FieldValue.serverTimestamp() },
                        [userId]: { username: targetUsername, joinedAt: firebase.firestore.FieldValue.serverTimestamp() }
                    }
                });
                roomTitle.innerText = `Room: ${currentRoomId}`;
                await startVideoCall();
            }
        });

        /**
         * WEBRTC VIDEO CALL LOGIC
         */
        const servers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
            ],
        };

        async function startVideoCall() {
            showSection(roomSection);

            // Get local media stream
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;

            // Create RTCPeerConnection
            peerConnection = new RTCPeerConnection(servers);

            // Add local tracks to peer connection
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Handle remote tracks
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                remoteVideo.srcObject = remoteStream;
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    await roomsRef.doc(currentRoomId).collection('candidates').add({
                        candidate: event.candidate.toJSON(),
                        sender: currentUser.uid
                    });
                }
            };

            // Listen for room updates (for joining)
            roomsRef.doc(currentRoomId).onSnapshot(async (snapshot) => {
                const room = snapshot.data();
                if (room) {
                    const offer = room.offer;
                    const answer = room.answer;

                    // If an offer exists and we are not the one who created it
                    if (offer && offer.uid !== currentUser.uid && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer.sdp));
                        const answerSdp = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answerSdp);
                        await roomsRef.doc(currentRoomId).update({
                            answer: { sdp: answerSdp, uid: currentUser.uid }
                        });
                    } else if (answer && answer.uid !== currentUser.uid && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer.sdp));
                    }
                }
            });

            // Listen for new candidates
            roomsRef.doc(currentRoomId).collection('candidates').onSnapshot(async (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const candidate = change.doc.data().candidate;
                        if (change.doc.data().sender !== currentUser.uid) {
                            peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                        }
                    }
                });
            });

            // If we are the creator, create the offer
            const roomDoc = await roomsRef.doc(currentRoomId).get();
            if (roomDoc.data().createdBy === currentUser.uid) {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                await roomsRef.doc(currentRoomId).update({
                    offer: { sdp: offer, uid: currentUser.uid }
                });
            }

            // Listen for room chat messages
            roomsRef.doc(currentRoomId).collection('chat-messages').orderBy('timestamp').onSnapshot(snapshot => {
                roomChatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const message = doc.data();
                    addChatMessage(message.text, message.senderUsername, roomChatMessages);
                });
            });
        }

        roomChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = roomMessageInput.value.trim();
            if (message && currentUser && currentRoomId) {
                await roomsRef.doc(currentRoomId).collection('chat-messages').add({
                    text: message,
                    senderId: currentUser.uid,
                    senderUsername: (await usersRef.doc(currentUser.uid).get()).data().username,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                roomMessageInput.value = '';
            }
        });

        hangupBtn.addEventListener('click', async () => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localVideo.srcObject = null;
            }
            if (remoteStream) {
                remoteVideo.srcObject = null;
            }

            // Clean up from Firestore
            await roomsRef.doc(currentRoomId).delete();
            currentRoomId = null;

            showSection(lobbySection);
        });

        toggleAudioBtn.addEventListener('click', () => {
            const audioTrack = localStream.getTracks().find(track => track.kind === 'audio');
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                toggleAudioBtn.innerText = audioTrack.enabled ? 'Mute' : 'Unmute';
            }
        });

        toggleVideoBtn.addEventListener('click', () => {
            const videoTrack = localStream.getTracks().find(track => track.kind === 'video');
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                toggleVideoBtn.innerText = videoTrack.enabled ? 'Hide Video' : 'Show Video';
            }
        });

        // Handle user disconnect
        window.addEventListener('beforeunload', async () => {
            if (currentUser) {
                await usersRef.doc(currentUser.uid).update({ status: 'offline' });
            }
        });

    </script>
</body>
</html>
