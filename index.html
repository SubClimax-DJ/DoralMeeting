<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Screen Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Gruvbox Dark Theme Colors */
        :root {
            --bg: #282828;
            --bg-alt: #3c3836;
            --fg: #ebdbb2;
            --gray: #928374;
            --red: #fb4934;
            --green: #b8bb26;
            --yellow: #fabd2f;
            --blue: #83a598;
            --purple: #d3869b;
            --aqua: #8ec07c;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--fg);
        }
        .video-placeholder {
            background-color: var(--bg);
            border: 2px dashed var(--bg-alt);
        }
        #remoteScreen {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .lds-ring {
          display: inline-block;
          position: relative;
          width: 80px;
          height: 80px;
        }
        .lds-ring div {
          box-sizing: border-box;
          display: block;
          position: absolute;
          width: 64px;
          height: 64px;
          margin: 8px;
          border: 8px solid var(--fg);
          border-radius: 50%;
          animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
          border-color: var(--fg) transparent transparent transparent;
        }
        .lds-ring div:nth-child(1) { animation-delay: -0.45s; }
        .lds-ring div:nth-child(2) { animation-delay: -0.3s; }
        .lds-ring div:nth-child(3) { animation-delay: -0.15s; }
        @keyframes lds-ring {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <div class="w-full max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-2 text-aqua" style="color: var(--aqua);">Simple Screen Share</h1>
        <p class="text-center mb-6" style="color: var(--gray);">Share your screen with another person using a Room ID.</p>

        <!-- Room Connection UI -->
        <div id="room-ui" class="p-6 rounded-lg shadow-xl mb-6 flex flex-col items-center justify-center gap-4" style="background-color: var(--bg-alt);">
            <p id="auth-status" class="font-mono text-center mb-2" style="color: var(--yellow);">Authenticating...</p>
            <button id="createRoomBtn" disabled class="w-full sm:w-auto text-white font-bold py-3 px-6 rounded-lg transition-colors opacity-50 cursor-not-allowed" style="background-color: var(--blue);">Create Room</button>
            <div class="font-mono text-center my-2 sm:my-0" style="color: var(--gray);">OR</div>
            <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                <input type="text" id="roomIdInput" placeholder="Enter Room ID to Join" class="w-full sm:w-64 text-white border rounded-lg px-4 py-3 focus:outline-none focus:ring-2" style="background-color: var(--bg); border-color: #504945; --tw-ring-color: var(--aqua);">
                <button id="joinRoomBtn" disabled class="text-black font-bold py-3 px-6 rounded-lg transition-colors opacity-50 cursor-not-allowed" style="background-color: var(--green);">Join Room</button>
            </div>
             <!-- Available Rooms List -->
            <div id="room-list-container" class="w-full mt-4 pt-4 border-t" style="border-color: #504945;">
                <h3 class="text-lg font-semibold text-center mb-2" style="color: var(--fg);">Available Rooms</h3>
                <div id="room-list" class="max-h-40 overflow-y-auto space-y-2">
                    <p id="no-rooms-msg" class="text-center" style="color: var(--gray);">No active rooms found.</p>
                </div>
            </div>
        </div>

        <!-- Info and Controls -->
        <div id="session-info" class="hidden text-center mb-4 p-4 rounded-lg" style="background-color: var(--bg-alt);">
            <p style="color: var(--gray);">Your User ID: <span id="userId" class="font-mono" style="color: var(--fg);"></span></p>
            <p style="color: var(--green);">Connected to Room: <span id="roomIdDisplay" class="font-mono" style="color: var(--aqua);"></span></p>
            <div id="error-message" class="my-2 font-semibold" style="color: var(--red);"></div>
            <div id="controls" class="mt-4 flex justify-center gap-4">
                <button id="startShareBtn" class="text-white font-bold py-2 px-5 rounded-lg transition-colors" style="background-color: var(--blue);">Start Sharing</button>
                <button id="stopShareBtn" class="hidden text-white font-bold py-2 px-5 rounded-lg transition-colors" style="background-color: var(--red);">Stop Sharing</button>
            </div>
        </div>

        <!-- Screen Display Area -->
        <div class="w-full grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Remote Screen -->
            <div class="rounded-lg shadow-xl p-4 flex flex-col items-center justify-center aspect-video" style="background-color: var(--bg-alt);">
                <h2 class="text-lg font-semibold mb-2" style="color: var(--gray);">Remote Screen</h2>
                <div id="remoteScreenContainer" class="w-full h-full flex items-center justify-center video-placeholder rounded-md">
                     <div id="waiting-message" style="color: var(--gray);">Waiting for other user to share...</div>
                     <div id="loading-spinner" class="hidden lds-ring"><div></div><div></div><div></div><div></div></div>
                     <img id="remoteScreen" class="hidden rounded-md"/>
                </div>
            </div>
            <!-- Local Preview -->
            <div class="rounded-lg shadow-xl p-4 flex flex-col items-center justify-center aspect-video" style="background-color: var(--bg-alt);">
                <h2 class="text-lg font-semibold mb-2" style="color: var(--gray);">Your Preview</h2>
                <div class="w-full h-full flex items-center justify-center video-placeholder rounded-md">
                    <video id="localVideo" class="rounded-md" autoplay muted playsinline style="max-width: 100%; max-height:100%"></video>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, serverTimestamp, collection, query, getDocs, deleteDoc, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        } catch (e) {
            console.error("Firebase config parsing error:", e);
            firebaseConfig = { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- DOM Elements ---
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const roomIdInput = document.getElementById('roomIdInput');
        const startShareBtn = document.getElementById('startShareBtn');
        const stopShareBtn = document.getElementById('stopShareBtn');
        const localVideo = document.getElementById('localVideo');
        const remoteScreen = document.getElementById('remoteScreen');
        const roomUi = document.getElementById('room-ui');
        const sessionInfo = document.getElementById('session-info');
        const roomIdDisplay = document.getElementById('roomIdDisplay');
        const userIdDisplay = document.getElementById('userId');
        const remoteScreenContainer = document.getElementById('remoteScreenContainer');
        const waitingMessage = document.getElementById('waiting-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const roomList = document.getElementById('room-list');
        const noRoomsMsg = document.getElementById('no-rooms-msg');
        const authStatus = document.getElementById('auth-status');
        const errorMessage = document.getElementById('error-message');

        // --- App State ---
        let currentRoomId = null;
        let userId = null;
        let localStream = null;
        let captureInterval = null;
        let firestoreUnsubscribe = null;
        const ROOM_COLLECTION = `artifacts/${appId}/public/data/screenshare`;

        // --- Core Functions ---
        async function initializeAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                userIdDisplay.textContent = userId;

                // Enable controls on successful auth
                createRoomBtn.disabled = false;
                joinRoomBtn.disabled = false;
                createRoomBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                createRoomBtn.style.backgroundColor = 'var(--blue)';
                joinRoomBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                joinRoomBtn.style.backgroundColor = 'var(--green)';
                authStatus.textContent = 'Ready to connect!';
                authStatus.style.color = 'var(--green)';
                setTimeout(() => { authStatus.classList.add('hidden'); }, 3000);
                
                // Once authenticated, start services
                listenToAvailableRooms();
                autoDeleteStaleRooms();
            } catch (error) {
                console.error("Authentication failed:", error);
                userIdDisplay.textContent = "Error: Could not authenticate.";
                authStatus.textContent = 'Authentication failed. Please refresh.';
                authStatus.style.color = 'var(--red)';
            }
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        async function createRoom() {
            if (!userId) {
                console.error("Authentication not complete. Create button should be disabled.");
                return;
            }
            const newRoomId = generateRoomId();
            const roomRef = doc(db, ROOM_COLLECTION, newRoomId);
            const now = serverTimestamp();
            await setDoc(roomRef, {
                createdAt: now,
                lastActivity: now,
                sharerId: null,
                frame: null,
            });
            joinRoom(newRoomId);
        }

        async function joinRoom(roomIdToJoin) {
            if (!roomIdToJoin) {
                alert("Please enter a Room ID.");
                return;
            }
            const roomRef = doc(db, ROOM_COLLECTION, roomIdToJoin);
            const roomSnap = await getDoc(roomRef);

            if (!roomSnap.exists()) {
                alert("Room not found. Please check the ID or it may have been deleted.");
                return;
            }

            currentRoomId = roomIdToJoin;
            roomUi.classList.add('hidden');
            sessionInfo.classList.remove('hidden');
            roomIdDisplay.textContent = currentRoomId;

            listenToRoomChanges();
        }

        function listenToRoomChanges() {
            if (firestoreUnsubscribe) firestoreUnsubscribe();
            const roomRef = doc(db, ROOM_COLLECTION, currentRoomId);
            
            firestoreUnsubscribe = onSnapshot(roomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const frameData = data.frame;
                    const sharerId = data.sharerId;

                    if (frameData && sharerId !== userId) {
                        waitingMessage.classList.add('hidden');
                        loadingSpinner.classList.add('hidden');
                        remoteScreen.classList.remove('hidden');
                        remoteScreen.src = frameData;
                    } else if (!frameData) {
                         waitingMessage.classList.remove('hidden');
                         remoteScreen.classList.add('hidden');
                    }
                } else {
                    // Room was deleted
                    alert("The room has been closed.");
                    window.location.reload();
                }
            });
        }

        function listenToAvailableRooms() {
            const roomsRef = collection(db, ROOM_COLLECTION);
            onSnapshot(query(roomsRef), (snapshot) => {
                roomList.innerHTML = ''; // Clear current list
                if (snapshot.empty) {
                    roomList.appendChild(noRoomsMsg);
                } else {
                    snapshot.forEach((doc) => {
                        const roomEl = document.createElement('button');
                        roomEl.className = 'w-full text-left p-2 rounded-md transition-colors';
                        roomEl.style.backgroundColor = 'var(--bg)';
                        roomEl.textContent = `Room: ${doc.id}`;
                        roomEl.onmouseover = () => roomEl.style.backgroundColor = 'var(--aqua)';
                        roomEl.onmouseout = () => roomEl.style.backgroundColor = 'var(--bg)';
                        roomEl.onclick = () => joinRoom(doc.id);
                        roomList.appendChild(roomEl);
                    });
                }
            });
        }

        async function autoDeleteStaleRooms() {
            const roomsRef = collection(db, ROOM_COLLECTION);
            const twoMinutesAgo = Timestamp.fromMillis(Date.now() - 2 * 60 * 1000);
            const q = query(roomsRef, where("lastActivity", "<", twoMinutesAgo));

            const snapshot = await getDocs(q);
            snapshot.forEach(async (document) => {
                console.log(`Deleting stale room: ${document.id}`);
                await deleteDoc(doc(db, ROOM_COLLECTION, document.id));
            });
        }

        async function startSharing() {
            try {
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "always" },
                    audio: false
                });
                localVideo.srcObject = localStream;
                startShareBtn.classList.add('hidden');
                stopShareBtn.classList.remove('hidden');

                const roomRef = doc(db, ROOM_COLLECTION, currentRoomId);
                await updateDoc(roomRef, { sharerId: userId, lastActivity: serverTimestamp() });

                // Start capturing frames
                captureInterval = setInterval(captureAndSendFrame, 750); // ~1.3 FPS

            } catch (err) {
                console.error("Error starting screen share:", err);
                errorMessage.textContent = "Could not start screen share. Please grant permission and try again.";
                setTimeout(() => { errorMessage.textContent = ''; }, 5000);
                stopSharing();
            }
        }

        function stopSharing() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }
            localStream = null;
            localVideo.srcObject = null;
            startShareBtn.classList.remove('hidden');
            stopShareBtn.classList.add('hidden');

            const roomRef = doc(db, ROOM_COLLECTION, currentRoomId);
            updateDoc(roomRef, { frame: null, sharerId: null, lastActivity: serverTimestamp() });
        }
        
        function captureAndSendFrame() {
            if (!localStream || !localStream.active || localVideo.paused || localVideo.ended || localVideo.videoWidth === 0) {
                stopSharing();
                return;
            }
            
            try {
                const canvas = document.createElement('canvas');
                // Reduce resolution for performance
                const scale = 0.5; 
                canvas.width = localVideo.videoWidth * scale;
                canvas.height = localVideo.videoHeight * scale;

                const ctx = canvas.getContext('2d');
                // Draw the current frame from the <video> element onto the canvas
                ctx.drawImage(localVideo, 0, 0, canvas.width, canvas.height);
                
                const dataUrl = canvas.toDataURL('image/jpeg', 0.4); 

                const roomRef = doc(db, ROOM_COLLECTION, currentRoomId);
                updateDoc(roomRef, { frame: dataUrl, lastActivity: serverTimestamp() });
            } catch (error) {
                console.error('Frame capture error: ', error);
            }
        }


        // --- Event Listeners ---
        createRoomBtn.addEventListener('click', createRoom);
        joinRoomBtn.addEventListener('click', () => joinRoom(roomIdInput.value.trim()));
        startShareBtn.addEventListener('click', startSharing);
        stopShareBtn.addEventListener('click', stopSharing);

        // --- Initialization ---
        initializeAuth();

    </script>
</body>
</html>

