import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, addDoc, getDoc, updateDoc, deleteDoc } from 'firebase/firestore';
import { getDatabase, ref, onValue, set, push, remove, off } from 'firebase/database';

const App = () => {
  // Global Firebase variables provided by the environment
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    apiKey: "AIzaSyBbTFLhxzXf08OVDGGsK54t3qDzPVvsJ3w",
    authDomain: "conferencedoral.firebaseapp.com",
    projectId: "conferencedoral",
    storageBucket: "conferencedoral.firebasestorage.app",
    messagingSenderId: "668062587354",
    appId: "1:668062587354:web:9b831842ada6ebf87148e3",
    measurementId: "G-HDJ9S9G2T2"
  };
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // State management
  const [view, setView] = useState('login'); // login, lobby, call
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [user, setUser] = useState(null);
  const [messages, setMessages] = useState([]);
  const [newMessage, setNewMessage] = useState('');
  const [users, setUsers] = useState([]);
  const [otherUser, setOtherUser] = useState(null);
  const [messageBox, setMessageBox] = useState({ visible: false, text: '' });
  const [isMuted, setIsMuted] = useState(false);
  const [isCameraOff, setIsCameraOff] = useState(false);
  const [isCallInitiator, setIsCallInitiator] = useState(false);

  // Refs for video elements and WebRTC
  const localVideoRef = useRef(null);
  const remoteVideoRef = useRef(null);
  const peerConnectionRef = useRef(null);
  const localStreamRef = useRef(null);
  const dbRef = useRef(null);
  const rtdbRef = useRef(null);

  // Gruvbox color palette for Tailwind CSS
  const colors = {
    'bg-dark': '#282828',
    'bg-light': '#3c3836',
    'fg-dark': '#ebdbb2',
    'red': '#cc241d',
    'green': '#98971a',
    'yellow': '#d79921',
    'blue': '#458588',
    'purple': '#b16286',
    'aqua': '#689d6a',
    'orange': '#d65d0e',
  };

  // Firebase Initialization and Authentication
  useEffect(() => {
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    dbRef.current = db;
    rtdbRef.current = rtdb;

    // Use the provided auth token if available, otherwise sign in anonymously
    const authenticate = async () => {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Firebase auth error:", error);
      }
    };

    onAuthStateChanged(auth, async (currentUser) => {
      if (currentUser) {
        setUser(currentUser);
        setIsAuthReady(true);
        // Set user presence using the currentUser.uid provided by auth
        await setDoc(doc(db, `artifacts/${appId}/public/data/users`, currentUser.uid), {
          uid: currentUser.uid,
          username: `guest-${currentUser.uid.substring(0, 5)}`,
          lastSeen: Date.now(),
        }, { merge: true });
      } else {
        setIsAuthReady(true);
      }
    });

    authenticate();

    // Cleanup on unmount
    return () => {
      if (user && dbRef.current) {
        setDoc(doc(dbRef.current, `artifacts/${appId}/public/data/users`, user.uid), {
          uid: user.uid,
          lastSeen: Date.now(),
          offline: true,
        }, { merge: true });
      }
    };
  }, []);

  // Set up Firestore listeners for lobby
  useEffect(() => {
    if (!isAuthReady || !user) return;

    // Listen for messages
    const messagesQuery = query(collection(dbRef.current, `artifacts/${appId}/public/data/messages`), orderBy('timestamp'));
    const unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
      const msgs = snapshot.docs.map(doc => doc.data());
      setMessages(msgs);
    }, (error) => { console.error("Error fetching messages:", error); });

    // Listen for users
    const usersQuery = query(collection(dbRef.current, `artifacts/${appId}/public/data/users`), orderBy('username'));
    const unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
      const currentUsers = snapshot.docs.map(doc => doc.data()).filter(u => !u.offline);
      setUsers(currentUsers);
    }, (error) => { console.error("Error fetching users:", error); });

    return () => {
      unsubscribeMessages();
      unsubscribeUsers();
    };
  }, [isAuthReady, user, appId]);

  // Handle WebRTC signaling
  useEffect(() => {
    if (!isAuthReady || !user || view !== 'call' || !peerConnectionRef.current || !rtdbRef.current) return;

    const callRef = ref(rtdbRef.current, `artifacts/${appId}/calls/${user.uid}`);

    const unsubscribeSignaling = onValue(callRef, async (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      try {
        if (data.offer && !peerConnectionRef.current.currentRemoteDescription) {
          await peerConnectionRef.current.setRemoteDescription(new RTCSessionDescription(data.offer));
          const answer = await peerConnectionRef.current.createAnswer();
          await peerConnectionRef.current.setLocalDescription(answer);
          set(callRef, {
            answer: peerConnectionRef.current.localDescription
          });
          console.log("WebRTC: Answer sent.");
        } else if (data.answer && !isCallInitiator && !peerConnectionRef.current.currentRemoteDescription) {
          await peerConnectionRef.current.setRemoteDescription(new RTCSessionDescription(data.answer));
          console.log("WebRTC: Answer received and set.");
        }
        
        // Handle ICE candidates
        if (data.candidates) {
          const newCandidates = Object.values(data.candidates).filter(c => c.from !== user.uid);
          for (const candidate of newCandidates) {
            await peerConnectionRef.current.addIceCandidate(new RTCIceCandidate(candidate.candidate));
          }
        }

      } catch (error) {
        console.error("WebRTC Signaling Error:", error);
      }
    });

    return () => {
      off(callRef, 'value', unsubscribeSignaling);
      // Clean up the call in Realtime Database when the call ends.
      if (isCallInitiator) {
        remove(callRef);
      }
    };
  }, [view, isAuthReady, user, isCallInitiator, appId]);

  // Utility to show temporary messages
  const showMessageBox = (text) => {
    setMessageBox({ visible: true, text });
    setTimeout(() => {
      setMessageBox({ visible: false, text: '' });
    }, 3000);
  };

  // Login handler
  const handleLogin = async (e) => {
    e.preventDefault();
    if (username.trim() === '') {
      showMessageBox('Username cannot be empty.');
      return;
    }

    if (!user || !dbRef.current) {
      showMessageBox('Application is still initializing. Please wait a moment.');
      return;
    }

    if (username === 'admin' && password !== 'max') {
      showMessageBox('Incorrect password.');
      return;
    }

    // Update user presence with the entered username
    await setDoc(doc(dbRef.current, `artifacts/${appId}/public/data/users`, user.uid), {
      username: username,
      uid: user.uid,
      lastSeen: Date.now(),
      offline: false
    }, { merge: true });

    setView('lobby');
  };

  // Send message to the chat
  const handleSendMessage = async (e) => {
    e.preventDefault();
    if (newMessage.trim() === '' || !dbRef.current) return;

    await addDoc(collection(dbRef.current, `artifacts/${appId}/public/data/messages`), {
      text: newMessage,
      sender: username,
      timestamp: Date.now(),
    });
    setNewMessage('');
  };

  // WebRTC Setup
  const setupWebRTC = async (targetUser) => {
    if (!user || !rtdbRef.current) {
        showMessageBox("Firebase is not ready. Please try again.");
        return null;
    }

    setOtherUser(targetUser);
    setView('call');

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideoRef.current.srcObject = stream;
      localStreamRef.current = stream;

      const servers = {
        iceServers: [
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: 'stun:stun2.l.google.com:19302' },
        ],
        iceCandidatePoolSize: 10,
      };

      const peer = new RTCPeerConnection(servers);
      peerConnectionRef.current = peer;

      stream.getTracks().forEach(track => {
        peer.addTrack(track, stream);
      });

      peer.ontrack = (event) => {
        if (remoteVideoRef.current) {
          remoteVideoRef.current.srcObject = event.streams[0];
        }
      };

      // Collect ICE candidates and send to Realtime Database
      peer.onicecandidate = async (event) => {
        if (event.candidate && rtdbRef.current) {
          const candidateData = {
            candidate: event.candidate.toJSON(),
            from: user.uid
          };
          const callRef = ref(rtdbRef.current, `artifacts/${appId}/calls/${targetUser.uid}/candidates`);
          push(callRef, candidateData);
        }
      };

      return peer;
    } catch (error) {
      console.error("Error setting up WebRTC:", error);
      showMessageBox('Could not access camera/mic. Please check permissions.');
      return null;
    }
  };

  // Initiate a call as the admin
  const handleStartCall = async (targetUser) => {
    setIsCallInitiator(true);
    const peer = await setupWebRTC(targetUser);
    if (!peer) return;

    try {
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);

      const callRef = ref(rtdbRef.current, `artifacts/${appId}/calls/${targetUser.uid}`);
      await set(callRef, {
        offer: {
          sdp: peer.localDescription.sdp,
          type: peer.localDescription.type
        },
        initiator: user.uid,
        target: targetUser.uid
      });
      showMessageBox(`Calling ${targetUser.username}...`);
    } catch (error) {
      console.error("Error creating and sending offer:", error);
      showMessageBox('Failed to initiate call.');
    }
  };

  // End the call and return to lobby
  const handleEndCall = () => {
    if (peerConnectionRef.current) {
      peerConnectionRef.current.close();
      peerConnectionRef.current = null;
    }
    if (localStreamRef.current) {
      localStreamRef.current.getTracks().forEach(track => track.stop());
    }
    setView('lobby');
    setOtherUser(null);
    setIsCallInitiator(false);
  };

  // Toggle microphone
  const toggleMute = () => {
    if (localStreamRef.current) {
      localStreamRef.current.getAudioTracks().forEach(track => {
        track.enabled = !isMuted;
      });
      setIsMuted(!isMuted);
    }
  };

  // Toggle camera
  const toggleCamera = () => {
    if (localStreamRef.current) {
      localStreamRef.current.getVideoTracks().forEach(track => {
        track.enabled = !isCameraOff;
      });
      setIsCameraOff(!isCameraOff);
    }
  };

  // Render different views based on state
  const renderView = () => {
    if (messageBox.visible) {
      return (
        <div className={`fixed inset-0 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 z-50`}>
          <div className={`p-4 rounded-xl shadow-lg text-${colors['fg-dark']} bg-${colors['bg-light']}`}>
            {messageBox.text}
          </div>
        </div>
      );
    }

    if (!isAuthReady) {
      return (
        <div className={`flex flex-col items-center justify-center min-h-screen bg-${colors['bg-dark']} text-${colors['fg-dark']}`}>
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div>
          <p className="mt-4">Initializing...</p>
        </div>
      );
    }

    switch (view) {
      case 'login':
        return (
          <div className={`min-h-screen flex items-center justify-center p-4 bg-${colors['bg-dark']}`}>
            <form onSubmit={handleLogin} className={`w-full max-w-sm p-8 rounded-xl shadow-lg bg-${colors['bg-light']} text-${colors['fg-dark']} border border-${colors['blue']}`}>
              <div className="flex justify-center mb-6">
                 <img src="https://content.enrollmystudent.org/contact_school_logo/school_logo_1655490559.jpg" alt="Company Logo" className="w-24 h-24 rounded-full" />
              </div>
              <h1 className={`text-2xl font-bold text-center mb-6 text-${colors['orange']}`}>Join Conference</h1>
              <div className="mb-4">
                <label className="block mb-2 font-medium" htmlFor="username">Username</label>
                <input
                  id="username"
                  type="text"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  className={`w-full px-4 py-2 rounded-lg bg-gray-700 border border-${colors['bg-light']} text-${colors['fg-dark']} focus:outline-none focus:ring-2 focus:ring-${colors['yellow']}`}
                  required
                />
              </div>
              {username === 'admin' && (
                <div className="mb-6">
                  <label className="block mb-2 font-medium" htmlFor="password">Password</label>
                  <input
                    id="password"
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className={`w-full px-4 py-2 rounded-lg bg-gray-700 border border-${colors['bg-light']} text-${colors['fg-dark']} focus:outline-none focus:ring-2 focus:ring-${colors['yellow']}`}
                    required
                  />
                </div>
              )}
              <button
                type="submit"
                className={`w-full py-2 px-4 rounded-lg bg-${colors['green']} hover:bg-${colors['aqua']} transition-colors text-${colors['bg-dark']} font-bold focus:outline-none focus:ring-2 focus:ring-${colors['green']}`}
              >
                Join Lobby
              </button>
            </form>
          </div>
        );
      case 'lobby':
        return (
          <div className={`min-h-screen flex flex-col md:flex-row p-4 bg-${colors['bg-dark']} text-${colors['fg-dark']}`}>
            <div className="flex-1 flex flex-col bg-gray-800 p-6 rounded-xl shadow-lg mb-4 md:mb-0 md:mr-4">
              <h1 className={`text-3xl font-bold mb-4 text-${colors['orange']}`}>Lobby Chat</h1>
              <div className="flex-1 overflow-y-auto space-y-4 pr-2">
                {messages.map((msg, index) => (
                  <div key={index} className="p-3 rounded-lg bg-gray-700 text-sm">
                    <span className={`font-bold text-${colors['blue']}`}>{msg.sender}:</span> {msg.text}
                  </div>
                ))}
              </div>
              <form onSubmit={handleSendMessage} className="mt-4 flex space-x-2">
                <input
                  type="text"
                  value={newMessage}
                  onChange={(e) => setNewMessage(e.target.value)}
                  placeholder="Type a message..."
                  className={`flex-1 px-4 py-2 rounded-lg bg-gray-700 border border-${colors['bg-light']} text-${colors['fg-dark']} focus:outline-none focus:ring-2 focus:ring-${colors['yellow']}`}
                />
                <button
                  type="submit"
                  className={`py-2 px-4 rounded-lg bg-${colors['green']} hover:bg-${colors['aqua']} transition-colors text-${colors['bg-dark']} font-bold`}
                >
                  Send
                </button>
              </form>
            </div>
            <div className="md:w-1/4 flex flex-col bg-gray-800 p-6 rounded-xl shadow-lg">
              <h2 className={`text-2xl font-bold mb-4 text-${colors['orange']}`}>Active Users</h2>
              <div className="flex flex-col space-y-2">
                {users.map((u) => (
                  <div key={u.uid} className={`p-3 rounded-lg flex items-center justify-between bg-gray-700`}>
                    <span className="font-medium">{u.username}</span>
                    <span className="text-xs text-gray-500">{u.uid}</span>
                    {username === 'admin' && u.uid !== user.uid && (
                      <button
                        onClick={() => handleStartCall(u)}
                        className={`py-1 px-3 rounded-lg bg-${colors['purple']} hover:bg-violet-700 transition-colors text-white font-bold`}
                      >
                        Call
                      </button>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      case 'call':
        return (
          <div className={`min-h-screen flex flex-col items-center justify-center p-4 bg-${colors['bg-dark']}`}>
            <div className={`w-full max-w-4xl p-6 rounded-xl shadow-lg bg-${colors['bg-light']} mb-4`}>
              <h1 className={`text-2xl font-bold text-center mb-4 text-${colors['orange']}`}>Video Call with {otherUser?.username || 'user'}</h1>
              <div className="relative w-full h-auto" style={{ paddingBottom: '75%' }}>
                <video
                  ref={remoteVideoRef}
                  autoPlay
                  playsInline
                  className="absolute inset-0 w-full h-full object-cover rounded-lg border-4 border-gray-700"
                ></video>
                <video
                  ref={localVideoRef}
                  autoPlay
                  playsInline
                  muted
                  className="absolute bottom-4 right-4 w-1/4 h-auto object-cover rounded-lg border-2 border-white shadow-lg"
                ></video>
              </div>
              <div className="flex justify-center space-x-4 mt-6">
                <button
                  onClick={toggleMute}
                  className={`p-3 rounded-full shadow-lg transition-colors ${isMuted ? `bg-${colors['red']}` : `bg-${colors['green']}`} text-${colors['bg-dark']} font-bold`}
                >
                  {isMuted ? (
                    <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm6 10a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zm-3-1a1 1 0 011 1v2a1 1 0 11-2 0v-2a1 1 0 011-1zM5 14a1 1 0 011-1v-2a1 1 0 112 0v2a1 1 0 011 1h4a1 1 0 011-1v-2a1 1 0 112 0v2a1 1 0 011 1v3.5A2.5 2.5 0 0116.5 20H3.5A2.5 2.5 0 011 17.5V14a1 1 0 011-1h4z" clipRule="evenodd"></path></svg>
                  ) : (
                    <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M11 5a1 1 0 00-2 0v6a1 1 0 102 0V5zM9 13a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zM7 11a1 1 0 011-1v-1a1 1 0 112 0v1a1 1 0 011-1h2a1 1 0 011-1v-1a1 1 0 112 0v1a1 1 0 011 1h2a1 1 0 011-1v-2a1 1 0 112 0v2a1 1 0 011 1v3.5A2.5 2.5 0 0118.5 20H1.5A2.5 2.5 0 01-1 17.5V13a1 1 0 011-1h2a1 1 0 011 1z"></path></svg>
                  )}
                </button>
                <button
                  onClick={toggleCamera}
                  className={`p-3 rounded-full shadow-lg transition-colors ${isCameraOff ? `bg-${colors['red']}` : `bg-${colors['green']}`} text-${colors['bg-dark']} font-bold`}
                >
                  {isCameraOff ? (
                    <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M12.983 2.983a.5.5 0 00-.706 0L9.5 5.75l-2.777-2.763a.5.5 0 10-.706.706L8.794 6.5l-2.777 2.763a.5.5 0 10.706.706L9.5 7.25l2.777 2.763a.5.5 0 10.706-.706L10.206 6.5l2.777-2.763a.5.5 0 000-.706zM9.5 14a.5.5 0 00-.5.5v2.5a.5.5 0 001 0v-2.5a.5.5 0 00-.5-.5z"></path><path fillRule="evenodd" d="M16 1.5A1.5 1.5 0 0117.5 3v14a1.5 1.5 0 01-1.5 1.5H4A1.5 1.5 0 012.5 17V3A1.5 1.5 0 014 1.5h12zm-8.5 2a1 1 0 00-1 1V6a1 1 0 00-1 1v.5a1.5 1.5 0 011.5 1.5v3.5A1.5 1.5 0 019 14.5v.5a1 1 0 001 1v1.5a1 1 0 002 0v-1.5a1 1 0 001-1v-.5a1.5 1.5 0 011.5-1.5v-3.5a1.5 1.5 0 011.5-1.5V6a1 1 0 00-1-1h-2z" clipRule="evenodd"></path></svg>
                  ) : (
                    <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M15 5h.5a2 2 0 012 2v8a2 2 0 01-2 2H15a2 2 0 01-2-2V7a2 2 0 012-2zM4 5h.5a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V7a2 2 0 012-2zM10.5 5a2 2 0 00-2 2v8a2 2 0 002 2h-1a2 2 0 002-2V7a2 2 0 00-2-2h-1z"></path></svg>
                  )}
                </button>
                <button
                  onClick={handleEndCall}
                  className={`p-3 rounded-full shadow-lg bg-${colors['red']} hover:bg-${colors['orange']} transition-colors text-${colors['bg-dark']} font-bold`}
                >
                  <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M3.293 3.293a1 1 0 011.414 0L10 8.586l5.293-5.293a1 1 0 111.414 1.414L11.414 10l5.293 5.293a1 1 0 01-1.414 1.414L10 11.414l-5.293 5.293a1 1 0 01-1.414-1.414L8.586 10 3.293 4.707a1 1 0 010-1.414z" clipRule="evenodd"></path></svg>
                </button>
              </div>
            </div>
          </div>
        );
    }
  };

  return (
    <div className={`font-sans antialiased bg-${colors['bg-dark']}`}>
      {renderView()}
    </div>
  );
};

export default App;
