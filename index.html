<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Meetup</title>
    <style>
        :root {
            --bg-dark: #282828;
            --bg-medium: #3c3836;
            --bg-light: #504945;
            --text-primary: #fbf1c7;
            --text-secondary: #a89984;
            --red: #fb4934;
            --green: #b8bb26;
            --yellow: #fabd2f;
            --blue: #83a598;
            --purple: #d3869b;
            --aqua: #8ec07c;
            --orange: #fe8019;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Fira Code', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background-color: var(--bg-medium);
            border: 2px solid var(--text-secondary);
            padding: 2em;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 600px;
            text-align: center;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .title {
            color: var(--orange);
            text-shadow: 2px 2px var(--bg-light);
            margin-bottom: 0.5em;
        }

        p {
            color: var(--text-secondary);
            margin-bottom: 1.5em;
        }

        input, .btn {
            border: 2px solid var(--text-secondary);
            background-color: var(--bg-light);
            color: var(--text-primary);
            padding: 0.75em;
            border-radius: 5px;
            margin-top: 0.5em;
            font-family: 'Fira Code', monospace;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: var(--aqua);
            box-shadow: 0 0 5px var(--aqua);
        }

        .btn {
            cursor: pointer;
            background-color: var(--blue);
            color: var(--text-primary);
        }

        .btn:hover {
            background-color: var(--aqua);
            color: var(--bg-dark);
        }

        .hangup {
            background-color: var(--red);
        }

        .hangup:hover {
            background-color: var(--orange);
        }

        #login-form, #chat-form {
            display: flex;
            flex-direction: column;
            gap: 1em;
        }

        .lobby-content {
            display: flex;
            flex-direction: column;
            gap: 1em;
        }

        .chat-box {
            border: 2px solid var(--text-secondary);
            border-radius: 5px;
            padding: 1em;
            height: 200px;
            overflow-y: scroll;
            text-align: left;
            background-color: var(--bg-light);
            margin-bottom: 1em;
        }

        .messages p {
            margin: 0.5em 0;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .message-sender {
            color: var(--yellow);
        }

        .actions {
            margin-top: 1em;
        }

        .video-container {
            display: flex;
            flex-direction: column;
            gap: 1em;
            justify-content: center;
            align-items: center;
        }

        .video-box {
            border: 2px solid var(--text-secondary);
            border-radius: 5px;
            background-color: var(--bg-light);
            width: 100%;
            max-width: 450px;
            height: 250px;
            overflow: hidden;
        }

        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .controls {
            margin-top: 1.5em;
        }
    </style>
</head>
<body>

    <div class="container">

        <!-- Login Screen -->
        <section id="login-screen" class="screen active">
            <h1 class="title">Retro Meetup</h1>
            <p>Enter a username to join the lobby</p>
            <form id="login-form">
                <input type="text" id="username-input" placeholder="Your username..." required>
                <button type="submit" class="btn">Enter Lobby</button>
            </form>
        </section>
        
        <!-- Main Lobby -->
        <section id="lobby-screen" class="screen">
            <h1 class="title">Lobby</h1>
            <p>Waiting for a friend...</p>
            
            <div class="lobby-content">
                <div class="chat-box">
                    <div id="messages" class="messages"></div>
                    <form id="chat-form">
                        <input type="text" id="message-input" placeholder="Say something..." required>
                        <button type="submit" class="btn">Send</button>
                    </form>
                </div>
            </div>

            <div class="actions">
                <button id="create-room-btn" class="btn">Create a New Room</button>
            </div>
        </section>

        <!-- Video Call Screen -->
        <section id="room-screen" class="screen">
            <div class="video-container">
                <div class="video-box">
                    <video id="local-video" autoplay muted></video>
                </div>
                <div class="video-box">
                    <video id="remote-video" autoplay></video>
                </div>
            </div>
            <div class="controls">
                <button id="hangup-btn" class="btn hangup">Hang Up</button>
            </div>
        </section>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    
    <!-- Main Script -->
    <script>
        // Firebase configuration from the user
        const firebaseConfig = {
            apiKey: "AIzaSyBluS1Dl9abDJjPPeOhvTCfP8J1kyIh6BQ",
            authDomain: "video-meeting-e73eb.firebaseapp.com",
            projectId: "video-meeting-e73eb",
            storageBucket: "video-meeting-e73eb.firebasestorage.app",
            messagingSenderId: "80496795033",
            appId: "1:80496795033:web:3ac35c631d76301f77c708",
            measurementId: "G-SFPQ0PJRPG"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // UI Elements
        const loginScreen = document.getElementById('login-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const roomScreen = document.getElementById('room-screen');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username-input');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const messagesDiv = document.getElementById('messages');
        const createRoomBtn = document.getElementById('create-room-btn');
        const hangupBtn = document.getElementById('hangup-btn');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');

        let username = '';
        let currentRoomId = null;
        let localStream;
        let peerConnection;

        const iceServers = {
            'iceServers': [
                { 'urls': 'stun:stun.l.google.com:19302' },
                { 'urls': 'stun:stun1.l.google.com:19302' },
            ]
        };

        // --- Screen and State Management ---
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
        }

        // --- Firebase Authentication and Login ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            username = usernameInput.value;
            if (username) {
                showScreen(lobbyScreen);
                setupLobbyChat();
            }
        });

        // --- Firebase Lobby Chat ---
        function setupLobbyChat() {
            const chatRef = db.ref('lobby_chat');
            
            // Listen for new messages
            chatRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                const msgElement = document.createElement('p');
                msgElement.innerHTML = `<span class="message-sender">${message.user}:</span> ${message.text}`;
                messagesDiv.appendChild(msgElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll
            });

            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = messageInput.value;
                if (message) {
                    chatRef.push({
                        user: username,
                        text: message,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    messageInput.value = '';
                }
            });
        }

        // --- WebRTC Room Management and Call Setup ---
        createRoomBtn.addEventListener('click', async () => {
            const roomId = 'room_' + Math.floor(Math.random() * 100000);
            currentRoomId = roomId;
            const roomRef = db.ref('rooms/' + roomId);

            showScreen(roomScreen);
            await startLocalStream();

            // Create a new room in Firebase and wait for a second user
            await roomRef.set({ creator: username, status: 'waiting' });
            
            // Set up the WebRTC connection for the creator
            setupPeerConnection(roomRef);

            // Creator creates and sends an offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            await roomRef.child('offer').set(offer);
            
            // Listen for an answer from a joining user
            roomRef.child('answer').on('value', async (snapshot) => {
                const answer = snapshot.val();
                if (answer && peerConnection.remoteDescription.type === '') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                }
            });

            // Listen for ICE candidates from the joining user
            roomRef.child('calleeCandidates').on('child_added', async (snapshot) => {
                const candidate = new RTCIceCandidate(snapshot.val());
                await peerConnection.addIceCandidate(candidate);
            });
        });

        hangupBtn.addEventListener('click', () => {
            endCall();
        });

        // Joins an existing room (in a real app, you'd have a UI for this)
        async function joinRoom(roomId) {
            currentRoomId = roomId;
            const roomRef = db.ref('rooms/' + roomId);
            showScreen(roomScreen);
            await startLocalStream();
            
            // Set up the WebRTC connection for the joiner
            setupPeerConnection(roomRef);
            
            // Joiner listens for the offer
            roomRef.child('offer').on('value', async (snapshot) => {
                const offer = snapshot.val();
                if (offer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    
                    // Joiner creates and sends an answer
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    await roomRef.child('answer').set(answer);
                }
            });
            
            // Listen for ICE candidates from the creator
            roomRef.child('creatorCandidates').on('child_added', async (snapshot) => {
                const candidate = new RTCIceCandidate(snapshot.val());
                await peerConnection.addIceCandidate(candidate);
            });
        }

        // Start local video and audio stream
        async function startLocalStream() {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
        }

        // Set up the Peer Connection
        function setupPeerConnection(roomRef) {
            peerConnection = new RTCPeerConnection(iceServers);
            
            // Add local tracks to the connection
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // Listen for the remote stream
            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };
            
            // Collect ICE candidates and send them to Firebase
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidateRef = peerConnection.localDescription.type === 'offer' 
                        ? roomRef.child('creatorCandidates') 
                        : roomRef.child('calleeCandidates');
                    candidateRef.push(event.candidate.toJSON());
                }
            };
        }

        // End the call and clean up
        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
            
            // Clean up Firebase data for the room
            if (currentRoomId) {
                db.ref('rooms/' + currentRoomId).remove();
                currentRoomId = null;
            }
            
            // Reset video elements and return to lobby
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            showScreen(lobbyScreen);
        }

        // A simple way to join a room, for demonstration.
        // In a real app, you'd add a "Join" button for specific rooms.
        // For now, if a room is available, any new user can join the first one they find.
        db.ref('rooms').on('child_added', (snapshot) => {
            const roomId = snapshot.key;
            const room = snapshot.val();
            if (room.status === 'waiting' && !currentRoomId) {
                // Automatically join the first waiting room
                snapshot.ref.update({ status: 'in-call' });
                joinRoom(roomId);
            }
        });
    </script>
</body>
</html>
