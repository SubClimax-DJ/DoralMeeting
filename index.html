<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gruvbox Video Conferencing</title>
  <style>
    :root {
      /* Gruvbox Dark Palette */
      --bg0-h: #282828; --bg0-s: 14%; --bg0-l: 16%; /* Hard bg0 */
      --bg1: #3c3836; /* Softer bg */
      --bg3: #665c54; /* Muted */
      --fg0: #fbf1c7; /* Light fg */
      --fg4: #bdae93; /* Muted fg */
      --red: #fb4934; /* Accent red */
      --blue: #83a598; /* Blue */
      --green: #b8bb26; /* Green */
      --yellow: #fabd2f; /* Yellow */
      --font: 'Monaco', 'Menlo', monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      background: hsl(var(--bg0-h), var(--bg0-s), var(--bg0-l));
      color: var(--fg0);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
    }
    #app { width: 100%; max-width: 800px; background: var(--bg1); border-radius: 8px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .screen { display: none; }
    .screen.active { display: block; }
    input, button { padding: 0.5rem; margin: 0.25rem; border: 1px solid var(--bg3); border-radius: 4px; background: var(--bg0-h); color: var(--fg0); font-family: inherit; }
    button { cursor: pointer; background: var(--blue); border-color: var(--blue); transition: background 0.2s; }
    button:hover { background: var(--green); }
    button.danger { background: var(--red); border-color: var(--red); }
    button.danger:hover { background: #cc241d; }
    ul { list-style: none; }
    li { padding: 0.5rem; border-bottom: 1px solid var(--bg3); cursor: pointer; }
    li:hover { background: var(--bg3); }
    li.admin-callable { color: var(--yellow); }
    #chat-messages { height: 200px; overflow-y: auto; border: 1px solid var(--bg3); padding: 1rem; margin: 1rem 0; background: var(--bg0-h); }
    .msg { margin: 0.25rem 0; }
    .msg-username { color: var(--blue); font-weight: bold; }
    #logo { max-width: 200px; display: block; margin: 1rem auto; }
    #video-container { display: flex; flex-direction: column; align-items: center; }
    #remote-video, #local-video { width: 100%; max-width: 600px; border: 1px solid var(--bg3); border-radius: 4px; }
    #local-video { width: 200px; position: fixed; top: 20px; right: 20px; }
    .controls { margin: 1rem 0; }
    .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--yellow); color: var(--bg0-h); padding: 1rem; border-radius: 4px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Login Screen -->
    <div id="login" class="screen active">
      <h1 style="text-align: center; margin-bottom: 1rem; color: var(--fg0);">Video Conferencing</h1>
      <input type="text" id="username" placeholder="Enter username" required>
      <div id="password-container" class="hidden">
        <input type="password" id="password" placeholder="Enter password">
      </div>
      <button id="join-btn">Join</button>
      <p style="text-align: center; margin-top: 1rem; color: var(--fg4);">Admin: username 'admin', password 'max'</p>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby" class="screen">
      <img id="logo" src="https://content.enrollmystudent.org/contact_school_logo/school_logo_1655490559.jpg" alt="Company Logo">
      <h2>Lobby Chat</h2>
      <ul id="user-list"></ul>
      <div id="chat-messages"></div>
      <input type="text" id="chat-input" placeholder="Type a message..." maxlength="500">
      <button id="send-btn">Send</button>
    </div>

    <!-- Video Screen -->
    <div id="video" class="screen">
      <h2>Video Call</h2>
      <div id="video-container">
        <video id="remote-video" autoplay playsinline muted></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="controls">
          <button id="mute-btn">Mute</button>
          <button id="video-btn">Camera Off</button>
          <button id="end-btn" class="danger">End Call</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, collection, query, where } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';
    import { getDatabase, ref, set, onValue, push, onChildAdded, remove, goOffline, goOnline, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBbTFLhxzXf08OVDGGsK54t3qDzPVvsJ3w",
      authDomain: "conferencedoral.firebaseapp.com",
      projectId: "conferencedoral",
      storageBucket: "conferencedoral.firebasestorage.app",
      messagingSenderId: "668062587354",
      appId: "1:668062587354:web:9b831842ada6ebf87148e3",
      measurementId: "G-HDJ9S9G2T2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    let currentUser = null;
    let username = '';
    let isAdmin = false;
    let currentCallId = null;
    let localStream = null;
    let remoteStream = null;
    let pc = null;

    // DOM Elements
    const screens = { login: document.getElementById('login'), lobby: document.getElementById('lobby'), video: document.getElementById('video') };
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const passwordContainer = document.getElementById('password-container');
    const joinBtn = document.getElementById('join-btn');
    const userList = document.getElementById('user-list');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const remoteVideo = document.getElementById('remote-video');
    const localVideo = document.getElementById('local-video');
    const muteBtn = document.getElementById('mute-btn');
    const videoBtn = document.getElementById('video-btn');
    const endBtn = document.getElementById('end-btn');

    // Switch Screen
    function switchScreen(screen) {
      Object.values(screens).forEach(s => s.classList.remove('active'));
      screens[screen].classList.add('active');
    }

    // Login Logic
    joinBtn.addEventListener('click', async () => {
      username = usernameInput.value.trim();
      if (!username) return alert('Username required');
      passwordContainer.classList.add('hidden');
      passwordInput.value = '';

      try {
        if (username === 'admin') {
          passwordContainer.classList.remove('hidden');
          const pass = prompt('Enter admin password:');  // Simple prompt for demo; use input in prod
          if (pass !== 'max') return alert('Invalid password');
          await signInWithEmailAndPassword(auth, 'admin@conferencedoral.com', 'max');
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        alert('Login failed: ' + error.message);
      }
    });

    // Auth State Changed
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        isAdmin = user.email === 'admin@conferencedoral.com';
        if (isAdmin) username = 'admin';

        // Set user profile
        if (!isAdmin) {
          await setDoc(doc(db, 'users', user.uid), { username });
        }

        // Set presence
        const presenceRef = ref(rtdb, `presence/${user.uid}`);
        set(presenceRef, { username: isAdmin ? 'admin' : username, online: true });
        onDisconnect(presenceRef).remove();

        switchScreen('lobby');
        loadLobby();
      } else {
        switchScreen('login');
      }
    });

    // Load Lobby
    function loadLobby() {
      // User List
      const presenceRef = ref(rtdb, 'presence');
      onValue(presenceRef, (snapshot) => {
        userList.innerHTML = '';
        snapshot.forEach((child) => {
          const data = child.val();
          if (data.online && data.username !== username) {
            const li = document.createElement('li');
            li.textContent = data.username;
            if (isAdmin) {
              li.classList.add('admin-callable');
              li.addEventListener('click', () => initiateCall(child.key));  // child.key is targetUid
            }
            userList.appendChild(li);
          }
        });
      });

      // Chat
      const messagesRef = ref(rtdb, 'chat/messages');
      onChildAdded(messagesRef, (snapshot) => {
        const msg = snapshot.val();
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<span class="msg-username">${msg.username}:</span> ${msg.text}`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });

      sendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

      // Notifications for calls (users only)
      if (!isAdmin) {
        const notifQuery = query(collection(db, 'notifications', currentUser.uid, 'calls'));
        onSnapshot(notifQuery, (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === 'added') {
              const notif = change.doc.data();
              joinCallAsUser(notif.from, change.doc.id);  // callId = doc.id
            }
          });
        });
      }
    }

    async function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      const messagesRef = ref(rtdb, 'chat/messages');
      push(messagesRef, { timestamp: Date.now(), uid: currentUser.uid, username, text });
      chatInput.value = '';
    }

    // Initiate Call (Admin Only)
    async function initiateCall(targetUid) {
      const callRef = ref(rtdb, 'calls');
      const callId = push(callRef).key;
      await set(ref(rtdb, `calls/${callId}`), { from: currentUser.uid, to: targetUid, status: 'initiated' });

      // Send notification
      await setDoc(doc(db, `notifications/${targetUid}/calls/${callId}`), {
        from: currentUser.uid,
        timestamp: serverTimestamp()
      });

      // Switch to video
      currentCallId = callId;
      await startCall(true);  // true = caller
    }

    // Join Call as User
    async function joinCallAsUser(adminUid, callId) {
      currentCallId = callId;
      // Optional: Show notification
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = 'Admin call incoming... Joining.';
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);

      await startCall(false);  // false = callee
    }

    // Start Video Call
    async function startCall(isCaller) {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        pc = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.ontrack = (e) => { remoteVideo.srcObject = e.streams[0]; };
        pc.onicecandidate = (e) => {
          if (e.candidate) {
            push(ref(rtdb, `calls/${currentCallId}/ice_candidates/${currentUser.uid}`), { candidate: e.candidate });
          }
        };

        const callRef = ref(rtdb, `calls/${currentCallId}`);
        const iceRef = ref(rtdb, `calls/${currentCallId}/ice_candidates`);

        // Listen for ICE from other
        const otherUid = isCaller ? (await getOtherUid()).to : (await getOtherUid()).from;
        onValue(ref(iceRef, otherUid), (snapshot) => {
          snapshot.forEach((child) => {
            pc.addIceCandidate(new RTCIceCandidate(child.val().candidate));
          });
        });

        if (isCaller) {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          set(ref(callRef, 'offer'), { sdp: offer.sdp, type: offer.type });

          // Wait for answer
          onValue(ref(callRef, 'answer'), async (snap) => {
            if (snap.val()) {
              const answer = new RTCSessionDescription(snap.val());
              await pc.setRemoteDescription(answer);
            }
          });
        } else {
          // Wait for offer
          onValue(ref(callRef, 'offer'), async (snap) => {
            if (snap.val()) {
              const offer = new RTCSessionDescription(snap.val());
              await pc.setRemoteDescription(offer);
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              set(ref(callRef, 'answer'), { sdp: answer.sdp, type: answer.type });
            }
          });
        }

        switchScreen('video');
        setupControls();
      } catch (error) {
        alert('Media access failed: ' + error.message);
      }
    }

    async function getOtherUid() {
      const snap = await get(ref(rtdb, `calls/${currentCallId}`));
      return snap.val();
    }

    function setupControls() {
      let muted = false;
      let videoOff = false;

      muteBtn.addEventListener('click', () => {
        muted = !muted;
        localStream.getAudioTracks()[0].enabled = !muted;
        muteBtn.textContent = muted ? 'Unmute' : 'Mute';
      });

      videoBtn.addEventListener('click', () => {
        videoOff = !videoOff;
        localStream.getVideoTracks()[0].enabled = !videoOff;
        videoBtn.textContent = videoOff ? 'Camera On' : 'Camera Off';
      });

      endBtn.addEventListener('click', endCall);
    }

    async function endCall() {
      if (pc) {
        pc.close();
        pc = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      remoteVideo.srcObject = null;
      localVideo.srcObject = null;

      // Cleanup
      if (currentCallId) {
        remove(ref(rtdb, `calls/${currentCallId}`));
        currentCallId = null;
      }

      switchScreen('lobby');
    }

    // Cleanup on unload
    window.addEventListener('beforeunload', () => {
      if (currentUser) {
        remove(ref(rtdb, `presence/${currentUser.uid}`));
        endCall();
      }
      goOffline(rtdb);
    });
  </script>
</body>
</html>
