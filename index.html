<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruvbox Video Conference</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-dark: #282828;
            --bg-light: #3c3836;
            --fg-main: #ebdbb2;
            --red: #cc241d;
            --green: #98971a;
            --yellow: #d79921;
            --blue: #458588;
            --purple: #b16286;
            --aqua: #689d6a;
            --orange: #d65d0e;
        }
        body {
            font-family: 'Fira Code', monospace;
            background-color: var(--bg-dark);
            color: var(--fg-main);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 900px;
        }
        .btn {
            @apply font-bold py-2 px-6 rounded-lg transition-colors duration-200 text-sm md:text-base;
        }
        .btn-green {
            background-color: var(--green);
            color: var(--bg-dark);
        }
        .btn-green:hover {
            background-color: #a8b843;
        }
        .btn-red {
            background-color: var(--red);
            color: var(--fg-main);
        }
        .btn-red:hover {
            background-color: #de504e;
        }
        .btn-blue {
            background-color: var(--blue);
            color: var(--bg-dark);
        }
        .btn-blue:hover {
            background-color: #559598;
        }
        .input-gruvbox {
            background-color: var(--bg-light);
            color: var(--fg-main);
            border: 2px solid var(--blue);
        }
        .text-gruvbox {
            color: var(--aqua);
        }
        .title {
            color: var(--yellow);
        }
        .subtitle {
            color: var(--purple);
        }
        video {
            background-color: var(--bg-light);
            border: 3px solid var(--blue);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal {
            background-color: var(--bg-light);
            border: 2px solid var(--fg-main);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        .room-item {
            @apply p-3 rounded-lg flex justify-between items-center cursor-pointer;
            background-color: var(--bg-dark);
            border: 1px solid var(--fg-main);
            transition: background-color 0.2s;
        }
        .room-item:hover {
            background-color: var(--bg-light);
        }
        #chat-messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid var(--fg-main);
            border-radius: 8px;
            padding: 1rem;
            background-color: var(--bg-dark);
        }
        .chat-message {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: flex-start;
        }
        .chat-sender {
            font-weight: bold;
            color: var(--aqua);
            margin-right: 0.5rem;
        }
        .chat-text {
            color: var(--fg-main);
            word-wrap: break-word;
            flex-grow: 1;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Login Screen -->
    <div id="login-screen" class="container bg-[var(--bg-light)] p-6 md:p-8 rounded-xl shadow-2xl space-y-6">
        <div class="flex flex-col items-center justify-center text-center">
            <h1 class="text-3xl md:text-4xl font-extrabold title">
                <span class="text-gruvbox">Gruvbox</span> Video Conference
            </h1>
            <p class="text-gruvbox mt-2 text-sm md:text-base">Welcome! Please enter a nickname to get started.</p>
        </div>
        <div class="flex flex-col items-center space-y-4">
            <input type="text" id="nickname-input" class="input-gruvbox w-full md:w-64 px-4 py-2 rounded-lg text-center" placeholder="Your Nickname">
            <button id="start-app-btn" class="btn btn-green w-full md:w-auto">Start Conference</button>
        </div>
        <div id="login-status" class="mt-4 w-full text-center">
            <p class="text-gruvbox text-sm md:text-base">Connecting to server...</p>
        </div>
    </div>

    <!-- Main Conference Screen (initially hidden) -->
    <div id="conference-screen" class="container bg-[var(--bg-light)] p-6 md:p-8 rounded-xl shadow-2xl space-y-6 hidden">
        <div class="flex flex-col items-center justify-center text-center">
            <h1 class="text-3xl md:text-4xl font-extrabold title">
                <span class="text-gruvbox">Gruvbox</span> Video Conference
            </h1>
            <p class="text-gruvbox mt-2 text-sm md:text-base">Simple 2-Way Peer-to-Peer Calling</p>
        </div>

        <div id="video-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="flex flex-col items-center">
                <video id="localVideo" class="w-full h-64 md:h-80" autoplay muted playsinline></video>
                <p id="local-video-label" class="text-gruvbox mt-2">Your Camera</p>
            </div>
            <div class="flex flex-col items-center">
                <video id="remoteVideo" class="w-full h-64 md:h-80" autoplay playsinline></video>
                <p id="remote-video-label" class="text-gruvbox mt-2">Remote Camera</p>
            </div>
        </div>

        <div id="controls-panel" class="flex flex-col items-center justify-center space-y-4">
            <div class="flex space-x-4">
                <button id="start-call-btn" class="btn btn-green">Start Call</button>
                <button id="hang-up-btn" class="btn btn-red" disabled>Hang Up</button>
            </div>
            <div id="message-container" class="mt-4 w-full text-center">
                <p id="status-message" class="text-gruvbox text-sm md:text-base">Please grant camera and microphone access to start.</p>
            </div>
        </div>

        <hr class="border-t-2 border-dashed border-[var(--aqua)] my-6">

        <!-- Available Rooms Section -->
        <div id="room-list-section" class="flex flex-col items-center w-full">
            <h2 class="text-2xl font-bold subtitle mb-4">Join an Existing Room</h2>
            <div id="rooms-container" class="w-full space-y-2 max-h-64 overflow-y-auto">
                <!-- Rooms will be dynamically added here -->
            </div>
            <p id="no-rooms-message" class="text-gruvbox mt-4">No rooms available. Be the first to start a call!</p>
        </div>

        <hr class="border-t-2 border-dashed border-[var(--aqua)] my-6">
        
        <!-- Chat Section -->
        <div id="chat-section" class="flex flex-col items-center w-full">
            <h2 class="text-2xl font-bold subtitle mb-4">Chat</h2>
            <div id="chat-messages" class="w-full">
                <!-- Messages will be dynamically added here -->
            </div>
            <div class="flex w-full mt-4 space-x-2">
                <input type="text" id="chat-input" class="input-gruvbox flex-grow px-4 py-2 rounded-lg" placeholder="Type a message...">
                <button id="send-chat-btn" class="btn btn-blue px-4 py-2">Send</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for sharing unique URL -->
    <div id="idModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="modal p-8 rounded-lg text-center max-w-sm w-full">
            <h2 class="text-xl md:text-2xl font-bold text-yellow">Share this link</h2>
            <p class="mt-4 text-sm md:text-base text-gruvbox">Copy and share this unique URL with the person you want to call:</p>
            <div class="mt-4 bg-[var(--bg-dark)] p-4 rounded-lg flex flex-col items-center space-y-2">
                <input type="text" id="shareUrlInput" readonly class="input-gruvbox w-full px-2 py-1 text-sm break-all">
                <button id="copyUrlBtn" class="btn btn-blue w-full flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-[var(--fg-main)]" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 013 3v12c0 1.1-.9 2-2 2H5a2 2 0 01-2-2V6a3 3 0 013-3z" />
                    </svg>
                    Copy Link
                </button>
            </div>
            <button id="closeModalBtn" class="mt-6 btn btn-green w-full">Close</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, where, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // Provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBluS1Dl9abDJjPPeOhvTCfP8J1kyIh6BQ",
            authDomain: "video-meeting-e73eb.firebaseapp.com",
            projectId: "video-meeting-e73eb",
            storageBucket: "video-meeting-e73eb.firebasestorage.app",
            messagingSenderId: "80496795033",
            appId: "1:80496795033:web:3ac35c631d76301f77c708",
            measurementId: "G-SFPQ0PJRPG"
        };
        
        // Global variables for Firebase and WebRTC
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let callId = null;
        let db = null;
        let auth = null;
        let userId = null;
        let userNickname = null;

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const conferenceScreen = document.getElementById('conference-screen');
        const nicknameInput = document.getElementById('nickname-input');
        const startAppBtn = document.getElementById('start-app-btn');
        const loginStatus = document.getElementById('login-status');
        
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const localVideoLabel = document.getElementById('local-video-label');
        const remoteVideoLabel = document.getElementById('remote-video-label');
        const startCallBtn = document.getElementById('start-call-btn');
        const hangUpBtn = document.getElementById('hang-up-btn');
        const statusMessage = document.getElementById('status-message');
        const idModal = document.getElementById('idModal');
        const shareUrlInput = document.getElementById('shareUrlInput');
        const copyUrlBtn = document.getElementById('copyUrlBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const roomsContainer = document.getElementById('rooms-container');
        const noRoomsMessage = document.getElementById('no-rooms-message');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');

        // --- Firebase & App Initialization ---
        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                console.log("Firebase initialized. User ID:", userId);
                
                // Check if user has a stored nickname
                const userDocRef = doc(db, `artifacts/${__app_id}/public/data/users/${userId}`);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    userNickname = userDoc.data().nickname;
                    loginStatus.textContent = `Welcome back, ${userNickname}!`;
                    showConferenceScreen();
                } else {
                    loginStatus.textContent = 'Ready. Please enter your nickname.';
                    startAppBtn.disabled = false;
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                loginStatus.textContent = 'Error connecting to Firebase. Please check console for details.';
            }
        }

        // --- User Login Flow ---
        async function handleLogin() {
            const nickname = nicknameInput.value.trim();
            if (nickname.length === 0) {
                loginStatus.textContent = 'Please enter a nickname.';
                return;
            }
            userNickname = nickname;
            
            // Save the nickname to Firestore
            const userDocRef = doc(db, `artifacts/${__app_id}/public/data/users/${userId}`);
            await setDoc(userDocRef, { nickname: userNickname });

            showConferenceScreen();
        }

        function showConferenceScreen() {
            loginScreen.classList.add('hidden');
            conferenceScreen.classList.remove('hidden');
            localVideoLabel.textContent = userNickname;
            const urlParams = new URLSearchParams(window.location.search);
            const urlCallId = urlParams.get('id');

            if (urlCallId) {
                handleJoinCall(urlCallId);
            } else {
                statusMessage.textContent = 'Firebase connected. Click "Start Call" to begin or join a room below.';
                startCallBtn.disabled = false;
                setupRoomsList();
            }
        }
        
        // --- WebRTC Setup ---
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ]
        };

        async function createPeerConnection() {
            peerConnection = new RTCPeerConnection(servers);

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.ontrack = (event) => {
                console.log("Remote track received:", event.track);
                remoteVideo.srcObject = event.streams[0];
                const remoteData = JSON.parse(event.streams[0].id);
                remoteVideoLabel.textContent = remoteData.nickname;
            };

            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    const candidatesCollection = collection(db, `artifacts/${__app_id}/public/data/calls/${callId}/${peerConnection.localDescription.type === 'offer' ? 'offerCandidates' : 'answerCandidates'}`);
                    await addDoc(candidatesCollection, event.candidate.toJSON());
                }
            };
        }

        async function startLocalStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                stream.id = JSON.stringify({ userId: userId, nickname: userNickname }); // Add nickname to stream
                localStream = stream;
                localVideo.srcObject = localStream;
                startCallBtn.disabled = true;
                hangUpBtn.disabled = false;
            } catch (e) {
                console.error("Error getting local media:", e);
                statusMessage.textContent = 'Permission denied. Please allow camera and microphone access to use this app.';
                return null;
            }
            return localStream;
        }

        async function endCall() {
            if (peerConnection) {
                peerConnection.close();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            localVideoLabel.textContent = userNickname;
            remoteVideoLabel.textContent = 'Remote Camera';
            startCallBtn.disabled = false;
            hangUpBtn.disabled = true;
            statusMessage.textContent = 'Call ended. Ready to start or join a new one.';

            // Delete the chat subcollection and the room document from Firestore
            if (callId) {
                const chatDocs = await getDocs(collection(db, `artifacts/${__app_id}/public/data/calls/${callId}/chat`));
                const deletePromises = chatDocs.docs.map(d => deleteDoc(d.ref));
                await Promise.all(deletePromises);

                const callDoc = doc(db, `artifacts/${__app_id}/public/data/calls/${callId}`);
                await deleteDoc(callDoc).catch(e => console.error("Error deleting room:", e));
                console.log(`Room ${callId} and chat deleted.`);
                callId = null;
            }
        }

        // --- Call Creation & Joining Logic ---
        startCallBtn.onclick = async () => {
            statusMessage.textContent = 'Creating a new call...';
            const stream = await startLocalStream();
            if (!stream) return;

            callId = doc(collection(db, `artifacts/${__app_id}/public/data/calls`)).id;
            const joinUrl = `${window.location.href.split('?')[0]}?id=${callId}`;
            shareUrlInput.value = joinUrl;
            idModal.classList.remove('hidden');

            const callDoc = doc(db, `artifacts/${__app_id}/public/data/calls/${callId}`);
            
            await createPeerConnection();

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            await setDoc(callDoc, { offer: offer.toJSON(), createdAt: new Date(), creatorNickname: userNickname });
            statusMessage.textContent = 'Call created. Share the link above and wait for someone to join...';

            onSnapshot(callDoc, async (snapshot) => {
                const data = snapshot.data();
                if (data?.answer && !peerConnection.currentRemoteDescription) {
                    console.log("Received answer:", data.answer);
                    const answerDescription = new RTCSessionDescription(data.answer);
                    await peerConnection.setRemoteDescription(answerDescription);
                    statusMessage.textContent = 'Connected! Enjoy your call.';
                    setupChatListener(callId);
                }
            });

            onSnapshot(collection(db, `artifacts/${__app_id}/public/data/calls/${callId}/answerCandidates`), (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        await peerConnection.addIceCandidate(candidate);
                        console.log("Added remote ICE candidate (answerer).");
                    }
                });
            });
        };

        async function handleJoinCall(inputCallId) {
            callId = inputCallId;
            statusMessage.textContent = 'Joining call...';
            const stream = await startLocalStream();
            if (!stream) return;
            
            const callDoc = doc(db, `artifacts/${__app_id}/public/data/calls/${callId}`);
            const callSnapshot = await getDoc(callDoc);
            
            if (!callSnapshot.exists() || callSnapshot.data().answer) {
                statusMessage.textContent = 'Call is either not found or already in progress.';
                endCall();
                return;
            }

            await createPeerConnection();
            
            const offer = callSnapshot.data().offer;
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            await setDoc(callDoc, { answer: answer.toJSON() }, { merge: true });
            statusMessage.textContent = 'Connected! Enjoy your call.';
            setupChatListener(callId);

            onSnapshot(collection(db, `artifacts/${__app_id}/public/data/calls/${callId}/offerCandidates`), (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        await peerConnection.addIceCandidate(candidate);
                        console.log("Added remote ICE candidate (offerer).");
                    }
                });
            });
        }

        // --- Dynamic Room List ---
        function setupRoomsList() {
            const q = query(collection(db, `artifacts/${__app_id}/public/data/calls`), where("answer", "==", null));
            onSnapshot(q, (snapshot) => {
                let hasRooms = false;
                roomsContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const roomData = doc.data();
                    const roomDiv = document.createElement('div');
                    roomDiv.className = 'room-item';
                    roomDiv.innerHTML = `
                        <span>Room created by: <span class="text-yellow">${roomData.creatorNickname}</span></span>
                        <button class="btn-blue btn-join-room px-4 py-1">Join</button>
                    `;
                    roomDiv.querySelector('.btn-join-room').onclick = () => {
                        handleJoinCall(doc.id);
                    };
                    roomsContainer.appendChild(roomDiv);
                    hasRooms = true;
                });
                noRoomsMessage.style.display = hasRooms ? 'none' : 'block';
            });
        }
        
        // --- Chat Functionality ---
        function setupChatListener(currentCallId) {
            const chatQuery = query(collection(db, `artifacts/${__app_id}/public/data/calls/${currentCallId}/chat`));
            onSnapshot(chatQuery, (snapshot) => {
                chatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'chat-message';
                    messageDiv.innerHTML = `<span class="chat-sender">${msg.senderNickname}:</span> <span class="chat-text">${msg.text}</span>`;
                    chatMessages.appendChild(messageDiv);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
            });
        }

        sendChatBtn.onclick = async () => {
            const text = chatInput.value.trim();
            if (text.length === 0 || !callId) return;

            await addDoc(collection(db, `artifacts/${__app_id}/public/data/calls/${callId}/chat`), {
                text: text,
                senderId: userId,
                senderNickname: userNickname,
                timestamp: new Date()
            });

            chatInput.value = '';
        };

        // Allow sending message with Enter key
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatBtn.click();
            }
        });

        // --- Event Listeners ---
        startAppBtn.onclick = handleLogin;
        hangUpBtn.onclick = endCall;
        
        copyUrlBtn.onclick = () => {
            shareUrlInput.select();
            document.execCommand('copy');
            copyUrlBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-[var(--fg-main)]" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Copied!`;
            setTimeout(() => {
                copyUrlBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-[var(--fg-main)]" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 013 3v12c0 1.1-.9 2-2 2H5a2 2 0 01-2-2V6a3 3 0 013-3z" />
                                        </svg>
                                        Copy Link`;
            }, 2000);
        };

        closeModalBtn.onclick = () => {
            idModal.classList.add('hidden');
        };

        // Initialize the app on page load
        window.onload = initializeAppAndAuth;

    </script>
</body>
</html>
