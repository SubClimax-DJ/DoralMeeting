<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruvbox Video Conference</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gruvbox-dark-bg': '#282828',
                        'gruvbox-dark-fg': '#ebdbb2',
                        'gruvbox-dark-red': '#cc241d',
                        'gruvbox-dark-navy': '#076678',
                        'gruvbox-dark-silver': '#a89984',
                        'gruvbox-dark-crimson': '#dc322f',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #282828;
            color: #ebdbb2;
        }
        .container {
            max-width: 960px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .btn {
            @apply px-6 py-3 rounded-lg font-bold transition-transform transform hover:scale-105 shadow-md;
        }
        .btn-primary {
            @apply bg-gruvbox-dark-navy text-gruvbox-dark-fg hover:bg-opacity-80;
        }
        .btn-secondary {
            @apply bg-gruvbox-dark-red text-white hover:bg-opacity-80;
        }
        .input-field {
            @apply bg-gruvbox-dark-bg border border-gruvbox-dark-silver text-gruvbox-dark-fg rounded-lg p-4 w-full focus:outline-none focus:border-gruvbox-dark-navy transition-colors;
        }
        .card {
            @apply bg-gruvbox-dark-bg border border-gruvbox-dark-silver p-8 rounded-2xl shadow-lg;
        }
        .video-container {
            position: relative;
            background-color: black;
            border-radius: 1rem;
            overflow: hidden;
            display: grid;
            grid-template-columns: 1fr;
            min-height: 400px;
            gap: 1rem;
            align-items: center;
            justify-content: center;
        }
        @media (min-width: 640px) {
            .video-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        .video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
            background-color: #000;
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            @apply card p-6 w-11/12 max-w-lg;
        }
    </style>
</head>
<body>

<div id="app" class="container p-4">
    <!-- Main content area -->
    <div id="login-screen" class="card space-y-6">
        <h1 class="text-4xl font-bold text-center mb-4">Welcome</h1>
        <form id="login-form" class="space-y-4">
            <input id="username-input" type="text" placeholder="Enter your username" class="input-field" required>
            <button type="submit" class="btn btn-primary w-full">Go to Lobby</button>
        </form>
        <button id="admin-login-btn" type="button" class="btn btn-secondary w-full">Admin Login</button>
    </div>

    <div id="admin-login-screen" class="hidden card space-y-6">
        <h1 class="text-4xl font-bold text-center mb-4">Admin Login</h1>
        <form id="admin-login-form" class="space-y-4">
            <input id="admin-username-input" type="text" placeholder="Username" class="input-field" required>
            <input id="admin-password-input" type="password" placeholder="Password" class="input-field" required>
            <button type="submit" class="btn btn-primary w-full">Login</button>
        </form>
        <button id="admin-login-back-btn" type="button" class="btn btn-secondary w-full">Back to User Login</button>
    </div>

    <div id="lobby-screen" class="hidden">
        <div class="card mb-6 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold">Lobby</h1>
            <div class="text-sm text-gruvbox-dark-silver text-right">
                <p>User: <span id="username-display"></span></p>
                <p>User ID: <span id="user-id"></span></p>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Active Rooms <span id="room-count" class="text-gruvbox-dark-navy"></span></h2>
                    <button id="create-room-btn" class="btn btn-primary">Create New Room</button>
                </div>
                <ul id="rooms-list" class="space-y-2 max-h-64 overflow-y-auto"></ul>
            </div>

            <div class="card">
                <h2 class="text-2xl font-bold mb-4">Chat <span id="chat-count" class="text-gruvbox-dark-navy"></span></h2>
                <div id="chat-messages" class="h-64 overflow-y-auto mb-4 p-2 bg-gruvbox-dark-bg border border-gruvbox-dark-silver rounded-lg"></div>
                <form id="chat-form" class="flex gap-2">
                    <input id="chat-input" type="text" placeholder="Send a message..." class="input-field flex-grow">
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
        </div>
    </div>

    <div id="admin-console-screen" class="hidden">
        <div class="card mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold">Admin Console</h1>
            <button id="admin-logout-btn" class="btn btn-secondary">Logout</button>
        </div>

        <div class="card mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Manage Rooms</h2>
                <button id="delete-all-rooms-btn" class="btn btn-secondary">Delete All Rooms</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full table-auto">
                    <thead>
                        <tr class="text-left border-b border-gruvbox-dark-silver">
                            <th class="py-2 px-4">Room ID</th>
                            <th class="py-2 px-4">Creator</th>
                            <th class="py-2 px-4">Members</th>
                            <th class="py-2 px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-rooms-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="video-room-screen" class="hidden">
        <div class="card mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold">Video Room: <span id="room-id"></span></h1>
                <p id="connection-status" class="text-sm italic"></p>
                <button id="hang-up-btn" class="btn btn-secondary">Hang Up</button>
            </div>
            <div class="video-container relative mb-4">
                <video id="local-video" autoplay muted class="video-feed"></video>
                <video id="remote-video" autoplay class="video-feed"></video>
            </div>
            <div class="flex justify-center gap-4 flex-wrap">
                <button id="toggle-audio-btn" class="btn btn-primary">Mute Audio</button>
                <button id="toggle-video-btn" class="btn btn-primary">Hide Video</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase and App-specific variables ---
    const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : 'null';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const firebaseConfig = firebaseConfigString !== 'null' ? JSON.parse(firebaseConfigString) : {
        apiKey: "AIzaSyBluS1Dl9abDJjPPeOhvTCfP8J1kyIh6BQ",
        authDomain: "video-meeting-e73eb.firebaseapp.com",
        projectId: "video-meeting-e73eb",
        storageBucket: "video-meeting-e73eb.firebasestorage.app",
        messagingSenderId: "80496795033",
        appId: "1:80496795033:web:3ac35c631d76301f77c708",
        measurementId: "G-SFPQ0PJRPG"
    };

    let app;
    let auth;
    let db;
    let userId = null;
    let username = null;
    let isAdmin = false;

    // --- DOM Elements ---
    const loginScreen = document.getElementById('login-screen');
    const adminLoginScreen = document.getElementById('admin-login-screen');
    const lobbyScreen = document.getElementById('lobby-screen');
    const videoRoomScreen = document.getElementById('video-room-screen');
    const adminConsoleScreen = document.getElementById('admin-console-screen');

    const usernameInput = document.getElementById('username-input');
    const loginForm = document.getElementById('login-form');
    const adminLoginBtn = document.getElementById('admin-login-btn');
    const adminLoginBackBtn = document.getElementById('admin-login-back-btn');
    const adminLoginForm = document.getElementById('admin-login-form');
    const adminUsernameInput = document.getElementById('admin-username-input');
    const adminPasswordInput = document.getElementById('admin-password-input');
    const adminLogoutBtn = document.getElementById('admin-logout-btn');

    const usernameDisplay = document.getElementById('username-display');
    const userIdDisplay = document.getElementById('user-id');
    const createRoomBtn = document.getElementById('create-room-btn');
    const roomsList = document.getElementById('rooms-list');
    const roomCount = document.getElementById('room-count');
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatCount = document.getElementById('chat-count');
    const adminRoomsList = document.getElementById('admin-rooms-list');
    const deleteAllRoomsBtn = document.getElementById('delete-all-rooms-btn');

    const roomIdDisplay = document.getElementById('room-id');
    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');
    const hangUpBtn = document.getElementById('hang-up-btn');
    const toggleAudioBtn = document.getElementById('toggle-audio-btn');
    const toggleVideoBtn = document.getElementById('toggle-video-btn');
    const connectionStatus = document.getElementById('connection-status');

    // --- WebRTC Variables ---
    const servers = {
        iceServers: [
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
        ],
        iceCandidatePoolSize: 10,
    };
    let localStream = null;
    let peerConnection = null;
    let currentRoomId = null;

    // --- Firebase Initialization ---
    function initializeFirebase() {
        if (!app) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    if (username && !isAdmin) {
                        showScreen('lobby-screen');
                    } else if (username && isAdmin) {
                        showScreen('admin-console-screen');
                    }
                } else {
                    userId = null;
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken).catch(e => console.error(e));
                    } else {
                        await signInAnonymously(auth).catch(e => console.error(e));
                    }
                }
            });
        }
    }

    // --- UI State Management ---
    function showScreen(screenId) {
        const screens = [loginScreen, adminLoginScreen, lobbyScreen, videoRoomScreen, adminConsoleScreen];
        screens.forEach(screen => {
            if (screen.id === screenId) {
                screen.classList.remove('hidden');
            } else {
                screen.classList.add('hidden');
            }
        });
    }

    // --- Login & Authentication ---
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        username = usernameInput.value.trim();
        usernameDisplay.textContent = username;
        if (username.toLowerCase() === 'admin') {
            showCustomMessage('Please use the "Admin Login" button to log in as an administrator.');
            username = null;
        } else if (username) {
            showScreen('lobby-screen');
            setupLobbyListeners();
        }
    });

    adminLoginBtn.addEventListener('click', () => showScreen('admin-login-screen'));
    adminLoginBackBtn.addEventListener('click', () => showScreen('login-screen'));

    adminLoginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const inputUsername = adminUsernameInput.value.trim().toLowerCase();
        const password = adminPasswordInput.value.trim();
        if (inputUsername === 'admin' && password === 'max') {
            username = 'admin';
            isAdmin = true;
            usernameDisplay.textContent = username;
            showScreen('admin-console-screen');
            setupAdminListeners();
        } else {
            showCustomMessage('Incorrect credentials. Please use username "admin" and password "max".');
        }
    });

    adminLogoutBtn.addEventListener('click', async () => {
        await signOut(auth);
        username = null;
        isAdmin = false;
        showScreen('login-screen');
    });

    // --- Lobby & Chat Logic ---
    function setupLobbyListeners() {
        const roomsRef = collection(db, `artifacts/${appId}/public/data/rooms`);
        const chatRef = collection(db, `artifacts/${appId}/public/data/chat_messages`);

        onSnapshot(roomsRef, (snapshot) => {
            roomsList.innerHTML = '';
            roomCount.textContent = `(${snapshot.size})`;
            if (snapshot.empty) {
                roomsList.innerHTML = '<p class="text-center italic text-gruvbox-dark-silver">No active rooms. Create one to get started!</p>';
                return;
            }
            snapshot.forEach(async (roomDoc) => {
                const roomData = roomDoc.data();
                const roomId = roomDoc.id;
                const membersRef = collection(doc(roomsRef, roomId), 'members');

                // Check for empty rooms and delete them proactively
                const membersSnapshot = await getDocs(membersRef);
                if (membersSnapshot.empty) {
                    await deleteRoom(roomId);
                    return; // Skip rendering this room, it's being deleted
                }

                const li = document.createElement('li');
                li.className = 'p-3 bg-gruvbox-dark-bg rounded-lg flex justify-between items-center border border-gruvbox-dark-silver';
                li.innerHTML = `
                    <span>Room: <strong>${roomData.creatorUsername}</strong> (<span id="member-count-${roomDoc.id}">0</span>/2)</span>
                    <button class="btn btn-primary join-room-btn" data-room-id="${roomDoc.id}">Join</button>
                `;
                roomsList.appendChild(li);
                // Listen for members in each room
                onSnapshot(membersRef, (membersSnapshot) => {
                    const memberCountElement = document.getElementById(`member-count-${roomDoc.id}`);
                    if (memberCountElement) {
                        memberCountElement.textContent = membersSnapshot.size;
                        const joinBtn = memberCountElement.closest('li').querySelector('.join-room-btn');
                        if (membersSnapshot.size >= 2) {
                            joinBtn.disabled = true;
                            joinBtn.textContent = 'Full';
                            joinBtn.classList.add('bg-gray-500', 'cursor-not-allowed', 'opacity-50');
                        } else {
                             joinBtn.disabled = false;
                             joinBtn.textContent = 'Join';
                             joinBtn.classList.remove('bg-gray-500', 'cursor-not-allowed', 'opacity-50');
                        }
                    }
                });
            });
        });

        onSnapshot(chatRef, (snapshot) => {
            chatMessages.innerHTML = '';
            chatCount.textContent = `(${snapshot.size})`;
            snapshot.forEach((chatDoc) => {
                const message = chatDoc.data();
                const p = document.createElement('p');
                p.className = 'mb-1 flex items-center justify-between';
                p.innerHTML = `
                    <span><strong class="text-gruvbox-dark-navy">${message.username}:</strong> ${message.text}</span>
                    ${isAdmin ? `<button class="text-gruvbox-dark-red ml-2 delete-chat-btn" data-message-id="${chatDoc.id}">x</button>` : ''}
                `;
                chatMessages.appendChild(p);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (text && userId) {
            await addDoc(collection(db, `artifacts/${appId}/public/data/chat_messages`), {
                username: username,
                text: text,
                createdAt: serverTimestamp(),
            });
            chatInput.value = '';
        }
    });

    // --- Admin Console Logic ---
    function setupAdminListeners() {
        const roomsRef = collection(db, `artifacts/${appId}/public/data/rooms`);
        onSnapshot(roomsRef, (snapshot) => {
            adminRoomsList.innerHTML = '';
            if (snapshot.empty) {
                adminRoomsList.innerHTML = '<tr><td colspan="4" class="text-center italic text-gruvbox-dark-silver py-4">No active rooms.</td></tr>';
                return;
            }
            snapshot.forEach(async (roomDoc) => {
                const roomData = roomDoc.data();
                const roomId = roomDoc.id;
                const membersRef = collection(doc(roomsRef, roomId), 'members');
                const membersSnapshot = await getDocs(membersRef);
                const memberIds = membersSnapshot.docs.map(m => m.data().userId);

                const tr = document.createElement('tr');
                tr.className = 'border-b border-gruvbox-dark-silver';
                tr.innerHTML = `
                    <td class="py-2 px-4">${roomId.substring(0, 8)}...</td>
                    <td class="py-2 px-4">${roomData.creatorUsername}</td>
                    <td class="py-2 px-4">${memberIds.length}</td>
                    <td class="py-2 px-4 flex gap-2">
                        <button class="btn btn-primary view-members-btn" data-room-id="${roomId}">View Members</button>
                        <button class="btn btn-secondary delete-room-btn" data-room-id="${roomId}">Delete Room</button>
                    </td>
                `;
                adminRoomsList.appendChild(tr);
            });
        });

        deleteAllRoomsBtn.addEventListener('click', () => {
            showCustomModal('Are you sure you want to delete ALL rooms and their data?', async () => {
                const roomsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/rooms`));
                const deletePromises = roomsSnapshot.docs.map(doc => deleteRoom(doc.id));
                await Promise.all(deletePromises);
                showCustomMessage('All rooms have been deleted.');
            });
        });
    }

    // --- WebRTC Room Logic ---
    createRoomBtn.addEventListener('click', async () => {
        await getUserMedia();
        if (!localStream) return;
        showScreen('video-room-screen');
        roomIdDisplay.textContent = 'Creating...';
        connectionStatus.textContent = 'Status: Connecting...';
        const roomRef = doc(collection(db, `artifacts/${appId}/public/data/rooms`));
        currentRoomId = roomRef.id;

        await setDoc(roomRef, { creatorId: userId, creatorUsername: username, createdAt: serverTimestamp() });
        await setDoc(doc(roomRef, `members/${userId}`), { userId, username });

        await setupPeerConnection(roomRef);

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        await setDoc(doc(roomRef, `offers/${userId}`), { sdp: offer.sdp, type: offer.type });

        onSnapshot(collection(roomRef, 'answers'), (snapshot) => {
            snapshot.docChanges().forEach(async (change) => {
                if (change.type === 'added') {
                    const answer = change.doc.data();
                    if (!peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    }
                }
            });
        });

        roomIdDisplay.textContent = currentRoomId;
        connectionStatus.textContent = 'Status: Waiting for partner...';
    });

    document.addEventListener('click', async (e) => {
        if (e.target.classList.contains('join-room-btn')) {
            const roomId = e.target.dataset.roomId;
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms/${roomId}`);
            const memberDocRef = doc(roomRef, `members/${userId}`);
            const memberDoc = await getDoc(memberDocRef);

            if (memberDoc.exists()) {
                showCustomMessage('You are already in this room.');
                return;
            }

            const membersSnapshot = await getDocs(collection(roomRef, 'members'));
            if (membersSnapshot.size >= 2) {
                showCustomMessage('This room is full. Please try another room.');
                return;
            }

            await getUserMedia();
            if (!localStream) return;

            currentRoomId = roomId;
            showScreen('video-room-screen');
            roomIdDisplay.textContent = currentRoomId;
            connectionStatus.textContent = 'Status: Connecting...';

            await setDoc(memberDocRef, { userId, username });
            await setupPeerConnection(roomRef);

            const offersRef = collection(roomRef, 'offers');
            const offersSnapshot = await getDocs(offersRef);
            if (!offersSnapshot.empty) {
                const offer = offersSnapshot.docs[0].data();
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                await setDoc(doc(roomRef, `answers/${userId}`), { sdp: answer.sdp, type: answer.type });
            }
        }
    });

    async function getUserMedia() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
            localVideo.muted = true;
        } catch (e) {
            console.error("Error getting user media:", e);
            showCustomMessage("Could not access your camera or microphone. Please check your permissions.");
        }
    }

    async function setupPeerConnection(roomRef) {
        peerConnection = new RTCPeerConnection(servers);

        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.ontrack = (event) => {
            const remoteStream = new MediaStream();
            event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
            remoteVideo.srcObject = remoteStream;
            connectionStatus.textContent = 'Status: Connected';
        };

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                const candidatesRef = collection(roomRef, 'iceCandidates');
                addDoc(candidatesRef, event.candidate.toJSON());
            }
        };

        onSnapshot(collection(roomRef, 'iceCandidates'), (snapshot) => {
            snapshot.docChanges().forEach(async (change) => {
                if (change.type === 'added') {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                }
            });
        });

        peerConnection.onconnectionstatechange = () => {
            if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed') {
                handleHangUp();
                connectionStatus.textContent = 'Status: Disconnected';
            } else if (peerConnection.connectionState === 'connected') {
                connectionStatus.textContent = 'Status: Connected';
            }
        };
    }

    hangUpBtn.addEventListener('click', () => handleHangUp());

    async function handleHangUp() {
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        if (remoteVideo.srcObject) {
            remoteVideo.srcObject.getTracks().forEach(track => track.stop());
            remoteVideo.srcObject = null;
        }
        localVideo.srcObject = null;
        remoteVideo.srcObject = null;

        if (currentRoomId) {
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms/${currentRoomId}`);
            await deleteDoc(doc(roomRef, `members/${userId}`));
            const membersSnapshot = await getDocs(collection(roomRef, 'members'));
            if (membersSnapshot.empty) {
                await deleteRoom(currentRoomId);
            }
            currentRoomId = null;
        }
        showScreen('lobby-screen');
    }

    toggleAudioBtn.addEventListener('click', () => {
        if (localStream) {
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            toggleAudioBtn.textContent = audioTrack.enabled ? 'Mute Audio' : 'Unmute Audio';
        }
    });

    toggleVideoBtn.addEventListener('click', () => {
        if (localStream) {
            const videoTrack = localStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
            toggleVideoBtn.textContent = videoTrack.enabled ? 'Hide Video' : 'Show Video';
        }
    });

    // --- Utility Functions ---
    async function deleteRoom(roomId) {
        try {
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms/${roomId}`);
            const subcollections = ['members', 'offers', 'answers', 'iceCandidates'];
            for (const sub of subcollections) {
                const subSnapshot = await getDocs(collection(roomRef, sub));
                subSnapshot.forEach(doc => deleteDoc(doc.ref));
            }
            await deleteDoc(roomRef);
        } catch (e) {
            console.error('Error deleting room:', e);
        }
    }

    function showCustomMessage(message, duration = 3000) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content text-center">
                <p class="text-xl mb-4">${message}</p>
                <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">OK</button>
            </div>
        `;
        document.body.appendChild(modal);
        if (duration > 0) {
            setTimeout(() => modal.remove(), duration);
        }
    }

    function showCustomModal(message, onConfirm) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content text-center">
                <p class="text-xl mb-4">${message}</p>
                <div class="flex justify-center gap-4">
                    <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                    <button id="confirm-btn" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('confirm-btn').addEventListener('click', () => {
            onConfirm();
            modal.remove();
        });
    }

    document.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-chat-btn')) {
            const messageId = e.target.dataset.messageId;
            showCustomModal('Are you sure you want to delete this message?', async () => {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/chat_messages/${messageId}`));
                showCustomMessage('Message deleted.');
            });
        }
        if (e.target.classList.contains('delete-room-btn')) {
            const roomId = e.target.dataset.roomId;
            showCustomModal('Are you sure you want to delete this room?', async () => {
                await deleteRoom(roomId);
                showCustomMessage('Room deleted.');
            });
        }
    });

    window.onload = initializeFirebase;
</script>

</body>
</html>
